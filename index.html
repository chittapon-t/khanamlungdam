<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ขนำลุงดำ แคมป์ปิ้ง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        .step-active { color: #065f46; border-bottom: 3px solid #065f46; font-weight: bold; }
        .room-card { border: 2px solid #f1f5f9; transition: all 0.2s ease; }
        .room-card.selected { border-color: #059669; background-color: #f0fdf4; ring: 4px; ring-color: #d1fae5; }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
        input[type="date"] { -webkit-appearance: none; }
    </style>
</head>
<body class="max-w-md mx-auto bg-white min-h-screen shadow-xl pb-32 relative">

    <!-- Header -->
    <header class="bg-emerald-900 text-white p-6 rounded-b-[2.5rem] shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold italic">ขนำลุงดำ แคมป์ปิ้ง</h1>
                <p class="text-emerald-100 text-[10px] opacity-80 uppercase tracking-wider">Riverside Camping & Homestay</p>
            </div>
            <div id="user-status" class="bg-emerald-700/50 p-2 rounded-full text-[10px]">Guest</div>
        </div>
    </header>

    <!-- Nav Steps -->
    <nav class="flex justify-around p-4 border-b bg-white z-40 shadow-sm sticky top-[88px]">
        <div id="s1" class="step-active pb-1 text-sm">1. เลือกห้อง</div>
        <div id="s2" class="text-gray-400 pb-1 text-sm">2. อาหาร</div>
        <div id="s3" class="text-gray-400 pb-1 text-sm">3. จ่ายเงิน</div>
    </nav>

    <main class="p-5">
        <!-- Step 1: Room -->
        <div id="step-1" class="space-y-5 animate-fadeIn">
            <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100 shadow-sm">
                <label class="block text-[10px] font-bold text-emerald-800 mb-2 uppercase">เลือกวันที่เข้าพัก</label>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <span class="text-[10px] text-emerald-600 ml-1">เช็คอิน</span>
                        <input type="date" id="checkin" onchange="handleDateChange('checkin')" class="w-full p-2.5 rounded-xl border ring-1 ring-emerald-200 text-sm bg-white">
                    </div>
                    <div>
                        <span class="text-[10px] text-emerald-600 ml-1">เช็คเอาท์</span>
                        <input type="date" id="checkout" onchange="handleDateChange('checkout')" class="w-full p-2.5 rounded-xl border ring-1 ring-emerald-200 text-sm bg-white">
                    </div>
                </div>
                <p id="date-alert" class="text-xs text-red-500 mt-2 hidden"></p>
            </div>
            
            <div id="room-list" class="space-y-4"></div>
        </div>

        <!-- Step 2: Food -->
        <div id="step-2" class="hidden space-y-5 animate-fadeIn">
            <div class="bg-orange-50 p-4 rounded-2xl border border-orange-100">
                <h3 class="font-bold text-orange-900 text-sm">สั่งอาหารล่วงหน้า</h3>
                <p class="text-[10px] text-orange-700">เสิร์ฟถึงหน้าห้อง/เต็นท์</p>
            </div>
            <div id="food-list" class="space-y-3"></div>
        </div>

        <!-- Step 3: Summary -->
        <div id="step-3" class="hidden space-y-6 animate-fadeIn">
            <div class="bg-white p-5 rounded-3xl border border-gray-100 shadow-lg">
                <h3 class="font-bold text-gray-800 text-lg border-b pb-2 mb-4">สรุปยอดชำระ</h3>
                
                <div id="summary-items" class="space-y-2 text-sm text-gray-600 mb-4"></div>

                <div class="space-y-2 border-t pt-3">
                    <div class="flex justify-between text-xs"><span>ค่าที่พัก</span><span id="sum-room">฿0</span></div>
                    <div class="flex justify-between text-xs text-red-500 font-bold hidden" id="sum-discount-row"><span>ส่วนลด</span><span id="sum-discount">-฿0</span></div>
                    <div class="flex justify-between text-xs"><span>ค่าอาหาร</span><span id="sum-food">฿0</span></div>
                    <div class="flex justify-between font-bold text-lg text-emerald-800 pt-2"><span>ยอดสุทธิ</span><span id="sum-net">฿0</span></div>
                </div>

                <!-- Promo -->
                <div class="pt-4 flex gap-2">
                    <input type="text" id="promo-input" placeholder="กรอกโค้ดส่วนลด" class="flex-1 p-2 border rounded-xl text-center uppercase text-sm">
                    <button onclick="applyPromo()" class="bg-gray-800 text-white px-4 rounded-xl text-xs">ใช้โค้ด</button>
                </div>
                <p id="promo-msg" class="text-[10px] mt-1 text-center h-4"></p>

                <!-- Deposit -->
                <div class="bg-emerald-50 p-3 rounded-xl mt-4 border border-emerald-200">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-emerald-800 font-bold">ยอดโอนมัดจำ (<span id="deposit-percent">50</span>%)</span>
                        <span id="sum-deposit" class="text-xl font-bold text-emerald-700">฿0</span>
                    </div>
                    <p id="special-date-alert" class="text-[10px] text-red-500 hidden mt-1 font-bold">* ช่วงเทศกาล/วันพิเศษ มัดจำ 100%</p>
                </div>
            </div>

            <!-- Payment -->
            <div class="text-center p-6 bg-white border rounded-3xl shadow-sm">
                <p class="text-[10px] text-gray-400 font-bold uppercase mb-2">สแกนจ่ายผ่าน QR Code</p>
                <img id="qr-img" src="" class="w-40 h-40 mx-auto rounded-lg border p-2">
                <p id="pp-id" class="font-bold text-lg text-emerald-800 mt-2">Loading...</p>
                <p id="pp-name" class="text-xs text-gray-500">Loading...</p>

                <div class="mt-4 pt-4 border-t border-dashed text-left">
                    <label class="block text-[10px] font-bold text-gray-500 mb-2">แนบสลิปโอนเงิน *</label>
                    <input type="file" id="slip-file" onchange="validateForm()" accept="image/*" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100"/>
                </div>
            </div>

            <div class="space-y-3">
                <input type="text" id="custName" placeholder="ชื่อผู้จอง" class="w-full p-4 rounded-2xl border bg-gray-50 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" oninput="validateForm()">
                <input type="tel" id="custTel" placeholder="เบอร์โทรศัพท์" class="w-full p-4 rounded-2xl border bg-gray-50 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" oninput="validateForm()">
            </div>
            
            <button id="btn-submit" onclick="submitBooking()" disabled class="w-full bg-emerald-800 text-white py-4 rounded-2xl font-bold shadow-lg disabled:bg-gray-300 disabled:shadow-none transition-all">ยืนยันการจอง</button>
        </div>
        
        <!-- Success -->
        <div id="step-success" class="hidden text-center py-20 animate-fadeIn">
            <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto text-4xl mb-4">✓</div>
            <h2 class="text-xl font-bold">ส่งข้อมูลเรียบร้อย!</h2>
            <p class="text-gray-500 text-sm mt-2">กรุณารอแอดมินตรวจสอบสลิป<br>และยืนยันกลับทาง LINE</p>
            <button onclick="liff.closeWindow()" class="mt-8 bg-gray-800 text-white px-8 py-3 rounded-xl text-sm">ปิดหน้าต่าง</button>
        </div>
    </main>

    <!-- Footer -->
    <footer id="footer-nav" class="fixed bottom-0 inset-x-0 bg-white border-t p-4 flex justify-between items-center max-w-md mx-auto z-50 shadow-[0_-10px_30px_rgba(0,0,0,0.05)]">
        <div class="text-xs text-gray-500">
            รวมทั้งหมด <br> <span id="footer-total" class="text-emerald-700 font-bold text-lg">฿0</span>
        </div>
        <div class="flex gap-2">
            <button id="btn-back" onclick="moveStep(-1)" class="hidden bg-gray-100 text-gray-600 px-6 py-3 rounded-xl text-sm font-bold">กลับ</button>
            <button id="btn-next" onclick="moveStep(1)" class="bg-emerald-600 text-white px-8 py-3 rounded-xl text-sm font-bold shadow-lg shadow-emerald-200">ถัดไป</button>
        </div>
    </footer>

    <script>
        // *** CONFIG URL ***
        const API = 'https://script.google.com/macros/s/AKfycbwektF_DO710_XQ4bEoVtYxgupJRreNyvKrQ8t36ILerJFnzWfnFItQkqdg1yswHpAc3g/exec';

        // *** REAL DATA (HARDCODED) ***
        const ROOM_DATA = [
            {
                id: 'HOMESTAY_01',
                name: 'โฮมสเตย์หนำโป',
                type: 'tier', // ราคาตามจำนวนคน (ช่วง)
                tiers: [
                    { min: 4, max: 5, price: 1600 },
                    { min: 6, max: 8, price: 2200 }
                ],
                minPax: 4, maxPax: 8,
                desc: 'บ้านพักหลังใหญ่ริมน้ำ'
            },
            {
                id: 'RIVER_01',
                name: 'บ้านพักริมน้ำ 1',
                type: 'tier',
                tiers: [
                    { min: 1, max: 2, price: 1400 },
                    { min: 3, max: 3, price: 1750 }
                ],
                minPax: 1, maxPax: 3,
                desc: 'ฟรีอาหารเช้า'
            },
            {
                id: 'RIVER_02',
                name: 'บ้านพักริมน้ำ 2',
                type: 'tier',
                tiers: [
                    { min: 1, max: 2, price: 1400 },
                    { min: 3, max: 3, price: 1750 }
                ],
                minPax: 1, maxPax: 3,
                desc: 'ฟรีอาหารเช้า'
            },
            {
                id: 'TENT_01',
                name: 'เต็นท์กระโจม 1',
                type: 'tier',
                tiers: [
                    { min: 1, max: 2, price: 1200 },
                    { min: 3, max: 4, price: 1550 }
                ],
                minPax: 1, maxPax: 4,
                desc: 'ฟรีอาหารเช้า'
            },
            {
                id: 'TENT_02',
                name: 'เต็นท์กระโจม 2',
                type: 'tier',
                tiers: [
                    { min: 1, max: 2, price: 1200 },
                    { min: 3, max: 4, price: 1550 }
                ],
                minPax: 1, maxPax: 4,
                desc: 'ฟรีอาหารเช้า'
            },
            {
                id: 'FIELD_K1',
                name: 'เช่าเต็นท์สนาม K1',
                type: 'tier',
                tiers: [
                    { min: 1, max: 2, price: 700 }
                ],
                minPax: 1, maxPax: 2,
                desc: 'ฟรีอาหารเช้า'
            },
            {
                id: 'FIELD_K2',
                name: 'เช่าเต็นท์สนาม K2',
                type: 'tier',
                tiers: [
                    { min: 1, max: 2, price: 700 }
                ],
                minPax: 1, maxPax: 2,
                desc: 'ฟรีอาหารเช้า'
            },
            {
                id: 'CAMPING_GROUND',
                name: 'ลานกางเต็นท์',
                type: 'per_head', // ราคาต่อหัว
                pricePerHead: 150,
                minPax: 1, maxPax: 20,
                desc: 'นำเต็นท์มาเอง (สูงสุด 20 คน)'
            }
        ];

        const FOOD_DATA = [
            { id: 'F01', name: 'ชุดหมูกระทะลุงดำ', price: 390 },
            { id: 'F02', name: 'ชุดไก่กระทะลุงดำ', price: 390 },
            { id: 'F03', name: 'ชุดชาบูหมูลุงดำ', price: 390 },
            { id: 'F04', name: 'ชุดชาบูไก่ลุงดำ', price: 390 },
            { id: 'F05', name: 'เซ็ตอาหารพื้นบ้าน', price: 390 }
        ];

        let state = {
            step: 1,
            config: {},
            promos: [],
            selection: { room: null, foods: [], checkin: '', checkout: '', days: 1, pax: 1 },
            user: { lineId: '', name: '' }
        };

        // Init
        async function init() {
            try {
                await liff.init({ liffId: "2008863563-tuai5kaC" });
                if(liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    state.user.lineId = profile.userId;
                    state.user.name = profile.displayName;
                    document.getElementById('user-status').innerText = `Hi, ${profile.displayName}`;
                }
            } catch(e) {}

            try {
                const res = await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'getInitialData' }) });
                const data = await res.json();
                state.config = data.config;
                
                setupDates();
                renderRooms(); // Render from hardcoded data
                renderFoods(); // Render from hardcoded data
                
                const ppId = state.config.settings['PromptPayID'] || '000-000-0000';
                document.getElementById('pp-id').innerText = ppId;
                document.getElementById('pp-name').innerText = state.config.settings['AccountName'] || '-';
                document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${ppId}`;
                
            } catch(e) { console.error(e); }
        }
        window.onload = init;

        function setupDates() {
            const today = new Date();
            today.setDate(today.getDate() + 1);
            const tmr = today.toISOString().split('T')[0];
            
            document.getElementById('checkin').min = tmr;
            document.getElementById('checkin').value = tmr;
            
            const next = new Date(today);
            next.setDate(next.getDate() + 1);
            document.getElementById('checkout').min = next.toISOString().split('T')[0];
            document.getElementById('checkout').value = next.toISOString().split('T')[0];
            
            handleDateChange('checkin');
        }

        function handleDateChange(type) {
            const ci = document.getElementById('checkin');
            const co = document.getElementById('checkout');
            const alertBox = document.getElementById('date-alert');
            alertBox.classList.add('hidden');

            if(state.config.closedDates && state.config.closedDates.includes(ci.value)) {
                alertBox.innerText = `ขออภัย วันที่ ${ci.value} ปิดให้บริการ`;
                alertBox.classList.remove('hidden');
                ci.value = ''; 
                return;
            }

            if (type === 'checkin') {
                const d = new Date(ci.value);
                d.setDate(d.getDate() + 1);
                co.min = d.toISOString().split('T')[0];
                if(co.value <= ci.value) co.value = co.min;
            }

            const d1 = new Date(ci.value);
            const d2 = new Date(co.value);
            state.selection.days = Math.max(1, (d2 - d1) / (1000 * 3600 * 24));
            state.selection.checkin = ci.value;
            state.selection.checkout = co.value;
            
            calcTotal();
        }

        // *** Render Rooms Logic ***
        function renderRooms() {
            const html = ROOM_DATA.map(r => {
                const isSelected = state.selection.room?.id === r.id;
                // Default display price (min price)
                let displayPrice = 0;
                if(r.type === 'tier') displayPrice = r.tiers[0].price;
                else if(r.type === 'per_head') displayPrice = r.pricePerHead;

                // Determine current pax
                let currentPax = isSelected ? state.selection.pax : r.minPax;

                return `
                <div onclick="selectRoom('${r.id}')" id="room-${r.id}" class="room-card relative bg-white p-4 rounded-2xl cursor-pointer mb-3 ${isSelected ? 'selected' : ''}">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-gray-800">${r.name}</div>
                            <div class="text-[10px] text-gray-400">${r.desc}</div>
                            <div class="text-[10px] mt-1 bg-gray-100 inline-block px-2 py-1 rounded text-gray-500">
                                พักได้ ${r.minPax}-${r.maxPax} ท่าน
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-emerald-700 font-bold text-lg">฿${displayPrice.toLocaleString()}</div>
                            <div class="text-[9px] text-gray-400 uppercase">
                                ${r.type === 'per_head' ? 'ราคา/ท่าน' : 'เริ่มต้น'}
                            </div>
                        </div>
                    </div>
                    
                    ${isSelected ? `
                    <div class="mt-4 pt-3 border-t border-emerald-100 animate-fadeIn" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center bg-emerald-50 p-2 rounded-xl">
                            <span class="text-xs font-bold text-emerald-800 ml-2">จำนวนผู้เข้าพัก:</span>
                            <div class="flex items-center gap-3 bg-white p-1 rounded-lg border border-emerald-200">
                                <button onclick="updatePax('${r.id}', -1)" class="w-7 h-7 flex items-center justify-center rounded bg-gray-100 hover:bg-emerald-100 font-bold text-gray-600">-</button>
                                <span class="w-6 text-center font-bold text-sm text-emerald-700">${currentPax}</span>
                                <button onclick="updatePax('${r.id}', 1)" class="w-7 h-7 flex items-center justify-center rounded bg-gray-100 hover:bg-emerald-100 font-bold text-emerald-700">+</button>
                            </div>
                        </div>
                        <p class="text-[10px] text-emerald-600 text-right mt-1 font-medium" id="room-price-display">
                            ราคาปัจจุบัน: ฿${calculateRoomPrice(r, currentPax).toLocaleString()}
                        </p>
                    </div>
                    <div class="absolute -top-2 -right-2 bg-emerald-600 text-white w-6 h-6 rounded-full flex items-center justify-center shadow">✓</div>
                    ` : ''}
                </div>
            `;
            }).join('');
            document.getElementById('room-list').innerHTML = html;
        }

        function selectRoom(rid) {
            const room = ROOM_DATA.find(r => r.id === rid);
            // Default select minPax
            state.selection.room = room;
            state.selection.pax = room.minPax;
            renderRooms();
            calcTotal();
        }

        function updatePax(rid, delta) {
            if(state.selection.room?.id !== rid) return;
            const room = state.selection.room;
            
            let newPax = state.selection.pax + delta;
            if (newPax < room.minPax) newPax = room.minPax;
            if (newPax > room.maxPax) newPax = room.maxPax;
            
            state.selection.pax = newPax;
            renderRooms(); // Re-render to update number
            calcTotal();
        }

        function calculateRoomPrice(room, pax) {
            if (room.type === 'per_head') {
                return room.pricePerHead * pax;
            } else if (room.type === 'tier') {
                const tier = room.tiers.find(t => pax >= t.min && pax <= t.max);
                return tier ? tier.price : 0;
            }
            return 0;
        }

        function renderFoods() {
            const html = FOOD_DATA.map(f => `
                <div class="flex justify-between items-center bg-white p-3 rounded-xl border">
                    <div class="text-sm">
                        <div class="font-bold text-gray-800">${f.name}</div>
                        <div class="text-xs text-emerald-600 font-bold">฿${f.price}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateFood('${f.id}', -1)" class="w-6 h-6 bg-gray-100 rounded text-gray-600 hover:bg-gray-200">-</button>
                        <span id="qty-${f.id}" class="text-sm w-4 text-center">0</span>
                        <button onclick="updateFood('${f.id}', 1)" class="w-6 h-6 bg-emerald-100 text-emerald-700 rounded hover:bg-emerald-200">+</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('food-list').innerHTML = html;
        }

        function updateFood(fid, delta) {
            const fIndex = state.selection.foods.findIndex(x => x.id === fid);
            const food = FOOD_DATA.find(x => x.id === fid);
            
            if(fIndex === -1 && delta > 0) state.selection.foods.push({ ...food, qty: 1 });
            else if(fIndex > -1) {
                state.selection.foods[fIndex].qty += delta;
                if(state.selection.foods[fIndex].qty <= 0) state.selection.foods.splice(fIndex, 1);
            }
            
            const currQty = state.selection.foods.find(x => x.id === fid)?.qty || 0;
            document.getElementById(`qty-${fid}`).innerText = currQty;
            calcTotal();
        }

        function applyPromo() {
            const code = document.getElementById('promo-input').value.toUpperCase();
            const promo = state.config.promos.find(p => p.code === code);
            const msg = document.getElementById('promo-msg');
            
            if(promo) {
                state.selection.promo = promo;
                msg.innerText = `ใช้โค้ด ${code} สำเร็จ!`;
                msg.className = "text-[10px] mt-1 text-center h-4 text-emerald-600 font-bold";
            } else {
                state.selection.promo = null;
                msg.innerText = "ไม่พบโค้ดส่วนลด";
                msg.className = "text-[10px] mt-1 text-center h-4 text-red-500";
            }
            calcTotal();
        }

        function calcTotal() {
            if(!state.selection.room) return;

            // 1. Calculate Room Price (Per Night)
            const pricePerNight = calculateRoomPrice(state.selection.room, state.selection.pax);
            const roomTotal = pricePerNight * state.selection.days;

            // 2. Food Total
            const foodTotal = state.selection.foods.reduce((a, b) => a + (b.price * b.qty), 0);
            
            // 3. Discount
            let discount = 0;
            if(state.selection.promo) {
                const detail = state.selection.promo.detail; // e.g. "100:Baht" or "10:%"
                const [val, type] = detail.split(':');
                if(type === '%') discount = roomTotal * (parseFloat(val)/100);
                else discount = parseFloat(val);
            }

            const netTotal = Math.max(0, roomTotal - discount) + foodTotal;
            
            // 4. Deposit Logic
            let isSpecial = state.config.specialDates && state.config.specialDates.includes(state.selection.checkin);
            let depositRate = isSpecial ? 1.0 : parseFloat(state.config.settings['DepositRate'] || 0.5);
            let deposit = netTotal * depositRate;

            // UI Updates
            document.getElementById('footer-total').innerText = `฿${netTotal.toLocaleString()}`;
            document.getElementById('sum-room').innerText = `฿${roomTotal.toLocaleString()}`;
            document.getElementById('sum-food').innerText = `฿${foodTotal.toLocaleString()}`;
            document.getElementById('sum-net').innerText = `฿${netTotal.toLocaleString()}`;
            document.getElementById('sum-deposit').innerText = `฿${Math.ceil(deposit).toLocaleString()}`;
            document.getElementById('deposit-percent').innerText = depositRate * 100;
            
            if(discount > 0) {
                document.getElementById('sum-discount-row').classList.remove('hidden');
                document.getElementById('sum-discount').innerText = `-฿${discount.toLocaleString()}`;
            } else {
                document.getElementById('sum-discount-row').classList.add('hidden');
            }

            if(isSpecial) document.getElementById('special-date-alert').classList.remove('hidden');
            else document.getElementById('special-date-alert').classList.add('hidden');
            
            renderSummaryHTML();
            
            state.calc = { total: netTotal + discount, net: netTotal, deposit: Math.ceil(deposit) };
        }

        function renderSummaryHTML() {
            let html = `
                <div class="flex justify-between items-start">
                    <div>
                        <b class="text-gray-800">${state.selection.room.name}</b>
                        <div class="text-[10px] text-gray-400">เข้าพัก ${state.selection.pax} ท่าน (${state.selection.days} คืน)</div>
                    </div>
                </div>`;
            
            if(state.selection.foods.length > 0) {
                html += `<div class="mt-2 border-t pt-2 border-dashed">`;
                state.selection.foods.forEach(f => {
                    html += `<div class="flex justify-between text-xs text-gray-500"><span>+ ${f.name} x${f.qty}</span><span>฿${f.price * f.qty}</span></div>`;
                });
                html += `</div>`;
            }
            document.getElementById('summary-items').innerHTML = html;
        }

        function moveStep(delta) {
            if(delta === 1 && state.step === 1 && !state.selection.room) return alert('กรุณาเลือกห้องพัก');
            
            document.getElementById(`step-${state.step}`).classList.add('hidden');
            document.getElementById(`s${state.step}`).classList.remove('step-active');
            
            state.step += delta;
            
            document.getElementById(`step-${state.step}`).classList.remove('hidden');
            document.getElementById(`s${state.step}`).classList.add('step-active');
            
            const btnBack = document.getElementById('btn-back');
            const btnNext = document.getElementById('btn-next');
            const nav = document.getElementById('footer-nav');

            if(state.step === 1) btnBack.classList.add('hidden');
            else btnBack.classList.remove('hidden');

            if(state.step === 3) {
                btnNext.classList.add('hidden');
                nav.classList.add('hidden'); // Hide footer in Step 3
                document.getElementById('step-3').classList.remove('hidden');
            } else {
                btnNext.classList.remove('hidden');
                nav.classList.remove('hidden');
            }
        }

        function validateForm() {
            const name = document.getElementById('custName').value;
            const tel = document.getElementById('custTel').value;
            const file = document.getElementById('slip-file').files.length > 0;
            document.getElementById('btn-submit').disabled = !(name && tel && file);
        }

        async function submitBooking() {
            const btn = document.getElementById('btn-submit');
            btn.disabled = true; btn.innerText = "กำลังส่งข้อมูล...";

            const file = document.getElementById('slip-file').files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const payload = {
                    action: 'submitBooking',
                    lineId: state.user.lineId || 'web',
                    lineName: state.user.name || 'guest',
                    custName: document.getElementById('custName').value,
                    custTel: document.getElementById('custTel').value,
                    roomId: state.selection.room.id,
                    roomName: state.selection.room.name,
                    pax: state.selection.pax, // Send Pax
                    foods: state.selection.foods,
                    promoCode: state.selection.promo?.code,
                    totalPrice: state.calc.total,
                    netPrice: state.calc.net,
                    deposit: state.calc.deposit,
                    checkin: state.selection.checkin,
                    checkout: state.selection.checkout,
                    slipBase64: reader.result
                };

                try {
                    await fetch(API, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' });
                    document.getElementById('step-3').classList.add('hidden');
                    document.getElementById('step-success').classList.remove('hidden');
                } catch(e) {
                    alert('เกิดข้อผิดพลาด กรุณาลองใหม่');
                    btn.disabled = false;
                }
            };
        }
    </script>
</body>
</html>
