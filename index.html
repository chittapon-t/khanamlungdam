<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>จองที่พัก - ขนำลุงดำ แคมป์ปิ้ง</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
        .step-content { display: none; }
        .step-content.active { display: block; }
        .loader { border-top-color: #059669; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 pb-24">

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white/90 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
        <div class="flex flex-col items-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-100 h-12 w-12 mb-4"></div>
            <p id="loadingText" class="font-bold text-stone-600 text-sm">กำลังเตรียมเต็นท์...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-green-900 text-white p-5 shadow-md sticky top-0 z-40 rounded-b-3xl">
        <div class="flex items-center gap-3">
            <img id="userThumb" src="" class="w-10 h-10 rounded-full border-2 border-white/20 bg-green-800">
            <div>
                <h1 class="text-lg font-bold text-white">ขนำลุงดำ แคมป์ปิ้ง</h1>
                <p id="userName" class="text-[10px] text-green-200 uppercase tracking-wider">ยินดีต้อนรับ</p>
            </div>
        </div>
    </header>

    <!-- Progress Indicator -->
    <div class="max-w-md mx-auto px-8 py-6">
        <div class="flex justify-between items-center relative">
            <div class="w-full absolute top-1/2 left-0 h-0.5 bg-gray-200 -z-10"></div>
            <div id="dot-1" class="w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center text-xs font-bold transition-all">1</div>
            <div id="dot-2" class="w-8 h-8 rounded-full bg-gray-200 text-gray-400 flex items-center justify-center text-xs font-bold transition-all">2</div>
            <div id="dot-3" class="w-8 h-8 rounded-full bg-gray-200 text-gray-400 flex items-center justify-center text-xs font-bold transition-all">3</div>
        </div>
        <div class="flex justify-between mt-2 text-[10px] font-bold text-gray-400 uppercase tracking-tighter">
            <span>ที่พัก</span>
            <span class="ml-2">อาหาร</span>
            <span>ยืนยัน</span>
        </div>
    </div>

    <main class="max-w-md mx-auto px-4">

        <!-- STEP 1: DATE & ROOMS -->
        <div id="step-1" class="step-content active space-y-4">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-bold text-stone-800 mb-4 flex items-center gap-2">
                    <span class="w-6 h-6 bg-green-100 text-green-700 rounded-lg flex items-center justify-center text-sm">1</span>
                    เลือกวันที่เข้าพัก
                </h2>
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">เช็คอิน (เริ่มต้นพรุ่งนี้)</label>
                        <input type="date" id="checkInDate" onchange="onDateChange()" class="w-full bg-stone-50 border-none rounded-xl p-3 text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">เช็คเอาท์</label>
                        <input type="date" id="checkOutDate" onchange="calculateTotal()" class="w-full bg-stone-50 border-none rounded-xl p-3 text-sm focus:ring-2 focus:ring-green-500">
                    </div>
                </div>
            </div>

            <div id="roomSection" class="space-y-3 opacity-40 pointer-events-none transition-opacity duration-500">
                <h2 class="text-lg font-bold text-stone-800 px-1">เลือกประเภทห้องพัก</h2>
                <div id="roomContainer" class="grid gap-3">
                    <!-- Room Cards -->
                </div>
            </div>
            
            <button onclick="navStep(2)" id="btnStep1" class="w-full bg-green-700 text-white py-4 rounded-2xl font-bold shadow-lg shadow-green-200 active:scale-95 transition-all mt-4">ไปเลือกเมนูอาหาร</button>
        </div>

        <!-- STEP 2: FOOD SELECTION -->
        <div id="step-2" class="step-content space-y-4">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-bold text-stone-800 mb-1 flex items-center gap-2">
                    <span class="w-6 h-6 bg-green-100 text-green-700 rounded-lg flex items-center justify-center text-sm">2</span>
                    สั่งอาหารล่วงหน้า
                </h2>
                <p class="text-xs text-gray-400 mb-4 ml-8">อาหารเย็นพร้อมเสิร์ฟเวลา 18:00 น.</p>
                <div id="foodContainer" class="space-y-4">
                    <!-- Food Items -->
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="navStep(1)" class="w-1/3 bg-white text-gray-400 py-4 rounded-2xl font-bold border border-gray-100">กลับ</button>
                <button onclick="navStep(3)" class="w-2/3 bg-green-700 text-white py-4 rounded-2xl font-bold shadow-lg shadow-green-200 active:scale-95 transition-all">สรุปยอดจอง</button>
            </div>
        </div>

        <!-- STEP 3: SUMMARY & PAYMENT -->
        <div id="step-3" class="step-content space-y-4">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-bold text-stone-800 mb-4 flex items-center gap-2">
                    <span class="w-6 h-6 bg-green-100 text-green-700 rounded-lg flex items-center justify-center text-sm">3</span>
                    ข้อมูลการติดต่อ
                </h2>
                <div class="space-y-3">
                    <input type="text" id="bookerName" placeholder="ชื่อผู้จอง" class="w-full bg-stone-50 border-none rounded-xl p-4 text-sm focus:ring-2 focus:ring-green-500">
                    <input type="tel" id="bookerPhone" placeholder="เบอร์โทรศัพท์" class="w-full bg-stone-50 border-none rounded-xl p-4 text-sm focus:ring-2 focus:ring-green-500">
                </div>
            </div>

            <div class="bg-stone-900 text-white p-6 rounded-3xl shadow-xl overflow-hidden relative">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z"/></svg>
                </div>
                <h3 class="font-bold mb-4 border-b border-white/10 pb-2 text-sm uppercase tracking-widest text-green-400">สรุปรายการจอง</h3>
                <div class="space-y-2 text-sm" id="summaryList"></div>
                
                <div class="mt-6 pt-4 border-t border-dashed border-white/20 flex justify-between items-end">
                    <div>
                        <p class="text-[10px] text-gray-400 uppercase font-bold">ยอดรวม</p>
                        <p id="txtTotal" class="text-xl font-bold">0 ฿</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-green-400 uppercase font-bold">มัดจำที่ต้องโอน (50%)</p>
                        <p id="txtDeposit" class="text-2xl font-bold text-green-400">0 ฿</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 text-center">
                <p class="text-[10px] font-bold text-gray-400 mb-4 uppercase tracking-widest">พร้อมเพย์ 061-592-4262</p>
                <img id="qrImg" src="" class="w-48 mx-auto rounded-2xl mb-2 p-2 bg-white border border-gray-50 shadow-inner">
                <p class="text-[10px] text-gray-400 mb-6 font-bold uppercase italic">Scan to Pay via PromptPay</p>
                
                <div class="text-left bg-stone-50 p-4 rounded-2xl">
                    <label class="block text-xs font-bold text-stone-600 mb-2">อัปโหลดหลักฐานการโอน</label>
                    <input type="file" id="slipInput" accept="image/*" class="text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-green-100 file:text-green-700">
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="navStep(2)" class="w-1/3 bg-white text-gray-400 py-4 rounded-2xl font-bold border border-gray-100">กลับ</button>
                <button onclick="submitBooking()" class="w-2/3 bg-green-700 text-white py-4 rounded-2xl font-bold shadow-lg shadow-green-200 active:scale-95 transition-all">ยืนยันการส่งข้อมูล</button>
            </div>
        </div>

    </main>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwb9VWt0rQYJ2dJa9jQKM23YRKsx-YReKnqJTiqGRbg26jEMtPP-RzxDbe_BahxUiSu5g/exec';
        const LIFF_ID = '2008863563-tuai5kaC';

        const roomsData = [
            { id: 'R1', name: 'โฮมสเตย์หนำโป', rules: [{max:5, p:1600}, {max:8, p:2200}], desc: 'พักได้ 4-8 ท่าน' },
            { id: 'R2', name: 'บ้านพักริมน้ำ 1', rules: [{max:2, p:1400}, {max:3, p:1750}], desc: 'พักได้ 2-3 ท่าน' },
            { id: 'R3', name: 'บ้านพักริมน้ำ 2', rules: [{max:2, p:1400}, {max:3, p:1750}], desc: 'พักได้ 2-3 ท่าน' },
            { id: 'R4', name: 'เต็นท์กระโจม 1', rules: [{max:2, p:1200}, {max:4, p:1550}], desc: 'พักได้ 2-4 ท่าน' },
            { id: 'R5', name: 'เต็นท์กระโจม 2', rules: [{max:2, p:1200}, {max:4, p:1550}], desc: 'พักได้ 2-4 ท่าน' },
            { id: 'K1', name: 'เช่าเต็นท์สนาม K1', rules: [{max:2, p:700}], desc: 'พักได้ 2 ท่าน' },
            { id: 'K2', name: 'เช่าเต็นท์สนาม K2', rules: [{max:2, p:700}], desc: 'พักได้ 2 ท่าน' },
            { id: 'CAMP', name: 'ลานกางเต็นท์', pPerHead: 150, desc: 'นำเต็นท์มาเอง' }
        ];

        const foodData = [
            { id: 'F1', name: 'ชุดหมูกระทะลุงดำ', price: 390 },
            { id: 'F2', name: 'ชุดไก่กระทะลุงดำ', price: 390 },
            { id: 'F3', name: 'ชุดชาบูหมูลุงดำ', price: 390 },
            { id: 'F4', name: 'ชุดชาบูไก่ลุงดำ', price: 390 },
            { id: 'F5', name: 'เซ็ตอาหารพื้นบ้าน', price: 390 }
        ];

        let state = {
            profile: null,
            bookings: [],
            selectedRooms: {}, // {id: pax}
            selectedFood: {}, // {id: qty}
            step: 1
        };

        async function init() {
            showLoading(true, 'กำลังโหลดข้อมูล...');
            try {
                await liff.init({ liffId: LIFF_ID });
                if(liff.isLoggedIn()) {
                    state.profile = await liff.getProfile();
                    document.getElementById('userThumb').src = state.profile.pictureUrl;
                    document.getElementById('userName').innerText = state.profile.displayName;
                } else { liff.login(); }
                
                await fetchLatestBookings();
                setupDateInputs();
                renderFood();
                showLoading(false);
            } catch(e) { showLoading(false); }
        }

        async function fetchLatestBookings() {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'get_initial_data' }) });
            const json = await res.json();
            if(json.status === 'success') state.bookings = json.data.bookings || [];
        }

        function setupDateInputs() {
            // คำนวณวันพรุ่งนี้
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];

            const inInp = document.getElementById('checkInDate');
            const outInp = document.getElementById('checkOutDate');

            // ตั้งค่า Check-in ให้เริ่มต้นที่วันพรุ่งนี้
            inInp.min = tomorrowStr;
            inInp.value = tomorrowStr;
            
            // ตั้งค่า Check-out ให้เป็นวันถัดไปจากเช็คอิน
            const dayAfterTomorrow = new Date(tomorrow);
            dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 1);
            const dayAfterTomorrowStr = dayAfterTomorrow.toISOString().split('T')[0];

            outInp.min = dayAfterTomorrowStr;
            outInp.value = dayAfterTomorrowStr;

            onDateChange();
        }

        function onDateChange() {
            const dateStr = document.getElementById('checkInDate').value;
            if(!dateStr) return;
            
            // อัปเดตวันเช็คเอาท์ขั้นต่ำตามวันเช็คอินที่เลือก
            const cinDate = new Date(dateStr);
            const coutDate = new Date(cinDate);
            coutDate.setDate(coutDate.getDate() + 1);
            const coutMinStr = coutDate.toISOString().split('T')[0];
            
            const outInp = document.getElementById('checkOutDate');
            outInp.min = coutMinStr;
            if(new Date(outInp.value) <= cinDate) {
                outInp.value = coutMinStr;
            }

            const section = document.getElementById('roomSection');
            section.style.opacity = '1';
            section.style.pointerEvents = 'auto';
            
            renderRooms(dateStr);
            calculateTotal();
        }

        function renderRooms(targetDate) {
            const container = document.getElementById('roomContainer');
            // กรองการจองตามวันที่เลือก และสถานะที่ไม่ใช่ Cancelled
            const bookedNames = state.bookings
                .filter(b => b.date === targetDate && b.status !== 'Cancelled')
                .map(b => b.room);

            container.innerHTML = roomsData.map(r => {
                const isBooked = bookedNames.includes(r.name);
                const currentPax = state.selectedRooms[r.id] || 0;
                
                return `
                    <div class="bg-white p-4 rounded-3xl shadow-sm border transition-all ${isBooked ? 'opacity-40 bg-stone-50 border-gray-100' : 'border-gray-100 hover:border-green-300'}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-stone-800 text-sm">${r.name}</h3>
                                <p class="text-[10px] text-gray-400">${r.desc}</p>
                            </div>
                            ${isBooked ? '<span class="text-[9px] bg-red-50 text-red-500 px-2 py-0.5 rounded-full font-bold">เต็มแล้ว</span>' : ''}
                        </div>
                        <div class="flex justify-between items-center mt-4">
                            <span class="text-green-700 font-bold text-xs">${r.id === 'CAMP' ? r.pPerHead + ' ฿/ท่าน' : 'เริ่มต้น ' + r.rules[0].p + ' ฿'}</span>
                            <div class="flex items-center gap-3">
                                ${!isBooked ? `
                                    <button onclick="updateRoomPax('${r.id}', -1)" class="w-7 h-7 rounded-lg bg-stone-100 flex items-center justify-center font-bold text-gray-500">-</button>
                                    <span class="text-sm font-bold w-4 text-center">${currentPax}</span>
                                    <button onclick="updateRoomPax('${r.id}', 1)" class="w-7 h-7 rounded-lg bg-green-100 text-green-700 flex items-center justify-center font-bold">+</button>
                                ` : '<div class="h-7 text-[10px] text-gray-400 italic flex items-center font-bold">ไม่สามารถเลือกได้</div>'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateRoomPax(id, delta) {
            let val = (state.selectedRooms[id] || 0) + delta;
            if(val < 0) val = 0;
            if(val > 10) val = 10;
            if(val === 0) delete state.selectedRooms[id];
            else state.selectedRooms[id] = val;
            renderRooms(document.getElementById('checkInDate').value);
        }

        function renderFood() {
            const container = document.getElementById('foodContainer');
            container.innerHTML = foodData.map(f => `
                <div class="flex justify-between items-center bg-stone-50 p-4 rounded-2xl">
                    <div>
                        <p class="font-bold text-sm text-stone-800">${f.name}</p>
                        <p class="text-xs text-green-700 font-bold">${f.price} ฿</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="updateFoodQty('${f.id}', -1)" class="w-8 h-8 rounded-xl bg-white flex items-center justify-center shadow-sm">-</button>
                        <span id="food-qty-${f.id}" class="text-sm font-bold w-4 text-center">0</span>
                        <button onclick="updateFoodQty('${f.id}', 1)" class="w-8 h-8 rounded-xl bg-green-700 text-white flex items-center justify-center shadow-md shadow-green-100">+</button>
                    </div>
                </div>
            `).join('');
        }

        function updateFoodQty(id, delta) {
            let val = (state.selectedFood[id] || 0) + delta;
            if(val < 0) val = 0;
            state.selectedFood[id] = val;
            document.getElementById(`food-qty-${id}`).innerText = val;
        }

        function navStep(s) {
            if(s === 2 && Object.keys(state.selectedRooms).length === 0) {
                return Swal.fire('แจ้งเตือน', 'กรุณาเลือกที่พักอย่างน้อย 1 รายการ', 'info');
            }
            
            if(s === 3) calculateTotal();

            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${s}`).classList.add('active');
            
            for(let i=1; i<=3; i++) {
                const dot = document.getElementById(`dot-${i}`);
                if(i <= s) {
                    dot.classList.replace('bg-gray-200', 'bg-green-600');
                    dot.classList.replace('text-gray-400', 'text-white');
                } else {
                    dot.classList.replace('bg-green-600', 'bg-gray-200');
                    dot.classList.replace('text-white', 'text-gray-400');
                }
            }
            window.scrollTo(0, 0);
            state.step = s;
        }

        function calculateTotal() {
            const summary = document.getElementById('summaryList');
            let roomSum = 0;
            let foodSum = 0;
            let html = '';

            // Calc Rooms
            for(const [id, pax] of Object.entries(state.selectedRooms)) {
                const r = roomsData.find(x => x.id === id);
                let p = 0;
                if(r.id === 'CAMP') p = r.pPerHead * pax;
                else {
                    const rule = r.rules.find(rule => pax <= rule.max) || r.rules[r.rules.length - 1];
                    p = rule.p;
                }
                roomSum += p;
                html += `<div class="flex justify-between items-center py-1 text-stone-700"><span>${r.name} (${pax} ท่าน)</span><span class="font-bold">${p.toLocaleString()} ฿</span></div>`;
            }

            // Calc Food
            for(const [id, qty] of Object.entries(state.selectedFood)) {
                if(qty === 0) continue;
                const f = foodData.find(x => x.id === id);
                const p = f.price * qty;
                foodSum += p;
                html += `<div class="flex justify-between items-center py-1 text-gray-400"><span>${f.name} x${qty}</span><span>${p.toLocaleString()} ฿</span></div>`;
            }

            const total = roomSum + foodSum;
            const deposit = total * 0.5;

            summary.innerHTML = html || '<p class="text-xs text-center text-white/50 py-4">ยังไม่ได้เลือกรายการ</p>';
            document.getElementById('txtTotal').innerText = `${total.toLocaleString()} ฿`;
            document.getElementById('txtDeposit').innerText = `${deposit.toLocaleString()} ฿`;
            document.getElementById('qrImg').src = `https://promptpay.io/0615924262/${deposit}`;
        }

        async function submitBooking() {
            const name = document.getElementById('bookerName').value;
            const phone = document.getElementById('bookerPhone').value;
            const slip = document.getElementById('slipInput').files[0];

            if(!name || !phone || !slip) return Swal.fire('ข้อมูลไม่ครบ', 'กรุณากรอกชื่อ เบอร์โทร และแนบสลิปโอนเงิน', 'warning');

            showLoading(true, 'กำลังบันทึกข้อมูลการจอง...');
            
            const reader = new FileReader();
            reader.readAsDataURL(slip);
            reader.onload = async function() {
                const payload = {
                    action: 'create_booking',
                    payload: {
                        lineUserId: state.profile.userId,
                        lineName: state.profile.displayName,
                        bookerName: name,
                        phone: phone,
                        roomIds: Object.keys(state.selectedRooms).join(','),
                        roomNames: Object.keys(state.selectedRooms).map(id => roomsData.find(r=>r.id===id).name).join(','),
                        totalPax: Object.values(state.selectedRooms).reduce((a,b)=>a+b, 0),
                        foodIds: Object.keys(state.selectedFood).join(','),
                        foodNames: Object.keys(state.selectedFood).map(id => foodData.find(f=>f.id===id).name).join(','),
                        foodQty: Object.values(state.selectedFood).join(','),
                        grandTotal: document.getElementById('txtTotal').innerText.replace(/\D/g,''),
                        deposit: document.getElementById('txtDeposit').innerText.replace(/\D/g,''),
                        checkIn: document.getElementById('checkInDate').value,
                        checkOut: document.getElementById('checkOutDate').value,
                        slipImage: reader.result
                    }
                };

                try {
                    const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    const json = await res.json();
                    if(json.status === 'success') {
                        Swal.fire({
                            title: 'จองสำเร็จ!',
                            text: 'แอดมินจะรีบตรวจสอบสลิปและแจ้งผลให้ทราบผ่าน LINE ครับ',
                            icon: 'success'
                        }).then(() => liff.closeWindow());
                    } else {
                        throw new Error(json.message);
                    }
                } catch(e) {
                    Swal.fire('เกิดข้อผิดพลาด', e.message, 'error');
                }
                showLoading(false);
            };
        }

        function showLoading(show, text = 'กำลังโหลด...') {
            const el = document.getElementById('loading');
            if(show) {
                document.getElementById('loadingText').innerText = text;
                el.classList.remove('hidden');
            } else el.classList.add('hidden');
        }

        init();
    </script>
</body>
</html>
