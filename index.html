<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ขนำลุงดำ แคมป์ปิ้ง - ระบบจองที่พัก</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        .step-active { color: #065f46; border-bottom: 3px solid #065f46; font-weight: bold; }
        .room-card { border: 2px solid #f1f5f9; transition: all 0.2s ease; cursor: pointer; }
        .room-card.selected { border-color: #059669; background-color: #f0fdf4; }
        .food-card { border: 2px solid #f1f5f9; transition: all 0.2s ease; cursor: pointer; }
        .food-card.selected { border-color: #059669; background-color: #f0fdf4; }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="pb-24">
    <!-- Loading Overlay -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="inline-block w-12 h-12 border-4 border-emerald-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-emerald-800">กำลังเชื่อมต่อ LINE Login...</p>
        </div>
    </div>

    <!-- Header -->
    <div class="bg-emerald-800 text-white p-6 shadow-lg">
        <h1 class="text-2xl font-bold">ขนำลุงดำ แคมป์ปิ้ง</h1>
        <p class="text-emerald-100 text-sm">จองที่พักและสั่งอาหารล่วงหน้า</p>
    </div>

    <!-- User Profile Header -->
    <div id="user-info" class="bg-white p-4 flex items-center gap-3 border-b hidden">
        <img id="user-img" src="" class="w-10 h-10 rounded-full border border-emerald-200">
        <div>
            <p class="text-xs text-gray-500">ยินดีต้อนรับคุณ</p>
            <p id="user-name" class="font-semibold text-emerald-900 leading-none"></p>
        </div>
    </div>

    <!-- Step Indicator -->
    <div id="step-nav" class="bg-white flex justify-around p-3 sticky top-0 z-10 shadow-sm">
        <div id="step-btn-1" class="px-2 py-1 text-sm step-active">1. เลือกที่พัก</div>
        <div id="step-btn-2" class="px-2 py-1 text-sm text-gray-400">2. อาหาร/บริการ</div>
        <div id="step-btn-3" class="px-2 py-1 text-sm text-gray-400">3. ยืนยันการจอง</div>
    </div>

    <div class="max-w-md mx-auto p-4 space-y-6">

        <!-- STEP 1: Rooms & Dates -->
        <div id="step-1" class="animate-fadeIn space-y-6">
            <div class="bg-white p-4 rounded-xl shadow-sm space-y-4">
                <h2 class="font-bold text-emerald-900 border-l-4 border-emerald-600 pl-2">เลือกวันเข้าพัก</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Check-in</label>
                        <input type="date" id="checkin" class="w-full border p-2 rounded-lg text-sm" onchange="validateDates()">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Check-out</label>
                        <input type="date" id="checkout" class="w-full border p-2 rounded-lg text-sm" onchange="validateDates()">
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="font-bold text-emerald-900 border-l-4 border-emerald-600 pl-2">เลือกห้องพัก</h2>
                <div id="room-container" class="space-y-3">
                    <!-- Room A -->
                    <div class="room-card bg-white p-4 rounded-xl shadow-sm flex gap-4" onclick="selectRoom('R01', 'ขนำลุงดำ (A)', 1500)">
                        <div class="w-24 h-24 bg-gray-200 rounded-lg overflow-hidden flex-shrink-0">
                            <img src="https://images.unsplash.com/photo-1510798831971-661eb04b3739?w=400" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-bold">ขนำลุงดำ (A)</h3>
                            <p class="text-xs text-gray-500">พักได้สูงสุด 2 ท่าน</p>
                            <p class="text-emerald-700 font-bold mt-2">฿1,500 / คืน</p>
                        </div>
                    </div>
                    <!-- Room B -->
                    <div class="room-card bg-white p-4 rounded-xl shadow-sm flex gap-4" onclick="selectRoom('R02', 'ขนำริมน้ำ (B)', 1800)">
                        <div class="w-24 h-24 bg-gray-200 rounded-lg overflow-hidden flex-shrink-0">
                            <img src="https://images.unsplash.com/photo-1499696010180-025ef6e1a8f9?w=400" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-bold">ขนำริมน้ำ (B)</h3>
                            <p class="text-xs text-gray-500">พักได้สูงสุด 2 ท่าน</p>
                            <p class="text-emerald-700 font-bold mt-2">฿1,800 / คืน</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm">
                <label class="block text-sm font-bold mb-2">จำนวนผู้เข้าพัก</label>
                <div class="flex items-center gap-4">
                    <button onclick="updateGuests(-1)" class="w-10 h-10 border rounded-full flex items-center justify-center">-</button>
                    <span id="guest-count" class="text-xl font-bold">1</span>
                    <button onclick="updateGuests(1)" class="w-10 h-10 border rounded-full flex items-center justify-center">+</button>
                    <span class="text-sm text-gray-400">ท่าน</span>
                </div>
            </div>
        </div>

        <!-- STEP 2: Food & Discount -->
        <div id="step-2" class="hidden animate-fadeIn space-y-6">
            <h2 class="font-bold text-emerald-900 border-l-4 border-emerald-600 pl-2">เลือกเซ็ตอาหารล่วงหน้า</h2>
            <div class="grid grid-cols-2 gap-3">
                <div class="food-card bg-white p-3 rounded-xl shadow-sm text-center" onclick="selectFood('F01', 'เซ็ตหมูกระทะ VIP', 499)">
                    <img src="https://images.unsplash.com/photo-1533488765986-dfa2a9939acd?w=400" class="w-full h-24 object-cover rounded-lg mb-2">
                    <p class="text-sm font-bold">หมูกระทะ VIP</p>
                    <p class="text-xs text-emerald-600">฿499</p>
                </div>
                <div class="food-card bg-white p-3 rounded-xl shadow-sm text-center" onclick="selectFood('F02', 'เซ็ตอาหารเช้าพื้นเมือง', 150)">
                    <img src="https://images.unsplash.com/photo-1533089860892-a7c6f0a88666?w=400" class="w-full h-24 object-cover rounded-lg mb-2">
                    <p class="text-sm font-bold">เซ็ตอาหารเช้า</p>
                    <p class="text-xs text-emerald-600">฿150</p>
                </div>
            </div>
            
            <div class="bg-white p-4 rounded-xl shadow-sm">
                <label class="block text-sm font-bold mb-2 text-emerald-900">ระบุโค้ดส่วนลด</label>
                <div class="flex gap-2">
                    <input type="text" id="promo-code" class="flex-grow border p-2 rounded-lg text-sm uppercase" placeholder="ระบุโค้ด (ถ้ามี)">
                    <button onclick="applyDiscount()" class="bg-emerald-100 text-emerald-700 px-4 py-2 rounded-lg text-sm font-bold">ใช้โค้ด</button>
                </div>
                <p id="promo-msg" class="text-xs mt-1"></p>
            </div>
        </div>

        <!-- STEP 3: Confirm & Payment -->
        <div id="step-3" class="hidden animate-fadeIn space-y-6">
            <div class="bg-white p-4 rounded-xl shadow-sm space-y-3">
                <h2 class="font-bold text-emerald-900 mb-4 border-b pb-2">กรอกข้อมูลผู้ติดต่อ</h2>
                <input type="text" id="cust-name" class="w-full border p-3 rounded-lg text-sm" placeholder="ชื่อผู้จอง">
                <input type="tel" id="cust-phone" class="w-full border p-3 rounded-lg text-sm" placeholder="เบอร์โทรศัพท์ติดต่อ">
            </div>

            <div class="bg-emerald-900 text-white p-6 rounded-2xl shadow-xl space-y-4">
                <h2 class="text-center font-bold text-lg mb-4">สรุปยอดชำระ</h2>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between opacity-80">
                        <span>ค่าที่พัก (<span id="summary-room"></span>)</span>
                        <span id="price-room">฿0</span>
                    </div>
                    <div class="flex justify-between opacity-80">
                        <span>ค่าอาหาร (<span id="summary-food"></span>)</span>
                        <span id="price-food">฿0</span>
                    </div>
                    <div class="flex justify-between text-yellow-400 font-bold" id="discount-row" style="display:none;">
                        <span>ส่วนลด</span>
                        <span id="price-discount">-฿0</span>
                    </div>
                    <div class="border-t border-emerald-700 pt-2 flex justify-between text-lg font-bold">
                        <span>ยอดรวมทั้งสิ้น</span>
                        <span id="price-total">฿0</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm space-y-4 text-center">
                <h3 class="font-bold text-red-600 italic underline">ยอดโอนมัดจำ (50%)</h3>
                <p class="text-3xl font-bold text-emerald-900" id="price-deposit">฿0</p>
                <div class="bg-gray-50 p-4 rounded-lg flex flex-col items-center">
                    <!-- QR Code พ่วงพร้อมเพย์ (ตัวอย่าง) -->
                    <img id="qr-image" src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=00020101021130230016010804711000000005102TH91040000" class="w-32 h-32 mb-2">
                    <p class="text-xs text-gray-500 font-bold text-center">พร้อมเพย์: 0XX-XXX-XXXX<br>ชื่อบัญชี: ขนำลุงดำ</p>
                </div>
                <div class="text-left">
                    <label class="block text-sm font-bold mb-2">แนบหลักฐานการโอนเงิน</label>
                    <input type="file" id="slip" accept="image/*" class="w-full text-xs">
                </div>
            </div>
        </div>

        <!-- SUCCESS SCREEN -->
        <div id="step-success" class="hidden animate-fadeIn text-center space-y-6 py-10">
            <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto">
                <svg class="w-12 h-12 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h2 class="text-2xl font-bold text-emerald-900">รับเรื่องการจองแล้ว!</h2>
            <p class="text-gray-500 text-sm px-10">แอดมินกำลังตรวจสอบหลักฐานของคุณ<br>คุณจะได้รับการแจ้งเตือนผ่าน LINE เมื่อยืนยันสำเร็จ</p>
            <button onclick="liff.closeWindow()" class="bg-emerald-800 text-white px-8 py-3 rounded-full font-bold shadow-lg">กลับสู่ LINE</button>
        </div>

    </div>

    <!-- Navigation Footer -->
    <div id="footer-nav" class="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-[0_-4px_10px_rgba(0,0,0,0.1)] flex justify-between items-center max-w-md mx-auto border-t">
        <button id="prev-btn" onclick="prevStep()" class="hidden text-gray-500 font-bold px-4 h-12">ย้อนกลับ</button>
        <div class="flex-grow"></div>
        <button id="next-btn" onclick="nextStep()" class="bg-emerald-800 text-white px-10 py-3 rounded-xl font-bold shadow-lg h-12">ดำเนินการต่อ</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const LIFF_ID = '2008863563-tuai5kaC'; // <--- แก้ไขที่นี่
        const API_URL = 'https://script.google.com/macros/s/AKfycbwb9VWt0rQYJ2dJa9jQKM23YRKsx-YReKnqJTiqGRbg26jEMtPP-RzxDbe_BahxUiSu5g/exec'; // <--- แก้ไขที่นี่
        
        let currentStep = 1;
        let lineUser = { userId: "", displayName: "", pictureUrl: "" };
        let bookingData = {
            roomId: "", roomName: "", roomPrice: 0,
            foodId: "-", foodName: "-", foodPrice: 0, foodQty: 0,
            guests: 1, discountCode: "", discountValue: 0,
            checkin: "", checkout: "", totalPrice: 0, deposit: 0
        };

        // --- 1. INITIALIZE LINE LIFF ---
        async function initLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    lineUser.userId = profile.userId;
                    lineUser.displayName = profile.displayName;
                    lineUser.pictureUrl = profile.pictureUrl;
                    
                    // แสดงข้อมูลผู้ใช้
                    document.getElementById('user-info').classList.remove('hidden');
                    document.getElementById('user-img').src = profile.pictureUrl;
                    document.getElementById('user-name').innerText = profile.displayName;
                    document.getElementById('loading-screen').classList.add('hidden');
                    
                    // ตั้งค่าวันที่ขั้นต่ำ
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('checkin').min = today;
                }
            } catch (err) {
                console.error('LIFF Init Error', err);
                alert("กรุณาเปิดใน LINE Application เท่านั้น");
            }
        }

        // --- 2. SELECTION LOGIC ---
        function selectRoom(id, name, price) {
            bookingData.roomId = id;
            bookingData.roomName = name;
            bookingData.roomPrice = price;
            
            document.querySelectorAll('.room-card').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            updateSummary();
        }

        function selectFood(id, name, price) {
            if (bookingData.foodId === id) {
                bookingData.foodId = "-";
                bookingData.foodName = "-";
                bookingData.foodPrice = 0;
                bookingData.foodQty = 0;
                event.currentTarget.classList.remove('selected');
            } else {
                bookingData.foodId = id;
                bookingData.foodName = name;
                bookingData.foodPrice = price;
                bookingData.foodQty = 1;
                document.querySelectorAll('.food-card').forEach(el => el.classList.remove('selected'));
                event.currentTarget.classList.add('selected');
            }
            updateSummary();
        }

        function updateGuests(val) {
            let newVal = bookingData.guests + val;
            if (newVal >= 1 && newVal <= 10) {
                bookingData.guests = newVal;
                document.getElementById('guest-count').innerText = newVal;
            }
        }

        function validateDates() {
            const cin = document.getElementById('checkin').value;
            if (cin) document.getElementById('checkout').min = cin;
            updateSummary();
        }

        function applyDiscount() {
            const code = document.getElementById('promo-code').value.toUpperCase();
            const msg = document.getElementById('promo-msg');
            
            // ตัวอย่างเงื่อนไขโค้ด (ควรดึงจาก Sheet แต่ในที่นี้ทำเป็น Logic เบื้องต้น)
            if (code === "WELCOME") {
                bookingData.discountCode = "WELCOME";
                bookingData.discountValue = 100;
                msg.innerText = "✓ ลดเพิ่ม 100 บาท";
                msg.className = "text-xs mt-1 text-emerald-600";
            } else {
                bookingData.discountCode = "";
                bookingData.discountValue = 0;
                msg.innerText = "× โค้ดไม่ถูกต้อง";
                msg.className = "text-xs mt-1 text-red-500";
            }
            updateSummary();
        }

        function updateSummary() {
            const cin = document.getElementById('checkin').value;
            const cout = document.getElementById('checkout').value;
            let nights = 1;

            if (cin && cout) {
                const start = new Date(cin);
                const end = new Date(cout);
                nights = Math.max(1, Math.ceil((end - start) / (1000 * 60 * 60 * 24)));
            }

            const roomCost = bookingData.roomPrice * nights;
            const foodCost = bookingData.foodPrice * bookingData.foodQty;
            const total = (roomCost + foodCost) - bookingData.discountValue;
            const deposit = Math.ceil(total * 0.5);

            bookingData.checkin = cin;
            bookingData.checkout = cout;
            bookingData.totalPrice = total;
            bookingData.deposit = deposit;

            // Update UI
            document.getElementById('summary-room').innerText = bookingData.roomName || "ยังไม่เลือก";
            document.getElementById('price-room').innerText = `฿${roomCost.toLocaleString()}`;
            document.getElementById('summary-food').innerText = bookingData.foodName;
            document.getElementById('price-food').innerText = `฿${foodCost.toLocaleString()}`;
            document.getElementById('price-total').innerText = `฿${total.toLocaleString()}`;
            document.getElementById('price-deposit').innerText = `฿${deposit.toLocaleString()}`;

            if (bookingData.discountValue > 0) {
                document.getElementById('discount-row').style.display = 'flex';
                document.getElementById('price-discount').innerText = `-฿${bookingData.discountValue}`;
            } else {
                document.getElementById('discount-row').style.display = 'none';
            }
        }

        // --- 3. NAVIGATION ---
        function nextStep() {
            if (currentStep === 1) {
                if (!bookingData.roomId || !bookingData.checkin) {
                    return alert("กรุณาเลือกวันและห้องพักให้ครบถ้วน");
                }
            }
            if (currentStep === 3) {
                return submitBooking();
            }

            document.getElementById(`step-${currentStep}`).classList.add('hidden');
            document.getElementById(`step-btn-${currentStep}`).classList.remove('step-active');
            
            currentStep++;
            
            document.getElementById(`step-${currentStep}`).classList.remove('hidden');
            document.getElementById(`step-btn-${currentStep}`).classList.add('step-active');
            document.getElementById('prev-btn').classList.remove('hidden');
            
            if (currentStep === 3) {
                document.getElementById('next-btn').innerText = 'ยืนยันการจอง';
                document.getElementById('next-btn').classList.replace('bg-emerald-800', 'bg-emerald-600');
            }
            window.scrollTo(0,0);
        }

        function prevStep() {
            document.getElementById(`step-${currentStep}`).classList.add('hidden');
            document.getElementById(`step-btn-${currentStep}`).classList.remove('step-active');
            currentStep--;
            document.getElementById(`step-${currentStep}`).classList.remove('hidden');
            document.getElementById(`step-btn-${currentStep}`).classList.add('step-active');
            if (currentStep === 1) document.getElementById('prev-btn').classList.add('hidden');
            document.getElementById('next-btn').innerText = 'ดำเนินการต่อ';
            document.getElementById('next-btn').classList.replace('bg-emerald-600', 'bg-emerald-800');
            window.scrollTo(0,0);
        }

        // --- 4. DATA SUBMISSION ---
        async function submitBooking() {
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;
            const slip = document.getElementById('slip').files[0];

            if (!name || !phone || !slip) {
                return alert("กรุณากรอกข้อมูลติดต่อและแนบหลักฐานการโอน");
            }

            document.getElementById('next-btn').disabled = true;
            document.getElementById('next-btn').innerText = 'กำลังส่งข้อมูล...';

            const reader = new FileReader();
            reader.readAsDataURL(slip);
            reader.onload = async () => {
                const payload = {
                    lineId: lineUser.userId,
                    lineName: lineUser.displayName,
                    name: name,
                    phone: phone,
                    roomId: bookingData.roomId,
                    roomName: bookingData.roomName,
                    guests: bookingData.guests,
                    foodId: bookingData.foodId,
                    foodName: bookingData.foodName,
                    foodQty: bookingData.foodQty,
                    discountCode: bookingData.discountCode,
                    discountValue: bookingData.discountValue,
                    totalPrice: bookingData.totalPrice,
                    deposit: bookingData.deposit,
                    checkin: bookingData.checkin,
                    checkout: bookingData.checkout,
                    slipBase64: reader.result
                };

                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        mode: 'no-cors' // สำหรับ Apps Script
                    });
                    
                    // ซ่อนองค์ประกอบที่ไม่จำเป็นและแสดงหน้าสำเร็จ
                    document.getElementById('step-3').classList.add('hidden');
                    document.getElementById('step-nav').classList.add('hidden');
                    document.getElementById('footer-nav').classList.add('hidden');
                    document.getElementById('step-success').classList.remove('hidden');
                } catch (e) {
                    console.error(e);
                    alert("เกิดข้อผิดพลาดในการส่งข้อมูล");
                    document.getElementById('next-btn').disabled = false;
                    document.getElementById('next-btn').innerText = 'ยืนยันการจอง';
                }
            };
        }

        window.onload = initLiff;
    </script>
</body>
</html>
