<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<title>ขนำลุงดำ แคมป์ปิ้ง</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<style>
body{font-family:'Kanit',sans-serif;background:#f0fdf4}
.card{border:1px solid #ddd;border-radius:12px;padding:12px}
.card.active{border:2px solid #059669;background:#ecfdf5}
</style>
</head>
<body class="p-4 max-w-md mx-auto">

<h1 class="text-xl font-bold text-emerald-800 mb-3">ขนำลุงดำ แคมป์ปิ้ง</h1>

<div id="profile" class="mb-3 text-sm text-gray-600"></div>

<div class="card mb-3">
<label>วันเข้าพัก</label>
<input type="date" id="checkin" class="w-full border p-2">
<label class="mt-2 block">วันออก</label>
<input type="date" id="checkout" class="w-full border p-2">
</div>

<div class="card mb-3">
<h2 class="font-bold">เลือกห้องพัก</h2>
<div id="rooms"></div>
</div>

<div class="card mb-3">
<h2 class="font-bold">อาหาร</h2>
<div id="foods"></div>
</div>

<div class="card mb-3">
<label>ชื่อผู้จอง</label>
<input id="custName" class="w-full border p-2">
<label class="mt-2 block">เบอร์โทร</label>
<input id="custTel" class="w-full border p-2">
</div>

<div class="card mb-3">
<h2 class="font-bold">สรุปราคา</h2>
<p>รวม: <span id="totalPrice">0</span> บาท</p>
<p class="text-red-600">มัดจำ: <span id="deposit">0</span> บาท</p>
<img id="qr" class="mx-auto my-2" width="200">
</div>

<div class="card mb-3">
<label>แนบสลิป</label>
<input type="file" id="slip">
</div>

<button onclick="submitBooking()" class="bg-emerald-700 text-white w-full p-3 rounded-xl font-bold">ยืนยันการจอง</button>

<script>
const LIFF_ID="2008863563-tuai5kaC";
const BACKEND_URL="https://script.google.com/macros/s/AKfycbwb9VWt0rQYJ2dJa9jQKM23YRKsx-YReKnqJTiqGRbg26jEMtPP-RzxDbe_BahxUiSu5g/exec";

let USER_ID="",USER_NAME="";
const ROOM_PRICE={
 HS1:{name:"โฮมสเตย์หนำโป",p:[[4,5,1600],[6,8,2200]]},
 RN1:{name:"บ้านพักริมน้ำ1",p:[[1,2,1400],[3,3,1750]]},
 RN2:{name:"บ้านพักริมน้ำ2",p:[[1,2,1400],[3,3,1750]]},
 TJ1:{name:"เต็นท์กระโจม1",p:[[1,2,1200],[3,4,1550]]},
 TJ2:{name:"เต็นท์กระโจม2",p:[[1,2,1200],[3,4,1550]]},
 K1:{name:"เต็นท์สนามK1",p:[[1,2,700]]},
 K2:{name:"เต็นท์สนามK2",p:[[1,2,700]]},
 TENT:{name:"ลานกางเต็นท์",p:[[1,20,150]]}
};
const FOOD={
 pork:390, chicken:390, shabuP:390, shabuC:390, local:390
};

let selectedRooms={},foodQty={},total=0;

liff.init({liffId:LIFF_ID}).then(()=>{
 liff.getProfile().then(p=>{
  USER_ID=p.userId;USER_NAME=p.displayName;
  document.getElementById("profile").innerText="สวัสดี "+USER_NAME;
 });
});

const roomDiv=document.getElementById("rooms");
Object.keys(ROOM_PRICE).forEach(k=>{
 roomDiv.innerHTML+=`
 <div class="mt-2">
  <label>${ROOM_PRICE[k].name}</label>
  <input type="number" min="0" max="20" placeholder="จำนวนคน" 
   onchange="setRoom('${k}',this.value)" class="border p-1 w-full">
 </div>`;
});

function setRoom(code,val){
 if(val>0) selectedRooms[code]=parseInt(val); else delete selectedRooms[code];
 calc();
}

const foodDiv=document.getElementById("foods");
Object.keys(FOOD).forEach(k=>{
 foodDiv.innerHTML+=`
 <div class="mt-2 flex justify-between">
  <span>${k} (${FOOD[k]}฿)</span>
  <input type="number" min="0" onchange="foodQty['${k}']=this.value;calc()" class="border w-16">
 </div>`;
});

function calc(){
 total=0;
 for(let r in selectedRooms){
  let people=selectedRooms[r];
  let rule=ROOM_PRICE[r].p.find(x=>people>=x[0]&&people<=x[1]);
  if(r=="TENT") total+=people*150;
  else if(rule) total+=rule[2];
 }
 for(let f in foodQty){
  total+=FOOD[f]*foodQty[f];
 }
 document.getElementById("totalPrice").innerText=total;
 document.getElementById("deposit").innerText=Math.ceil(total/2);
 document.getElementById("qr").src=
  "https://promptpay.io/0615924262/"+Math.ceil(total/2);
}

function submitBooking(){
 const file=document.getElementById("slip").files[0];
 const reader=new FileReader();
 reader.onload=()=>{
  fetch(BACKEND_URL,{
   method:"post",
   body:JSON.stringify({
    action:"addBooking",
    payload:{
     lineId:USER_ID,lineName:USER_NAME,
     custName:custName.value,tel:custTel.value,
     roomCodes:Object.keys(selectedRooms),
     rooms:Object.keys(selectedRooms).map(r=>ROOM_PRICE[r].name),
     people:Object.values(selectedRooms),
     foods:Object.keys(foodQty),foodQty:Object.values(foodQty),
     total:total,deposit:Math.ceil(total/2),remain:total-Math.ceil(total/2),
     checkin:checkin.value,checkout:checkout.value
    }
   })
  });
  fetch(BACKEND_URL,{method:"post",
   body:JSON.stringify({action:"uploadSlip",file:reader.result,bookingId:"TMP"})});
 };
 reader.readAsDataURL(file);
 alert("ส่งการจองแล้ว รอแอดมินตรวจสอบ");
}
</script>
</body>
</html>
