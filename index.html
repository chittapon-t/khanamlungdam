<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å - ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        .step-active { color: #059669; font-weight: 600; border-bottom: 3px solid #059669; }
        .card-selected { border: 2px solid #059669; background-color: #f0fdf4; }
        .card-booked { opacity: 0.6; background-color: #f1f5f9; cursor: not-allowed; border: 1px dashed #cbd5e1; }
        .room-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; }
    </style>
</head>
<body class="pb-10">

    <div id="loading" class="fixed inset-0 bg-black/60 z-50 flex flex-col items-center justify-center hidden text-white">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
        <p id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
    </div>

    <header class="bg-emerald-800 text-white p-6 sticky top-0 z-40 shadow-md">
        <h1 class="text-xl font-bold text-center">‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</h1>
    </header>

    <!-- Stepper Navigation -->
    <nav class="bg-white border-b sticky top-[76px] z-30 flex justify-around text-sm text-gray-400">
        <div id="stepBtn1" class="py-3 px-4 step-active">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô</div>
        <div id="stepBtn2" class="py-3 px-4">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</div>
        <div id="stepBtn3" class="py-3 px-4">3. ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
    </nav>

    <main class="max-w-md mx-auto p-4 mt-2">
        
        <!-- STEP 1: SELECT DATES -->
        <div id="step1" class="space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-sm space-y-4 border border-gray-100">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center">üóìÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm text-gray-500 mb-1 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å (Check-in)</label>
                        <input type="date" id="checkin" onchange="handleInDateChange()" class="w-full border-gray-200 border p-4 rounded-2xl focus:ring-2 focus:ring-emerald-500 outline-none text-lg">
                    </div>
                    <div>
                        <label class="text-sm text-gray-500 mb-1 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å (Check-out)</label>
                        <input type="date" id="checkout" onchange="updateTotal()" class="w-full border-gray-200 border p-4 rounded-2xl focus:ring-2 focus:ring-emerald-500 outline-none text-lg bg-gray-50">
                    </div>
                </div>
            </div>
            <button onclick="goToStep(2)" class="w-full bg-emerald-700 text-white py-4 rounded-2xl font-bold text-lg shadow-lg">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>

        <!-- STEP 2: SELECT ROOMS -->
        <div id="step2" class="hidden space-y-6">
            <div class="flex justify-between items-center px-1">
                <h2 class="text-lg font-semibold text-gray-800">üè† ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á</h2>
                <span class="text-xs text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á</span>
            </div>
            
            <div id="roomList" class="space-y-3">
                <!-- Rooms injected by JS -->
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <h2 class="text-lg font-bold text-emerald-800 flex items-center mb-4">ü•ò ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°</h2>
                <div id="foodList" class="space-y-3"></div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="goToStep(1)" class="w-1/3 border border-emerald-700 text-emerald-700 py-4 rounded-2xl font-bold">‡∏Å‡∏•‡∏±‡∏ö</button>
                <button onclick="goToStep(3)" class="w-2/3 bg-emerald-700 text-white py-4 rounded-2xl font-bold shadow-lg">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
            </div>
        </div>

        <!-- STEP 3: SUMMARY & PAYMENT -->
        <div id="step3" class="hidden space-y-6">
            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á -->
            <div class="bg-white p-6 rounded-3xl shadow-sm space-y-4 border border-gray-100">
                <h2 class="text-lg font-semibold text-gray-800">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h2>
                <input id="custName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á" class="w-full border-gray-200 border p-4 rounded-2xl outline-none">
                <input id="custTel" type="tel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full border-gray-200 border p-4 rounded-2xl outline-none">
                
                <div class="pt-2">
                    <label class="text-xs text-gray-500 ml-1">‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
                    <div class="flex gap-2 mt-1">
                        <input id="promoInput" type="text" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏Ñ‡πâ‡∏î" class="flex-1 border-gray-200 border p-3 rounded-xl uppercase font-bold">
                        <button onclick="applyPromo()" class="bg-emerald-100 text-emerald-700 px-4 py-2 rounded-xl font-bold">‡πÉ‡∏ä‡πâ</button>
                    </div>
                    <p id="promoMsg" class="text-[10px] mt-1 hidden"></p>
                </div>
            </div>

            <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
            <div class="bg-emerald-900 text-white p-6 rounded-3xl shadow-xl space-y-4">
                <div class="flex justify-between items-center border-b border-emerald-700 pb-3">
                    <span class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</span>
                    <span id="sumDates" class="font-bold"></span>
                </div>
                
                <div id="sumRooms" class="space-y-2 text-sm"></div>
                <div id="sumFoods" class="space-y-2 text-sm text-emerald-100 italic border-t border-emerald-800 pt-2"></div>

                <div class="pt-3 border-t border-emerald-700 space-y-2">
                    <div class="flex justify-between">
                        <span>‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏õ‡∏Å‡∏ï‡∏¥</span>
                        <span id="sumRoomPrice">‡∏ø0</span>
                    </div>
                    <div id="sumDiscountRow" class="flex justify-between text-yellow-400 hidden">
                        <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</span>
                        <span id="sumDiscount">-‡∏ø0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
                        <span id="sumFoodPrice">‡∏ø0</span>
                    </div>
                    <div class="flex justify-between text-xl font-bold pt-2 border-t border-emerald-800">
                        <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                        <span id="sumTotal">‡∏ø0</span>
                    </div>
                </div>

                <div class="bg-white text-emerald-900 p-4 rounded-2xl flex justify-between items-center font-bold">
                    <div>
                        <span class="block text-[10px] text-gray-400 font-normal">‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ (50% ‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î + ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</span>
                        <span>‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</span>
                    </div>
                    <span id="sumDeposit" class="text-2xl text-red-600">‡∏ø0</span>
                </div>
            </div>

            <!-- ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
            <div class="bg-white p-6 rounded-3xl shadow-sm text-center space-y-4">
                <p class="font-bold text-gray-800">QR CODE ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</p>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=00020101021130300016A000000677010111011300666159242625802TH53037646304" alt="PromptPay QR" class="mx-auto w-48 border-4 border-gray-100 p-2 rounded-xl">
                <p class="text-sm">0615924262 <br>‡∏≠‡∏•‡∏á‡∏Å‡∏ï ‡∏ó‡∏ß‡∏µ‡∏ú‡πà‡∏≠‡∏á</p>
                
                <div class="text-left space-y-3 pt-4 border-t">
                    <label class="block text-sm font-medium text-gray-700">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <input type="file" id="slipFile" accept="image/*" class="w-full text-sm">
                </div>

                <div class="flex items-start gap-2 text-left pt-2">
                    <input type="checkbox" id="acceptTerms" class="mt-1 w-5 h-5 accent-emerald-700">
                    <label for="acceptTerms" class="text-xs text-gray-600 leading-relaxed cursor-pointer">‡∏â‡∏±‡∏ô‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á ‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏à‡∏∞‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏•‡∏¥‡∏õ</label>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="goToStep(2)" class="w-1/3 border border-emerald-700 text-emerald-700 py-4 rounded-2xl font-bold">‡∏Å‡∏•‡∏±‡∏ö</button>
                <button onclick="handleFinalBooking()" id="confirmBtn" class="w-2/3 bg-emerald-700 text-white py-4 rounded-2xl font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
            </div>
        </div>

    </main>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwektF_DO710_XQ4bEoVtYxgupJRreNyvKrQ8t36ILerJFnzWfnFItQkqdg1yswHpAc3g/exec';

        const rawRooms = [
            { id: 'homestay', name: '‡πÇ‡∏Æ‡∏°‡∏™‡πÄ‡∏ï‡∏¢‡πå‡∏´‡∏ô‡∏≥‡πÇ‡∏õ', options: [{ cap: 5, price: 1600 }, { cap: 8, price: 2200 }], booked: false },
            { id: 'rimnam1', name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ 1', options: [{ cap: 2, price: 1400 }, { cap: 3, price: 1750 }], booked: false, morning: true },
            { id: 'rimnam2', name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ 2', options: [{ cap: 2, price: 1400 }, { cap: 3, price: 1750 }], booked: false, morning: true },
            { id: 'tent1', name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏° 1', options: [{ cap: 2, price: 1200 }, { cap: 4, price: 1550 }], booked: false, morning: true },
            { id: 'tent2', name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏° 2', options: [{ cap: 2, price: 1200 }, { cap: 4, price: 1550 }], booked: false, morning: true },
            { id: 'field1', name: '‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏ô‡∏≤‡∏° K1', options: [{ cap: 2, price: 700 }], booked: false, morning: true },
            { id: 'field2', name: '‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏ô‡∏≤‡∏° K2', options: [{ cap: 2, price: 700 }], booked: false, morning: true },
            { id: 'camping', name: '‡∏•‡∏≤‡∏ô‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå', options: [{ cap: 1, price: 150, perPerson: true }], booked: false, max: 20 }
        ];

        const foodData = [
            { id: 'mookata', name: '‡∏ä‡∏∏‡∏î‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'kaikata', name: '‡∏ä‡∏∏‡∏î‡πÑ‡∏Å‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'shabu_pork', name: '‡∏ä‡∏∏‡∏î‡∏ä‡∏≤‡∏ö‡∏π‡∏´‡∏°‡∏π‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'shabu_chicken', name: '‡∏ä‡∏∏‡∏î‡∏ä‡∏≤‡∏ö‡∏π‡πÑ‡∏Å‡πà‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'local_set', name: '‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', price: 390 }
        ];

        let state = {
            step: 1,
            checkin: '',
            checkout: '',
            selectedRooms: {}, // { roomID: { optIdx, count } }
            selectedFoods: {},
            activePromo: null,
            total: 0,
            deposit: 0,
            promoCodes: []
        };

        async function init() {
            try {
                // Initialize LIFF and Auto Login
                await liff.init({ liffId: "2008863563-tuai5kaC" });
                if (!liff.isLoggedIn()) {
                    liff.login();
                }
            } catch (e) { console.warn("LIFF Login failed"); }

            // Set default dates
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const afterTomorrow = new Date(tomorrow);
            afterTomorrow.setDate(afterTomorrow.getDate() + 1);

            document.getElementById('checkin').min = tomorrow.toISOString().split('T')[0];
            document.getElementById('checkin').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('checkout').value = afterTomorrow.toISOString().split('T')[0];
            
            handleInDateChange();
            renderFoods();
            fetchCodes();
        }

        async function fetchCodes() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                state.promoCodes = data.promoCodes || [];
            } catch (e) { console.warn("Load codes error"); }
        }

        function handleInDateChange() {
            const inDate = new Date(document.getElementById('checkin').value);
            const outDate = new Date(inDate);
            outDate.setDate(outDate.getDate() + 1);
            document.getElementById('checkout').min = outDate.toISOString().split('T')[0];
            document.getElementById('checkout').value = outDate.toISOString().split('T')[0];
            updateTotal();
        }

        function renderRooms() {
            const container = document.getElementById('roomList');
            container.innerHTML = rawRooms.map(room => {
                const isSelected = !!state.selectedRooms[room.id];
                const currentData = state.selectedRooms[room.id] || { optIdx: 0, count: 1 };
                
                return `
                    <div class="p-4 rounded-2xl border transition-all ${room.booked ? 'card-booked' : (isSelected ? 'card-selected shadow-md' : 'bg-white border-gray-100')}" 
                         onclick="${room.booked ? '' : `toggleRoom('${room.id}')`}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-bold ${isSelected ? 'text-emerald-900' : 'text-gray-800'}">${room.name}</h3>
                                ${room.morning ? `<span class="room-badge bg-emerald-100 text-emerald-700">‡∏ü‡∏£‡∏µ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤</span>` : ''}
                            </div>
                            <div class="text-right">
                                <span class="block font-bold text-emerald-700">${room.id === 'camping' ? '‡∏ø150/‡∏Ñ‡∏ô' : `‡∏ø${room.options[0].price}+`}</span>
                                ${room.booked ? '<span class="text-[10px] text-red-500 font-bold">‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß</span>' : ''}
                            </div>
                        </div>

                        ${isSelected ? `
                            <div class="mt-3 pt-3 border-t border-emerald-100 space-y-3" onclick="event.stopPropagation()">
                                ${room.id === 'camping' ? `
                                    <div class="flex justify-between items-center text-sm">
                                        <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å (‡∏Ñ‡∏ô)</span>
                                        <div class="flex items-center gap-3">
                                            <button onclick="updateCamping('${room.id}', -1)" class="w-8 h-8 rounded-full bg-white border flex items-center justify-center">-</button>
                                            <span class="font-bold w-4 text-center">${currentData.count}</span>
                                            <button onclick="updateCamping('${room.id}', 1)" class="w-8 h-8 rounded-full bg-white border flex items-center justify-center">+</button>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="flex flex-col gap-2">
                                        ${room.options.map((opt, idx) => `
                                            <label class="flex justify-between items-center p-2 rounded-xl border bg-white ${currentData.optIdx === idx ? 'border-emerald-500 ring-1 ring-emerald-500' : 'border-gray-100'}">
                                                <div class="flex items-center text-sm">
                                                    <input type="radio" name="opt_${room.id}" ${currentData.optIdx === idx ? 'checked' : ''} onchange="setRoomOpt('${room.id}', ${idx})" class="mr-2 accent-emerald-600">
                                                    ‡∏û‡∏±‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${opt.cap} ‡∏Ñ‡∏ô
                                                </div>
                                                <span class="text-sm font-bold">‡∏ø${opt.price}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderFoods() {
            const container = document.getElementById('foodList');
            container.innerHTML = foodData.map(food => {
                const count = state.selectedFoods[food.id] || 0;
                return `
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <span class="text-sm font-medium text-gray-700">${food.name} (‡∏ø${food.price})</span>
                        <div class="flex items-center gap-3">
                            <button onclick="updateFood('${food.id}', -1)" class="w-8 h-8 rounded-lg bg-white border flex items-center justify-center">-</button>
                            <span class="w-4 text-center font-bold text-sm">${count}</span>
                            <button onclick="updateFood('${food.id}', 1)" class="w-8 h-8 rounded-lg bg-white border flex items-center justify-center">+</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleRoom(id) {
            if (state.selectedRooms[id]) delete state.selectedRooms[id];
            else state.selectedRooms[id] = { optIdx: 0, count: 1 };
            renderRooms();
            updateTotal();
        }

        function setRoomOpt(id, idx) {
            state.selectedRooms[id].optIdx = idx;
            renderRooms();
            updateTotal();
        }

        function updateCamping(id, val) {
            state.selectedRooms[id].count = Math.min(20, Math.max(1, state.selectedRooms[id].count + val));
            renderRooms();
            updateTotal();
        }

        function updateFood(id, val) {
            state.selectedFoods[id] = Math.max(0, (state.selectedFoods[id] || 0) + val);
            renderFoods();
            updateTotal();
        }

        function applyPromo() {
            const code = document.getElementById('promoInput').value.trim().toUpperCase();
            const msg = document.getElementById('promoMsg');
            const found = state.promoCodes.find(p => p.code.toUpperCase() === code);
            if(found) {
                state.activePromo = found;
                msg.innerText = `‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ: ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å ‡∏ø${found.discount}`;
                msg.className = "text-[10px] mt-1 block text-emerald-600 font-bold";
            } else {
                state.activePromo = null;
                msg.innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏";
                msg.className = "text-[10px] mt-1 block text-red-500";
            }
            updateTotal();
        }

        function updateTotal() {
            let roomTotal = 0;
            let foodTotal = 0;

            Object.entries(state.selectedRooms).forEach(([rid, config]) => {
                const room = rawRooms.find(r => r.id === rid);
                if (room.id === 'camping') roomTotal += room.options[0].price * config.count;
                else roomTotal += room.options[config.optIdx].price;
            });

            Object.entries(state.selectedFoods).forEach(([fid, count]) => {
                const food = foodData.find(f => f.id === fid);
                foodTotal += food.price * count;
            });

            const discount = state.activePromo ? state.activePromo.discount : 0;
            
            // Formula: ((RoomPrice - Discount) * 50%) + FoodTotal
            const subtotalRoomAfterDiscount = Math.max(0, roomTotal - discount);
            const total = subtotalRoomAfterDiscount + foodTotal;
            const deposit = (subtotalRoomAfterDiscount * 0.5) + foodTotal;

            state.total = total;
            state.deposit = deposit;

            // Update Summary UI
            document.getElementById('sumDates').innerText = `${document.getElementById('checkin').value} ‡∏ñ‡∏∂‡∏á ${document.getElementById('checkout').value}`;
            document.getElementById('sumRoomPrice').innerText = `‡∏ø${roomTotal.toLocaleString()}`;
            document.getElementById('sumFoodPrice').innerText = `‡∏ø${foodTotal.toLocaleString()}`;
            document.getElementById('sumTotal').innerText = `‡∏ø${total.toLocaleString()}`;
            document.getElementById('sumDeposit').innerText = `‡∏ø${deposit.toLocaleString()}`;
            
            const discRow = document.getElementById('sumDiscountRow');
            if(discount > 0) {
                discRow.classList.remove('hidden');
                document.getElementById('sumDiscount').innerText = `-‡∏ø${discount.toLocaleString()}`;
            } else {
                discRow.classList.add('hidden');
            }

            // Room list for summary
            document.getElementById('sumRooms').innerHTML = Object.entries(state.selectedRooms).map(([rid, config]) => {
                const room = rawRooms.find(r => r.id === rid);
                const capText = room.id === 'camping' ? `${config.count} ‡∏Ñ‡∏ô` : `${room.options[config.optIdx].cap} ‡∏Ñ‡∏ô`;
                const priceText = room.id === 'camping' ? (room.options[0].price * config.count) : room.options[config.optIdx].price;
                return `<div class="flex justify-between"><span>‚Ä¢ ${room.name} (${capText})</span><span>‡∏ø${priceText.toLocaleString()}</span></div>`;
            }).join('');

            // Food list for summary
            document.getElementById('sumFoods').innerHTML = Object.entries(state.selectedFoods).filter(f => f[1] > 0).map(([fid, count]) => {
                const food = foodData.find(f => f.id === fid);
                return `<div class="flex justify-between"><span>- ${food.name} x${count}</span><span>‡∏ø${(food.price * count).toLocaleString()}</span></div>`;
            }).join('');
        }

        function goToStep(s) {
            if(s === 2 && !document.getElementById('checkin').value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô");
            if(s === 3 && Object.keys(state.selectedRooms).length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
            
            document.getElementById(`step${state.step}`).classList.add('hidden');
            document.getElementById(`stepBtn${state.step}`).classList.remove('step-active');
            
            state.step = s;
            document.getElementById(`step${s}`).classList.remove('hidden');
            document.getElementById(`stepBtn${s}`).classList.add('step-active');
            
            if(s === 2) renderRooms();
            window.scrollTo(0,0);
        }

        async function handleFinalBooking() {
            const name = document.getElementById('custName').value.trim();
            const tel = document.getElementById('custTel').value.trim();
            const slip = document.getElementById('slipFile').files[0];
            const terms = document.getElementById('acceptTerms').checked;

            if(!name || !tel) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå");
            if(!slip) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");
            if(!terms) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á");

            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á...");

            const roomListStr = Object.entries(state.selectedRooms).map(([rid, config]) => {
                const room = rawRooms.find(r => r.id === rid);
                return `${room.name} (${room.id === 'camping' ? config.count : room.options[config.optIdx].cap} ‡∏Ñ‡∏ô)`;
            }).join(', ');

            const foodListStr = Object.entries(state.selectedFoods).filter(f => f[1] > 0).map(([fid, count]) => {
                return `${foodData.find(f => f.id === fid).name} x${count}`;
            }).join(', ');

            const reader = new FileReader();
            reader.onload = async function() {
                try {
                    const payload = {
                        action: 'saveBooking',
                        custName: name,
                        custTel: tel,
                        checkin: document.getElementById('checkin').value,
                        checkout: document.getElementById('checkout').value,
                        rooms: roomListStr,
                        foods: foodListStr || '‡πÑ‡∏°‡πà‡∏°‡∏µ',
                        total: state.total,
                        deposit: state.deposit,
                        promoCode: state.activePromo ? state.activePromo.code : '',
                        discount: state.activePromo ? state.activePromo.discount : 0,
                        slip: reader.result
                    };

                    const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    const res = await response.json();
                    
                    if(res.status === 'success') {
                        alert("‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                        liff.closeWindow();
                    } else {
                        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + res.message);
                    }
                } catch (e) {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                } finally {
                    hideLoading();
                }
            };
            reader.readAsDataURL(slip);
        }

        function showLoading(t) { document.getElementById('loadingText').innerText = t; document.getElementById('loading').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading').classList.add('hidden'); }

        window.onload = init;
    </script>
</body>
</html>
