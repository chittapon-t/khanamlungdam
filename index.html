<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ขนำลุงดำ แคมป์ปิ้ง - ระบบจองที่พัก</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        .step-active { color: #065f46; border-bottom: 3px solid #065f46; font-weight: bold; }
        .card-selected { border-color: #059669 !important; background-color: #f0fdf4 !important; ring: 2px; ring-color: #10b981; }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="pb-24">
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="inline-block w-12 h-12 border-4 border-emerald-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-emerald-800">กำลังโหลดข้อมูล...</p>
        </div>
    </div>

    <div class="bg-emerald-800 text-white p-6 shadow-lg">
        <h1 class="text-2xl font-bold">ขนำลุงดำ แคมป์ปิ้ง</h1>
        <p class="text-emerald-100 text-sm">ระบบจองอัตโนมัติ (Official)</p>
    </div>

    <div id="step-indicator" class="bg-white flex justify-around p-3 sticky top-0 z-10 shadow-sm">
        <div id="tab-1" class="text-sm step-active">1. ที่พัก</div>
        <div id="tab-2" class="text-sm text-gray-400">2. อาหาร</div>
        <div id="tab-3" class="text-sm text-gray-400">3. ยืนยัน</div>
    </div>

    <div class="max-w-md mx-auto p-4">
        
        <!-- STEP 1: Rooms -->
        <div id="step-1" class="animate-fadeIn space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h2 class="font-bold text-emerald-900 mb-3">ระบุวันเข้าพัก</h2>
                <div class="grid grid-cols-2 gap-3">
                    <input type="date" id="checkin" class="border p-2 rounded-lg text-sm w-full" onchange="calculateLogic()">
                    <input type="date" id="checkout" class="border p-2 rounded-lg text-sm w-full" onchange="calculateLogic()">
                </div>
            </div>

            <div class="space-y-3" id="room-list">
                <!-- Data will be injected here via JS -->
            </div>
            
            <div id="guest-selector" class="bg-white p-4 rounded-xl shadow-sm hidden">
                <label class="block text-sm font-bold mb-2">ระบุจำนวนผู้เข้าพัก</label>
                <div class="flex items-center gap-6">
                    <button onclick="changeGuest(-1)" class="w-10 h-10 border rounded-full font-bold text-xl">-</button>
                    <span id="display-guests" class="text-2xl font-bold">1</span>
                    <button onclick="changeGuest(1)" class="w-10 h-10 border rounded-full font-bold text-xl">+</button>
                    <span class="text-gray-500">ท่าน</span>
                </div>
                <p id="guest-price-info" class="text-xs text-emerald-600 mt-2 font-semibold"></p>
            </div>
        </div>

        <!-- STEP 2: Food -->
        <div id="step-2" class="hidden animate-fadeIn space-y-4">
            <h2 class="font-bold text-emerald-900">สั่งอาหารล่วงหน้า</h2>
            <div id="food-list" class="grid grid-cols-1 gap-3">
                <!-- Data will be injected here -->
            </div>
        </div>

        <!-- STEP 3: Confirm -->
        <div id="step-3" class="hidden animate-fadeIn space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-sm space-y-3">
                <h2 class="font-bold text-emerald-900 border-b pb-2">ข้อมูลผู้จอง</h2>
                <input type="text" id="cust-name" placeholder="ชื่อ-นามสกุล" class="w-full border p-3 rounded-xl text-sm">
                <input type="tel" id="cust-phone" placeholder="เบอร์โทรศัพท์" class="w-full border p-3 rounded-xl text-sm">
            </div>

            <div class="bg-emerald-900 text-white p-5 rounded-2xl shadow-lg">
                <h3 class="text-center font-bold mb-4">สรุปยอดชำระ</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span id="sum-room-name"></span><span id="sum-room-price">฿0</span></div>
                    <div class="flex justify-between"><span id="sum-food-name"></span><span id="sum-food-price">฿0</span></div>
                    <div class="border-t border-emerald-700 pt-2 flex justify-between font-bold text-lg">
                        <span>รวมทั้งสิ้น</span><span id="sum-total">฿0</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm text-center space-y-4 border-2 border-emerald-100">
                <h3 class="font-bold text-red-600 underline">ยอดมัดจำ (50%)</h3>
                <p class="text-4xl font-bold text-emerald-900" id="sum-deposit">฿0</p>
                <div class="flex flex-col items-center">
                    <img id="promptpay-qr" src="" class="w-48 h-48 border rounded-lg shadow-sm mb-2">
                    <p class="text-sm font-bold">พร้อมเพย์: 061-592-4262</p>
                    <p class="text-xs text-gray-500">ชื่อบัญชี: อลงกต ทวีผ่อง</p>
                </div>
                <div class="text-left">
                    <label class="block text-sm font-bold mb-2">แนบสลิปโอนเงิน</label>
                    <input type="file" id="slip-file" accept="image/*" class="text-xs">
                </div>
            </div>
        </div>

        <!-- SUCCESS SCREEN -->
        <div id="step-success" class="hidden text-center py-10 space-y-6">
            <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto text-emerald-600">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h2 class="text-2xl font-bold">ส่งข้อมูลการจองสำเร็จ!</h2>
            <p class="text-gray-500">แอดมินจะตรวจสอบและแจ้งผลทางไลน์<br>ภายใน 30-60 นาที</p>
            <button onclick="liff.closeWindow()" class="bg-emerald-800 text-white px-10 py-3 rounded-full font-bold">เสร็จสิ้น</button>
        </div>

    </div>

    <!-- Navigation Footer -->
    <div id="nav-footer" class="fixed bottom-0 inset-x-0 bg-white p-4 border-t flex justify-between items-center max-w-md mx-auto z-20">
        <button id="btn-prev" onclick="moveStep(-1)" class="invisible text-gray-400 font-bold px-4">ย้อนกลับ</button>
        <button id="btn-next" onclick="moveStep(1)" class="bg-emerald-800 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-emerald-100">เลือกที่พักก่อน</button>
    </div>

    <script>
        const LIFF_ID = "2008863563-tuai5kaC"; 
        const API_URL = "https://script.google.com/macros/s/AKfycbwb9VWt0rQYJ2dJa9jQKM23YRKsx-YReKnqJTiqGRbg26jEMtPP-RzxDbe_BahxUiSu5g/exec"; 

        const ROOMS = [
            { id: "R1", name: "โฮมสเตย์หนำโป", info: "ห้องพักขนาดใหญ่", min: 4, max: 8, pricing: { 4: 1600, 5: 1600, 6: 2200, 7: 2200, 8: 2200 } },
            { id: "R2", name: "บ้านพักริมน้ำ 1", info: "ฟรีอาหารเช้า", min: 1, max: 3, pricing: { 1: 1400, 2: 1400, 3: 1750 } },
            { id: "R3", name: "บ้านพักริมน้ำ 2", info: "ฟรีอาหารเช้า", min: 1, max: 3, pricing: { 1: 1400, 2: 1400, 3: 1750 } },
            { id: "R4", name: "เต็นท์กระโจม 1", info: "ฟรีอาหารเช้า", min: 1, max: 4, pricing: { 1: 1200, 2: 1200, 3: 1550, 4: 1550 } },
            { id: "R5", name: "เต็นท์กระโจม 2", info: "ฟรีอาหารเช้า", min: 1, max: 4, pricing: { 1: 1200, 2: 1200, 3: 1550, 4: 1550 } },
            { id: "R6", name: "เช่าเต็นท์สนาม K1", info: "ฟรีอาหารเช้า", min: 1, max: 2, pricing: { 1: 700, 2: 700 } },
            { id: "R7", name: "เช่าเต็นท์สนาม K2", info: "ฟรีอาหารเช้า", min: 1, max: 2, pricing: { 1: 700, 2: 700 } },
            { id: "R8", name: "ลานกางเต็นท์", info: "นำเต็นท์มาเอง", min: 1, max: 20, pricing: "dynamic", unitPrice: 150 }
        ];

        const FOODS = [
            { id: "F1", name: "ชุดหมูกระทะลุงดำ", price: 390 },
            { id: "F2", name: "ชุดไก่กระทะลุงดำ", price: 390 },
            { id: "F3", name: "ชุดชาบูหมูลุงดำ", price: 390 },
            { id: "F4", name: "ชุดชาบูไก่ลุงดำ", price: 390 },
            { id: "F5", name: "เซ็ตอาหารพื้นบ้าน", price: 390 }
        ];

        let state = {
            step: 1,
            lineId: "",
            lineName: "",
            selectedRoom: null,
            guests: 1,
            selectedFood: null,
            totalPrice: 0,
            deposit: 0
        };

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if(!liff.isLoggedIn()) liff.login();
                const p = await liff.getProfile();
                state.lineId = p.userId;
                state.lineName = p.displayName;
                
                document.getElementById('loading').style.display = 'none';
                renderRooms();
                renderFoods();
                
                // Set default dates
                let today = new Date();
                let tomorrow = new Date();
                tomorrow.setDate(today.getDate() + 1);
                document.getElementById('checkin').value = today.toISOString().split('T')[0];
                document.getElementById('checkout').value = tomorrow.toISOString().split('T')[0];
            } catch (e) { console.error(e); }
        }

        function renderRooms() {
            const container = document.getElementById('room-list');
            container.innerHTML = ROOMS.map(r => `
                <div id="card-${r.id}" class="bg-white p-4 rounded-xl border-2 border-transparent shadow-sm flex justify-between items-center cursor-pointer" onclick="selectRoom('${r.id}')">
                    <div>
                        <h3 class="font-bold text-emerald-900">${r.name}</h3>
                        <p class="text-xs text-gray-400">${r.info}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-400">เริ่มต้น</p>
                        <p class="font-bold text-emerald-600 text-lg">฿${r.pricing === 'dynamic' ? r.unitPrice : r.pricing[r.min]}</p>
                    </div>
                </div>
            `).join('');
        }

        function renderFoods() {
            const container = document.getElementById('food-list');
            container.innerHTML = FOODS.map(f => `
                <div id="food-${f.id}" class="bg-white p-4 rounded-xl border-2 border-transparent shadow-sm flex justify-between items-center cursor-pointer" onclick="selectFood('${f.id}')">
                    <span class="font-bold">${f.name}</span>
                    <span class="text-emerald-600 font-bold">฿${f.price}</span>
                </div>
            `).join('');
        }

        function selectRoom(id) {
            state.selectedRoom = ROOMS.find(r => r.id === id);
            state.guests = state.selectedRoom.min;
            document.querySelectorAll('#room-list > div').forEach(el => el.classList.remove('card-selected'));
            document.getElementById(`card-${id}`).classList.add('card-selected');
            document.getElementById('guest-selector').classList.remove('hidden');
            calculateLogic();
        }

        function selectFood(id) {
            if(state.selectedFood?.id === id) {
                state.selectedFood = null;
                document.getElementById(`food-${id}`).classList.remove('card-selected');
            } else {
                state.selectedFood = FOODS.find(f => f.id === id);
                document.querySelectorAll('#food-list > div').forEach(el => el.classList.remove('card-selected'));
                document.getElementById(`food-${id}`).classList.add('card-selected');
            }
            calculateLogic();
        }

        function changeGuest(v) {
            if(!state.selectedRoom) return;
            let n = state.guests + v;
            if(n >= state.selectedRoom.min && n <= state.selectedRoom.max) {
                state.guests = n;
                calculateLogic();
            }
        }

        function calculateLogic() {
            if(!state.selectedRoom) return;
            
            // Calculate nights
            let d1 = new Date(document.getElementById('checkin').value);
            let d2 = new Date(document.getElementById('checkout').value);
            let nights = Math.max(1, Math.ceil((d2 - d1) / (86400000)));

            // Calculate Room Price
            let roomTotal = 0;
            if(state.selectedRoom.pricing === "dynamic") {
                roomTotal = state.selectedRoom.unitPrice * state.guests * nights;
                document.getElementById('guest-price-info').innerText = `ราคา ${state.selectedRoom.unitPrice} บ. ต่อคน/คืน`;
            } else {
                roomTotal = state.selectedRoom.pricing[state.guests] * nights;
                document.getElementById('guest-price-info').innerText = `ราคาสำหรับ ${state.guests} ท่าน คือ ${state.selectedRoom.pricing[state.guests]} บ./คืน`;
            }

            // Food Price
            let foodTotal = state.selectedFood ? state.selectedFood.price : 0;
            
            state.totalPrice = roomTotal + foodTotal;
            state.deposit = Math.ceil(state.totalPrice * 0.5);

            // Update UI
            document.getElementById('display-guests').innerText = state.guests;
            document.getElementById('sum-room-name').innerText = `${state.selectedRoom.name} (${nights} คืน)`;
            document.getElementById('sum-room-price').innerText = `฿${roomTotal.toLocaleString()}`;
            document.getElementById('sum-food-name').innerText = state.selectedFood ? state.selectedFood.name : "ไม่รับอาหาร";
            document.getElementById('sum-food-price').innerText = `฿${foodTotal.toLocaleString()}`;
            document.getElementById('sum-total').innerText = `฿${state.totalPrice.toLocaleString()}`;
            document.getElementById('sum-deposit').innerText = `฿${state.deposit.toLocaleString()}`;
            
            // Generate QR (using promptpay library style URL)
            document.getElementById('promptpay-qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=00020101021130230016010804711000000005102TH91040000`;
            
            // Update Footer Button Text
            if(state.step === 1) document.getElementById('btn-next').innerText = "เลือกอาหาร";
        }

        function moveStep(v) {
            if(v === 1) {
                if(state.step === 1 && !state.selectedRoom) return alert("กรุณาเลือกห้องพัก");
                if(state.step === 3) return submit();
            }

            document.getElementById(`step-${state.step}`).classList.add('hidden');
            document.getElementById(`tab-${state.step}`).classList.remove('step-active');
            document.getElementById(`tab-${state.step}`).classList.add('text-gray-400');
            
            state.step += v;
            
            document.getElementById(`step-${state.step}`).classList.remove('hidden');
            document.getElementById(`tab-${state.step}`).classList.add('step-active');
            
            // UI Toggle
            document.getElementById('btn-prev').style.visibility = state.step > 1 ? 'visible' : 'hidden';
            let nextBtn = document.getElementById('btn-next');
            if(state.step === 1) nextBtn.innerText = "เลือกอาหาร";
            if(state.step === 2) nextBtn.innerText = "ยืนยันการจอง";
            if(state.step === 3) nextBtn.innerText = "ส่งหลักฐานการจอง";
            
            window.scrollTo(0,0);
        }

        async function submit() {
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;
            const slip = document.getElementById('slip-file').files[0];

            if(!name || !phone || !slip) return alert("กรุณากรอกข้อมูลและแนบสลิปให้ครบถ้วน");

            const btn = document.getElementById('btn-next');
            btn.disabled = true;
            btn.innerText = "กำลังส่งข้อมูล...";

            const reader = new FileReader();
            reader.readAsDataURL(slip);
            reader.onload = async () => {
                const payload = {
                    lineId: state.lineId,
                    lineName: state.lineName,
                    name, phone,
                    roomName: state.selectedRoom.name,
                    guests: state.guests,
                    checkin: document.getElementById('checkin').value,
                    checkout: document.getElementById('checkout').value,
                    foodName: state.selectedFood ? state.selectedFood.name : "-",
                    total: state.totalPrice,
                    deposit: state.deposit,
                    slip: reader.result
                };

                try {
                    await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' });
                    document.getElementById('step-3').classList.add('hidden');
                    document.getElementById('nav-footer').classList.add('hidden');
                    document.getElementById('step-indicator').classList.add('hidden');
                    document.getElementById('step-success').classList.remove('hidden');
                } catch (e) {
                    alert("ขออภัย เกิดข้อผิดพลาด กรุณาลองใหม่");
                    btn.disabled = false;
                }
            };
        }

        window.onload = init;
    </script>
</body>
</html>
