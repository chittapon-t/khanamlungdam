<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á | ‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600&display=swap');
        body { font-family: 'Kanit', sans-serif; background-color: #f0f2f5; }
        .stepper-item.active { color: #1a5f7a; border-bottom: 3px solid #1a5f7a; }
        .room-card.selected { border: 2px solid #1a5f7a; background-color: #f0f9ff; }
        .btn-primary { background-color: #1a5f7a; transition: all 0.3s; }
        .btn-primary:hover { background-color: #164e63; transform: translateY(-1px); }
    </style>
</head>
<body class="bg-stone-50 pb-10">

    <!-- Header -->
    <header class="bg-[#1a5f7a] text-white p-6 shadow-lg rounded-b-[2rem] text-center mb-6">
        <h1 class="text-2xl font-bold">‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</h1>
        <p class="text-stone-200 text-sm">‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡∏™‡∏∏‡∏î‡∏ü‡∏¥‡∏ô ‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ ‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡πÇ‡∏≠‡∏ö‡∏•‡πâ‡∏≠‡∏°</p>
    </header>

    <div id="app" class="max-w-md mx-auto px-4">
        
        <!-- Step Indicator -->
        <div class="flex justify-between mb-8 bg-white p-4 rounded-xl shadow-sm overflow-x-auto">
            <div class="stepper-item text-xs font-medium px-2" :class="step === 1 ? 'active' : ''">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</div>
            <div class="stepper-item text-xs font-medium px-2" :class="step === 2 ? 'active' : ''">2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</div>
            <div class="stepper-item text-xs font-medium px-2" :class="step === 3 ? 'active' : ''">3. ‡∏™‡∏£‡∏∏‡∏õ/‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
        </div>

        <!-- Step 1: Select Room & Food -->
        <div v-if="step === 1" class="space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm">
                <label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô - ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå</label>
                <div class="flex gap-2">
                    <input type="date" v-model="booking.checkIn" :min="minDate" class="w-1/2 p-2 border rounded-lg text-sm">
                    <input type="date" v-model="booking.checkOut" :min="booking.checkIn" class="w-1/2 p-2 border rounded-lg text-sm">
                </div>
            </div>

            <h2 class="font-bold text-gray-800 px-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</h2>
            <div v-for="room in roomSettings" :key="room.name" 
                 class="room-card bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center cursor-pointer transition-all"
                 :class="{ 'selected': booking.rooms.includes(room.name) }"
                 @click="toggleRoom(room.name)">
                <div>
                    <p class="font-semibold text-gray-800">{{ room.name }}</p>
                    <p class="text-xs text-stone-500">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î {{ room.max }} ‡∏ó‡πà‡∏≤‡∏ô</p>
                </div>
                <div class="text-right">
                    <p class="text-[#1a5f7a] font-bold text-sm">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏ø{{ getMinPrice(room) }}</p>
                    <i v-if="booking.rooms.includes(room.name)" class="fas fa-check-circle text-blue-500 mt-1"></i>
                </div>
            </div>

            <h2 class="font-bold text-gray-800 px-1">‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</h2>
            <div class="bg-white p-4 rounded-2xl shadow-sm space-y-3">
                <div v-for="food in foodMenu" :key="food.name" class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" v-model="selectedFoods" :value="food.name">
                        <span class="text-sm">{{ food.name }} (‡∏ø{{ food.price }})</span>
                    </div>
                    <input type="number" v-if="selectedFoods.includes(food.name)" v-model="foodQuantities[food.name]" min="1" class="w-12 border rounded p-1 text-center text-xs">
                </div>
            </div>

            <button @click="nextStep" class="w-full btn-primary text-white py-3 rounded-xl font-bold shadow-md">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>

        <!-- Step 2: Customer Info -->
        <div v-if="step === 2" class="space-y-4">
            <div class="bg-white p-6 rounded-2xl shadow-sm space-y-4">
                <div>
                    <label class="text-xs text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</label>
                    <input type="text" v-model="booking.customerName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" class="w-full p-2 border-b focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="text-xs text-gray-500">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <input type="tel" v-model="booking.phone" placeholder="0xx-xxx-xxxx" class="w-full p-2 border-b focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="text-xs text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                    <input type="number" v-model="booking.peopleCount" min="1" class="w-full p-2 border-b">
                </div>
                <div>
                    <label class="text-xs text-gray-500">‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
                    <div class="flex gap-2">
                        <input type="text" v-model="booking.discountCode" class="flex-1 p-2 border-b">
                        <button @click="applyDiscount" class="text-blue-600 text-sm font-bold">‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î</button>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button @click="step = 1" class="w-1/3 bg-gray-200 py-3 rounded-xl font-bold">‡∏Å‡∏•‡∏±‡∏ö</button>
                <button @click="nextStep" class="w-2/3 btn-primary text-white py-3 rounded-xl font-bold shadow-md">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏à‡∏≠‡∏á</button>
            </div>
        </div>

        <!-- Step 3: Payment & Slip -->
        <div v-if="step === 3" class="space-y-4">
            <div class="bg-white p-6 rounded-2xl shadow-md border-t-4 border-blue-900">
                <h3 class="font-bold text-center text-lg mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
                <div class="text-sm space-y-2 border-b pb-4">
                    <div class="flex justify-between"><span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span><span>{{ booking.checkIn }} - {{ booking.checkOut }}</span></div>
                    <div class="flex justify-between"><span>‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</span><span class="text-right">{{ booking.rooms.join(', ') }}</span></div>
                    <div class="flex justify-between"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span><span class="font-bold text-lg">‡∏ø{{ totalPrice.toLocaleString() }}</span></div>
                    <div class="flex justify-between text-red-600 font-bold"><span>‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ({{ depositRate }}%)</span><span>‡∏ø{{ depositAmount.toLocaleString() }}</span></div>
                </div>

                <div class="mt-6 text-center space-y-4">
                    <p class="text-xs text-gray-500">‡πÅ‡∏™‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</p>
                    <img :src="'https://promptpay.io/0615924262/' + depositAmount" class="mx-auto w-48 rounded shadow-sm">
                    <p class="font-bold text-sm">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏≠‡∏•‡∏á‡∏Å‡∏ï ‡∏ó‡∏ß‡∏µ‡∏ú‡πà‡∏≠‡∏á</p>
                    
                    <div class="text-left mt-6">
                        <label class="block text-sm font-bold mb-2">‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</label>
                        <input type="file" @change="handleFileUpload" accept="image/*" class="w-full text-xs">
                    </div>

                    <div class="flex items-center gap-2 mt-4 text-left">
                        <input type="checkbox" v-model="agreed">
                        <label class="text-[10px] text-gray-500">‡∏â‡∏±‡∏ô‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</label>
                    </div>
                </div>
            </div>

            <button @click="submitBooking" :disabled="!agreed || loading" class="w-full btn-primary text-white py-4 rounded-xl font-bold shadow-lg disabled:opacity-50">
                {{ loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á' }}
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp } = Vue;
        const API_URL = "https://script.google.com/macros/s/AKfycbwb9VWt0rQYJ2dJa9jQKM23YRKsx-YReKnqJTiqGRbg26jEMtPP-RzxDbe_BahxUiSu5g/exec"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

        createApp({
            data() {
                return {
                    step: 1,
                    loading: false,
                    agreed: false,
                    minDate: new Date().toISOString().split('T')[0],
                    roomSettings: [],
                    foodMenu: [
                        { name: "‡∏ä‡∏∏‡∏î‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥", price: 390 },
                        { name: "‡∏ä‡∏∏‡∏î‡πÑ‡∏Å‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥", price: 390 },
                        { name: "‡∏ä‡∏∏‡∏î‡∏ä‡∏≤‡∏ö‡∏π‡∏´‡∏°‡∏π‡∏•‡∏∏‡∏á‡∏î‡∏≥", price: 390 },
                        { name: "‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô", price: 390 }
                    ],
                    selectedFoods: [],
                    foodQuantities: {},
                    specialDates: [],
                    booking: {
                        lineId: '', lineName: '', customerName: '', phone: '',
                        rooms: [], peopleCount: 2, foods: [], checkIn: '', checkOut: '',
                        discountCode: '', slipBase64: ''
                    }
                }
            },
            computed: {
                totalPrice() {
                    let roomTotal = 0;
                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á (Logic ‡πÅ‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå)
                    this.booking.rooms.forEach(r => {
                        if(r.includes('‡∏´‡∏ô‡∏≥‡πÇ‡∏õ')) roomTotal += (this.booking.peopleCount > 5 ? 2200 : 1600);
                        else if(r.includes('‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥')) roomTotal += (this.booking.peopleCount > 2 ? 1750 : 1400);
                        else roomTotal += 1000; // default fallback
                    });

                    let foodTotal = 0;
                    this.selectedFoods.forEach(f => {
                        const menu = this.foodMenu.find(m => m.name === f);
                        foodTotal += menu.price * (this.foodQuantities[f] || 1);
                    });
                    return roomTotal + foodTotal;
                },
                depositRate() {
                    // Check special dates
                    const isSpecial = this.specialDates.some(d => d.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà === this.formatDate(this.booking.checkIn));
                    return isSpecial ? 100 : 50;
                },
                depositAmount() {
                    return (this.totalPrice * this.depositRate) / 100;
                }
            },
            async mounted() {
                await this.initLiff();
                this.fetchSettings();
            },
            methods: {
                async initLiff() {
                    try {
                        await liff.init({ liffId: "2008863563-tuai5kaC" });
                        if (!liff.isLoggedIn()) liff.login();
                        const profile = await liff.getProfile();
                        this.booking.lineId = profile.userId;
                        this.booking.lineName = profile.displayName;
                    } catch (e) { console.error("LIFF Init Error", e); }
                },
                async fetchSettings() {
                    const res = await fetch(API_URL + "?action=getRooms");
                    this.roomSettings = await res.json();
                    const resSpec = await fetch(API_URL + "?action=getSpecialDates");
                    this.specialDates = await resSpec.json();
                },
                toggleRoom(name) {
                    const index = this.booking.rooms.indexOf(name);
                    if (index > -1) this.booking.rooms.splice(index, 1);
                    else this.booking.rooms.push(name);
                },
                getMinPrice(room) {
                    return Object.values(room.prices)[0];
                },
                formatDate(dateStr) {
                    if(!dateStr) return "";
                    const d = new Date(dateStr);
                    return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth()+1).padStart(2, '0')}/${d.getFullYear()}`;
                },
                handleFileUpload(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => { this.booking.slipBase64 = event.target.result; };
                    reader.readAsDataURL(file);
                },
                async nextStep() {
                    if (this.step === 1 && this.booking.rooms.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å");
                    if (this.step === 1 && (!this.booking.checkIn || !this.booking.checkOut)) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å");
                    this.step++;
                },
                async submitBooking() {
                    if(!this.booking.slipBase64) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");
                    this.loading = true;
                    
                    const payload = {
                        action: 'createBooking',
                        ...this.booking,
                        checkIn: this.formatDate(this.booking.checkIn),
                        checkOut: this.formatDate(this.booking.checkOut),
                        foods: this.selectedFoods,
                        foodCount: JSON.stringify(this.foodQuantities),
                        amount: this.totalPrice,
                        totalPrice: this.totalPrice,
                        deposit: this.depositAmount,
                        balance: this.totalPrice - this.depositAmount
                    };

                    try {
                        const res = await fetch(API_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        const result = await res.json();
                        if(result.status === 'success') {
                            liff.sendMessages([{
                                type: 'text',
                                text: `üìå ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: ${result.bookingId}\n‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å: ${this.booking.rooms.join(', ')}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${payload.checkIn}\n‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏•‡∏¥‡∏õ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 30 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö`
                            }]).then(() => liff.closeWindow());
                        }
                    } catch (e) {
                        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
