<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .stepper-active { color: #059669; border-bottom: 3px solid #059669; transition: all 0.3s ease; }
        .card-selected { border: 3px solid #047857; background-color: #065f46 !important; color: white !important; transform: scale(1.02); }
        .card-disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; pointer-events: none; position: relative; }
        .card-disabled::after { content: "‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß"; position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; padding: 2px 8px; border-radius: 8px; font-size: 10px; font-weight: bold; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="pb-24">

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-black/70 z-50 flex flex-col items-center justify-center text-white hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-emerald-500 mb-4"></div>
        <p id="loadingText" class="font-medium text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
    </div>

    <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative">
        
        <!-- Header -->
        <div class="bg-emerald-900 text-white p-6 rounded-b-[2.5rem] shadow-lg">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</h1>
                    <p class="text-emerald-200 text-xs">‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å)</p>
                </div>
                <div id="userProfile" class="flex flex-col items-center">
                    <img id="userImg" src="https://via.placeholder.com/40" class="w-10 h-10 rounded-full border-2 border-emerald-400">
                    <span id="userName" class="text-[10px] mt-1 text-emerald-100 font-light">Guest</span>
                </div>
            </div>
        </div>

        <!-- Stepper -->
        <div class="flex justify-around bg-white/95 backdrop-blur-sm p-4 sticky top-0 z-10 border-b shadow-sm">
            <div id="step1-btn" class="flex flex-col items-center text-xs stepper-active w-1/4">
                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center mb-1 font-bold">1</div>
                <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
            </div>
            <div id="step2-btn" class="flex flex-col items-center text-xs text-gray-400 w-1/4">
                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center mb-1 font-bold">2</div>
                <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</span>
            </div>
            <div id="step3-btn" class="flex flex-col items-center text-xs text-gray-400 w-1/4">
                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center mb-1 font-bold">3</div>
                <span>‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
            </div>
            <div id="step4-btn" class="flex flex-col items-center text-xs text-gray-400 w-1/4">
                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center mb-1 font-bold">4</div>
                <span>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>
            </div>
        </div>

        <div class="p-5">
            <!-- STEP 1: Date -->
            <div id="step1" class="space-y-5 animate-fade-in">
                <div class="flex items-center gap-2">
                    <div class="w-1.5 h-6 bg-emerald-600 rounded-full"></div>
                    <h2 class="text-lg font-bold text-gray-800">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</h2>
                </div>
                
                <div class="grid grid-cols-1 gap-4">
                    <div class="bg-gray-50 p-4 rounded-2xl border-2 border-gray-100 focus-within:border-emerald-500 transition-all">
                        <label class="block text-xs text-gray-400 mb-1 font-semibold uppercase tracking-wider">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (Check-in)</label>
                        <input type="date" id="checkin" onchange="checkAvailability()" class="w-full bg-transparent font-bold text-lg outline-none text-emerald-900">
                    </div>
                    <div class="bg-gray-50 p-4 rounded-2xl border-2 border-gray-100 focus-within:border-emerald-500 transition-all">
                        <label class="block text-xs text-gray-400 mb-1 font-semibold uppercase tracking-wider">‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå (Check-out)</label>
                        <input type="date" id="checkout" onchange="checkAvailability()" class="w-full bg-transparent font-bold text-lg outline-none text-emerald-900">
                    </div>
                </div>
            </div>

            <!-- STEP 2: Rooms -->
            <div id="step2" class="hidden space-y-4 animate-fade-in">
                <div class="flex items-center gap-2">
                    <div class="w-1.5 h-6 bg-emerald-600 rounded-full"></div>
                    <h2 class="text-lg font-bold text-gray-800">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</h2>
                </div>
                <div id="roomList" class="space-y-4"></div>
            </div>

            <!-- STEP 3: Foods -->
            <div id="step3" class="hidden space-y-4 animate-fade-in">
                <div class="flex items-center gap-2">
                    <div class="w-1.5 h-6 bg-emerald-600 rounded-full"></div>
                    <h2 class="text-lg font-bold text-gray-800">3. ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h2>
                </div>
                <div id="foodList" class="space-y-3"></div>
            </div>

            <!-- STEP 4: Checkout -->
            <div id="step4" class="hidden space-y-6 animate-fade-in">
                <div class="flex items-center gap-2">
                    <div class="w-1.5 h-6 bg-emerald-600 rounded-full"></div>
                    <h2 class="text-lg font-bold text-gray-800">4. ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
                </div>

                <!-- Promo Code -->
                <div class="flex gap-2">
                    <input type="text" id="promoInput" placeholder="‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="flex-1 p-3 border rounded-xl outline-none focus:border-emerald-500 text-sm">
                    <button onclick="applyPromo()" class="px-6 py-3 bg-gray-800 text-white rounded-xl text-sm font-bold">‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î</button>
                </div>
                <div id="promoMsg" class="text-xs -mt-4 hidden"></div>

                <div class="bg-emerald-900 text-white p-6 rounded-[2rem] shadow-xl">
                    <p class="text-[10px] text-emerald-300 uppercase font-bold mb-1">Summary</p>
                    <p id="summaryDates" class="text-sm font-medium mb-4"></p>
                    <div id="summaryItems" class="space-y-2 text-xs mb-4"></div>
                    <div id="discountRow" class="hidden flex justify-between text-emerald-400 text-xs mb-2">
                        <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</span>
                        <span id="summaryDiscount">-‡∏ø0</span>
                    </div>
                    <div class="border-t border-emerald-800 pt-3 flex justify-between items-end">
                        <span class="text-sm">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span>
                        <span id="summaryTotal" class="text-2xl font-bold text-emerald-400">‡∏ø0</span>
                    </div>
                </div>

                <div class="space-y-3">
                    <input type="text" id="custName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" class="w-full p-4 bg-gray-50 border rounded-2xl outline-none">
                    <input type="tel" id="custTel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full p-4 bg-gray-50 border rounded-2xl outline-none">
                </div>

                <div class="bg-amber-50 p-6 rounded-[2rem] border border-amber-100 text-center">
                    <p class="text-xs font-bold text-amber-800 mb-1">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
                    <p class="text-[10px] text-amber-600 mb-2">(‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å 50% + ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 100%)</p>
                    <div id="depositAmount" class="text-3xl font-bold text-amber-900 mb-4">‡∏ø0</div>
                    <img id="qrCodeImg" class="w-40 h-40 mx-auto bg-white p-2 rounded-xl border">
                </div>

                <div>
                    <input type="file" id="slipFile" accept="image/*" class="hidden">
                    <label for="slipFile" id="slipLabel" class="w-full py-10 border-2 border-dashed border-emerald-600 rounded-[2rem] bg-emerald-50 flex flex-col items-center">
                        <span class="text-2xl">üìé</span>
                        <span class="font-bold text-emerald-800">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span>
                    </label>
                    <div id="slipPreviewContainer" class="hidden relative">
                        <img id="slipPreview" class="w-full rounded-[2rem] border shadow-lg">
                        <button onclick="resetSlip()" class="absolute -top-2 -right-2 bg-red-500 text-white w-8 h-8 rounded-full font-bold">√ó</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto p-4 bg-white/90 border-t flex gap-3 z-30">
            <button id="prevBtn" onclick="prevStep()" class="flex-1 py-4 border-2 border-emerald-900 text-emerald-900 rounded-2xl font-bold hidden">‡∏Å‡∏•‡∏±‡∏ö</button>
            <button id="nextBtn" onclick="nextStep()" class="flex-[2] py-4 bg-emerald-900 text-white rounded-2xl font-bold">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
    </div>

    <script>
        const LIFF_ID = '2008863563-tuai5kaC';
        const APP_URL = 'https://script.google.com/macros/s/AKfycbwb9VWt0rQYJ2dJa9jQKM23YRKsx-YReKnqJTiqGRbg26jEMtPP-RzxDbe_BahxUiSu5g/exec';
        
        const roomData = [
            { id: 'h1', name: '‡πÇ‡∏Æ‡∏°‡∏™‡πÄ‡∏ï‡∏¢‡πå‡∏´‡∏ô‡∏≥‡πÇ‡∏õ', min: 4, max: 8, rates: { '4-5': 1600, '6-8': 2200 }, img: 'https://images.unsplash.com/photo-1587061949733-76243032c390?w=400' },
            { id: 'b1', name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ 1', min: 1, max: 3, rates: { '1-2': 1400, '3': 1750 }, img: 'https://images.unsplash.com/photo-1542718610-a1d656d1884c?w=400' },
            { id: 'b2', name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ 2', min: 1, max: 3, rates: { '1-2': 1400, '3': 1750 }, img: 'https://images.unsplash.com/photo-1542718610-a1d656d1884c?w=400' },
            { id: 't1', name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏° 1', min: 1, max: 4, rates: { '1-2': 1200, '3-4': 1550 }, img: 'https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?w=400' },
            { id: 't2', name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏° 2', min: 1, max: 4, rates: { '1-2': 1200, '3-4': 1550 }, img: 'https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?w=400' },
            { id: 'k1', name: '‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏ô‡∏≤‡∏° K1', min: 1, max: 2, rates: { '1-2': 700 }, img: 'https://images.unsplash.com/photo-1533167649158-6d508895b680?w=400' },
            { id: 'k2', name: '‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏ô‡∏≤‡∏° K2', min: 1, max: 2, rates: { '1-2': 700 }, img: 'https://images.unsplash.com/photo-1533167649158-6d508895b680?w=400' },
            { id: 'tent', name: '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå (‡∏ô‡∏≥‡∏°‡∏≤‡πÄ‡∏≠‡∏á)', min: 1, max: 20, rates: { 'per_person': 150 }, img: 'https://images.unsplash.com/photo-1523987355523-c7b5b0dd90a7?w=400' }
        ];

        const foodData = [
            { id: 'f1', name: '‡∏ä‡∏∏‡∏î‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'f2', name: '‡∏ä‡∏∏‡∏î‡πÑ‡∏Å‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'f3', name: '‡∏ä‡∏∏‡∏î‡∏´‡∏°‡∏π‡∏ä‡∏≤‡∏ö‡∏π‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'f4', name: '‡∏ä‡∏∏‡∏î‡πÑ‡∏Å‡πà‡∏ä‡∏≤‡∏ö‡∏π‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'f5', name: '‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', price: 390 }
        ];

        let state = {
            step: 1,
            checkin: '', checkout: '',
            userId: '', lineName: '',
            selectedRooms: [],
            selectedFoods: [],
            total: 0, deposit: 0,
            allBookings: [], 
            promoCodes: [],
            activePromo: null,
            roomDiscountAmount: 0
        };

        async function init() {
            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const p = await liff.getProfile();
                    state.userId = p.userId;
                    state.lineName = p.displayName;
                    document.getElementById('userImg').src = p.pictureUrl;
                    document.getElementById('userName').innerText = p.displayName;
                } else { liff.login(); }
            } catch (e) { console.error(e); }

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏≤‡∏ó‡∏≥‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡∏à‡∏≠‡∏á‡∏ã‡πâ‡∏≠‡∏ô
            try {
                const res = await fetch(APP_URL);
                const data = await res.json();
                state.allBookings = data.bookings || [];
                state.promoCodes = data.promoCodes || [];
            } catch (e) { console.error("Fetch Data Error:", e); }

            const today = new Date();
            const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
            const after = new Date(today); after.setDate(today.getDate() + 2);
            
            document.getElementById('checkin').min = tomorrow.toISOString().split('T')[0];
            document.getElementById('checkin').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('checkout').value = after.toISOString().split('T')[0];
            
            checkAvailability();
            renderFoods();
            hideLoading();
        }

        // ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡∏à‡∏≠‡∏á‡∏ã‡πâ‡∏≠‡∏ô
        function checkAvailability() {
            const cin = document.getElementById('checkin').value;
            const cout = document.getElementById('checkout').value;
            if(!cin || !cout) return;

            const selectedCheckin = new Date(cin);
            const selectedCheckout = new Date(cout);

            state.bookedRoomIds = state.allBookings
                .filter(b => {
                    if (b.Status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') return false;
                    const bIn = new Date(b.CheckIn);
                    const bOut = new Date(b.CheckOut);
                    // Check Overlap
                    return (selectedCheckin < bOut && selectedCheckout > bIn);
                })
                .flatMap(b => b.RoomsInfo.split(',').map(s => s.trim()));
            
            if(state.step === 2) renderRooms();
        }

        function updateUI() {
            window.scrollTo(0,0);
            for(let i=1; i<=4; i++) {
                document.getElementById(`step${i}-btn`).className = `flex flex-col items-center text-xs w-1/4 ${state.step === i ? 'stepper-active' : 'text-gray-400'}`;
                document.getElementById(`step${i}`).classList.toggle('hidden', state.step !== i);
            }
            document.getElementById('prevBtn').classList.toggle('hidden', state.step === 1);
            document.getElementById('nextBtn').innerText = state.step === 4 ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≠‡∏á' : '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ';
            if(state.step === 2) renderRooms();
            if(state.step === 4) renderSummary();
        }

        function nextStep() {
            if(state.step === 1) {
                const cin = document.getElementById('checkin').value;
                const cout = document.getElementById('checkout').value;
                if(!cin || !cout) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");
                if(new Date(cout) <= new Date(cin)) return alert("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô");
                state.checkin = cin; state.checkout = cout;
                checkAvailability();
            }
            if(state.step === 2 && state.selectedRooms.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á");
            if(state.step === 4) return submitBooking();
            state.step++;
            updateUI();
        }

        function prevStep() { state.step--; updateUI(); }

        function renderRooms() {
            const list = document.getElementById('roomList');
            list.innerHTML = roomData.map(r => {
                const sel = state.selectedRooms.find(s => s.id === r.id);
                const isBooked = state.bookedRoomIds && state.bookedRoomIds.includes(r.name);
                
                return `
                    <div class="p-4 rounded-3xl border-2 ${isBooked ? 'card-disabled' : (sel ? 'card-selected' : 'bg-gray-50 border-gray-100')}">
                        <div class="flex items-center gap-4">
                            <img src="${r.img}" class="w-16 h-16 rounded-xl object-cover">
                            <div class="flex-1">
                                <p class="font-bold text-sm">${r.name}</p>
                                <p class="text-[10px] opacity-70 uppercase">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${r.max} ‡∏ó‡πà‡∏≤‡∏ô</p>
                            </div>
                            <button onclick="toggleRoom('${r.id}')" ${isBooked ? 'disabled' : ''} class="px-4 py-2 rounded-xl text-xs font-bold ${sel ? 'bg-white text-emerald-900' : 'bg-emerald-800 text-white'}">
                                ${isBooked ? '‡πÄ‡∏ï‡πá‡∏°' : (sel ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å')}
                            </button>
                        </div>
                        ${sel ? `
                            <div class="mt-3 pt-3 border-t border-white/20 flex justify-between items-center">
                                <span class="text-xs">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å:</span>
                                <div class="flex items-center gap-3">
                                    <button onclick="updateGuests('${r.id}',-1)" class="w-8 h-8 rounded-full bg-white/20">-</button>
                                    <span class="font-bold">${sel.guests}</span>
                                    <button onclick="updateGuests('${r.id}',1)" class="w-8 h-8 rounded-full bg-white/20">+</button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleRoom(id) {
            const idx = state.selectedRooms.findIndex(s => s.id === id);
            if(idx > -1) state.selectedRooms.splice(idx,1);
            else {
                const r = roomData.find(x => x.id === id);
                state.selectedRooms.push({ id: r.id, name: r.name, guests: r.min });
            }
            renderRooms();
        }

        function updateGuests(id, d) {
            const r = roomData.find(x => x.id === id);
            const sel = state.selectedRooms.find(s => s.id === id);
            const v = sel.guests + d;
            if(v >= r.min && v <= r.max) { sel.guests = v; renderRooms(); }
        }

        function renderFoods() {
            document.getElementById('foodList').innerHTML = foodData.map(f => {
                const sel = state.selectedFoods.find(s => s.id === f.id);
                return `
                    <div class="bg-white p-4 rounded-2xl border flex items-center justify-between shadow-sm">
                        <div>
                            <p class="text-sm font-bold">${f.name}</p>
                            <p class="text-emerald-600 text-xs font-semibold">‡∏ø${f.price}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="updateFood('${f.id}',-1)" class="w-8 h-8 rounded-full border border-gray-200 flex items-center justify-center">-</button>
                            <span class="font-bold text-sm w-4 text-center">${sel ? sel.qty : 0}</span>
                            <button onclick="updateFood('${f.id}',1)" class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-900 flex items-center justify-center font-bold">+</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateFood(id, d) {
            const idx = state.selectedFoods.findIndex(s => s.id === id);
            if(idx > -1) {
                state.selectedFoods[idx].qty += d;
                if(state.selectedFoods[idx].qty <= 0) state.selectedFoods.splice(idx,1);
            } else if(d > 0) {
                state.selectedFoods.push({ ...foodData.find(x => x.id === id), qty: 1 });
            }
            renderFoods();
        }

        // ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
        function applyPromo() {
            const code = document.getElementById('promoInput').value.trim().toUpperCase();
            const msg = document.getElementById('promoMsg');
            msg.classList.remove('hidden');
            
            const promo = state.promoCodes.find(p => p.Code === code);
            if(!promo) {
                msg.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ô‡∏µ‡πâ";
                msg.className = "text-xs -mt-4 text-red-500 font-bold";
                state.activePromo = null;
            } else {
                msg.innerText = `‚úÖ ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å ${promo.Value}${promo.Type === 'percent' ? '%' : ' ‡∏ö‡∏≤‡∏ó'}`;
                msg.className = "text-xs -mt-4 text-emerald-600 font-bold";
                state.activePromo = promo;
            }
            renderSummary();
        }

        function renderSummary() {
            const nights = Math.max(1, (new Date(state.checkout) - new Date(state.checkin)) / 86400000);
            let roomTotal = 0;
            let foodTotal = 0;
            let html = '';

            state.selectedRooms.forEach(s => {
                const r = roomData.find(x => x.id === s.id);
                let p = 0;
                if(r.id === 'tent') p = r.rates.per_person * s.guests;
                else {
                    for(let k in r.rates) {
                        const [min, max] = k.split('-').map(Number);
                        if(s.guests >= min && (!max || s.guests <= max)) { p = r.rates[k]; break; }
                    }
                }
                const sub = p * nights; 
                roomTotal += sub;
                html += `<div class="flex justify-between"><span>üè† ${s.name} x ${nights} ‡∏Ñ‡∏∑‡∏ô</span><span>‡∏ø${sub.toLocaleString()}</span></div>`;
            });

            state.selectedFoods.forEach(f => {
                const sub = f.price * f.qty; 
                foodTotal += sub;
                html += `<div class="flex justify-between"><span>üç¥ ${f.name} x ${f.qty}</span><span>‡∏ø${sub.toLocaleString()}</span></div>`;
            });

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å)
            let discount = 0;
            if (state.activePromo) {
                if (state.activePromo.Type === 'fixed') discount = state.activePromo.Value;
                else discount = (roomTotal * state.activePromo.Value) / 100;
            }
            state.roomDiscountAmount = Math.min(discount, roomTotal);

            const finalRoomTotal = roomTotal - state.roomDiscountAmount;
            state.total = finalRoomTotal + foodTotal;
            
            // ‡∏°‡∏±‡∏î‡∏à‡∏≥ 50% ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å (‡∏´‡∏•‡∏±‡∏á‡∏•‡∏î) + ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 100%
            state.deposit = Math.ceil(finalRoomTotal * 0.5) + foodTotal;

            document.getElementById('summaryDates').innerText = `${state.checkin} ‡∏ñ‡∏∂‡∏á ${state.checkout}`;
            document.getElementById('summaryItems').innerHTML = html;
            
            const discRow = document.getElementById('discountRow');
            if(state.roomDiscountAmount > 0) {
                discRow.classList.remove('hidden');
                document.getElementById('summaryDiscount').innerText = `-‡∏ø${state.roomDiscountAmount.toLocaleString()}`;
            } else {
                discRow.classList.add('hidden');
            }

            document.getElementById('summaryTotal').innerText = `‡∏ø${state.total.toLocaleString()}`;
            document.getElementById('depositAmount').innerText = `‡∏ø${state.deposit.toLocaleString()}`;
            document.getElementById('qrCodeImg').src = `https://promptpay.io/0615924262/${state.deposit}.png`;
        }

        document.getElementById('slipFile').onchange = e => {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = ev => {
                document.getElementById('slipPreview').src = ev.target.result;
                document.getElementById('slipPreviewContainer').classList.remove('hidden');
                document.getElementById('slipLabel').classList.add('hidden');
            };
            r.readAsDataURL(f);
        };
        function resetSlip() {
            document.getElementById('slipFile').value = '';
            document.getElementById('slipPreviewContainer').classList.add('hidden');
            document.getElementById('slipLabel').classList.remove('hidden');
        }

        async function submitBooking() {
            const n = document.getElementById('custName').value.trim();
            const t = document.getElementById('custTel').value.trim();
            const s = document.getElementById('slipFile').files[0];
            if(!n || t.length < 9 || !s) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ");
            
            // Re-check availability before submitting to prevent race conditions
            showLoading("‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...");
            try {
                const resCheck = await fetch(APP_URL);
                const dataCheck = await resCheck.json();
                const currentBooked = dataCheck.bookings
                    .filter(b => b.Status !== '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' && (new Date(state.checkin) < new Date(b.CheckOut) && new Date(state.checkout) > new Date(b.CheckIn)))
                    .flatMap(b => b.RoomsInfo.split(',').map(s => s.trim()));
                
                const isConflict = state.selectedRooms.some(r => currentBooked.includes(r.name));
                if(isConflict) {
                    hideLoading();
                    return alert("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢! ‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
                }
            } catch (e) {}

            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á...");
            const r = new FileReader();
            r.readAsDataURL(s);
            r.onload = async () => {
                try {
                    const res = await fetch(APP_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            userId: state.userId, lineName: state.lineName,
                            custName: n, custTel: t,
                            checkin: state.checkin, checkout: state.checkout,
                            rooms: JSON.stringify(state.selectedRooms),
                            foods: JSON.stringify(state.selectedFoods),
                            promoCode: state.activePromo ? state.activePromo.Code : '',
                            discount: state.roomDiscountAmount,
                            total: state.total, deposit: state.deposit,
                            slip: r.result
                        })
                    });
                    const json = await res.json();
                    if(json.status === 'success') {
                        alert("‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ");
                        liff.closeWindow();
                    } else alert(json.message);
                } catch (e) { alert("‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"); }
                finally { hideLoading(); }
            };
        }

        function showLoading(t) { document.getElementById('loadingText').innerText = t; document.getElementById('loading').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading').classList.add('hidden'); }
        window.onload = init;
    </script>
</body>
</html>
