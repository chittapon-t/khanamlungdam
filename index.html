<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å - ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #F3F4F6; }
        .camp-theme { background-color: #2C3E50; color: #ECF0F1; }
        .btn-primary { background-color: #27ae60; color: white; }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <!-- Loading Overlay with Status -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg flex flex-col items-center max-w-xs text-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <p id="loadingText" class="font-bold text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</p>
            <p id="loadingDetail" class="text-xs text-gray-500 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-green-900 text-white p-4 shadow-lg sticky top-0 z-40">
        <h1 class="text-xl font-bold text-center">üèïÔ∏è ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</h1>
        <p class="text-center text-xs text-green-200">‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á</p>
    </header>

    <div class="max-w-md mx-auto p-4 pb-24">
        
        <!-- Step 1: User Info & Date -->
        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <h2 class="text-lg font-bold mb-3 border-b pb-2 text-green-800">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</h2>
            <div class="space-y-3">
                <div class="flex items-center gap-2 mb-2">
                    <img id="userThumb" src="" class="w-10 h-10 rounded-full bg-gray-200">
                    <div>
                        <p class="text-sm text-gray-500">‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (LINE)</p>
                        <p id="userName" class="font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-xs text-gray-500">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</label>
                        <input type="date" id="checkInDate" class="w-full border rounded p-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå</label>
                        <input type="date" id="checkOutDate" class="w-full border rounded p-2 focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>
                <p id="dateWarning" class="text-red-500 text-xs hidden">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</p>
            </div>
        </div>

        <!-- Step 2: Select Room -->
        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <h2 class="text-lg font-bold mb-3 border-b pb-2 text-green-800">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</h2>
            <div id="roomList" class="space-y-4">
                <p class="text-center text-gray-400 py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å...</p>
            </div>
        </div>

        <!-- Step 3: Select Food -->
        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <h2 class="text-lg font-bold mb-3 border-b pb-2 text-green-800">3. ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</h2>
            <div id="foodList" class="space-y-2">
                <!-- Food Items Generated by JS -->
            </div>
        </div>

        <!-- Step 4: Contact & Summary -->
        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <h2 class="text-lg font-bold mb-3 border-b pb-2 text-green-800">4. ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
            <div class="space-y-3">
                <input type="text" id="bookerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠)" class="w-full border rounded p-2">
                <input type="tel" id="bookerPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full border rounded p-2">
                <div class="flex gap-2">
                    <input type="text" id="discountCode" placeholder="‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" class="w-full border rounded p-2 uppercase">
                    <button onclick="applyDiscount()" class="bg-gray-200 px-4 rounded text-sm hover:bg-gray-300">‡πÉ‡∏ä‡πâ</button>
                </div>
                
                <div class="bg-gray-50 p-3 rounded text-sm space-y-1">
                    <div class="flex justify-between"><span>‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</span><span id="sumRoomPrice">0</span></div>
                    <div class="flex justify-between"><span>‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span><span id="sumFoodPrice">0</span></div>
                    <div class="flex justify-between text-green-600"><span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span><span id="sumDiscount">0</span></div>
                    <div class="flex justify-between font-bold text-lg border-t pt-1"><span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</span><span id="sumTotal">0</span></div>
                    <div class="flex justify-between text-blue-600 font-bold"><span>‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞ (<span id="depositPercent">50</span>%)</span><span id="sumDeposit">0</span></div>
                </div>

                <!-- Payment -->
                <div class="text-center mt-4">
                    <p class="text-sm font-bold text-blue-800">‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏à‡∏≥</p>
                    <p class="text-xs text-gray-500 mb-2">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå: 061-592-4262 (‡∏≠‡∏•‡∏á‡∏Å‡∏ï ‡∏ó‡∏ß‡∏µ‡∏ú‡πà‡∏≠‡∏á)</p>
                    <img id="qrImage" src="https://promptpay.io/0615924262/0" class="w-48 mx-auto border p-2 rounded mb-2">
                    
                    <label class="block text-left text-sm font-bold mb-1">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <input type="file" id="slipFile" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                </div>

                <div class="flex items-start gap-2 mt-4">
                    <input type="checkbox" id="terms" class="mt-1">
                    <label for="terms" class="text-xs text-gray-600">‡∏â‡∏±‡∏ô‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥, ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô 7 ‡∏ß‡∏±‡∏ô)</label>
                </div>
            </div>
        </div>

        <button onclick="submitBooking()" class="w-full bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-green-800 transition fixed bottom-4 left-4 right-4 max-w-md mx-auto z-50">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
        </button>

    </div>

    <script>
        // --- CONFIG ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbwb9VWt0rQYJ2dJa9jQKM23YRKsx-YReKnqJTiqGRbg26jEMtPP-RzxDbe_BahxUiSu5g/exec'; 
        const LIFF_ID = '2008863563-tuai5kaC';

        // --- DATA MODELS ---
        const roomsData = [
            { id: 'R1', name: '‡πÇ‡∏Æ‡∏°‡∏™‡πÄ‡∏ï‡∏¢‡πå‡∏´‡∏ô‡∏≥‡πÇ‡∏õ', type: 'house', priceRules: [{max:5, p:1600}, {max:8, p:2200}], desc: '‡∏û‡∏±‡∏Å‡πÑ‡∏î‡πâ 4-8 ‡∏Ñ‡∏ô' },
            { id: 'R2', name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ 1', type: 'house', priceRules: [{max:2, p:1400}, {max:3, p:1750}], desc: '‡∏ü‡∏£‡∏µ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤' },
            { id: 'R3', name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ 2', type: 'house', priceRules: [{max:2, p:1400}, {max:3, p:1750}], desc: '‡∏ü‡∏£‡∏µ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤' },
            { id: 'R4', name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏° 1', type: 'tent', priceRules: [{max:2, p:1200}, {max:4, p:1550}], desc: '‡∏ü‡∏£‡∏µ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤' },
            { id: 'R5', name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏° 2', type: 'tent', priceRules: [{max:2, p:1200}, {max:4, p:1550}], desc: '‡∏ü‡∏£‡∏µ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤' },
            { id: 'K1', name: '‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏ô‡∏≤‡∏° K1', type: 'tent_rent', priceRules: [{max:2, p:700}], desc: '‡∏ü‡∏£‡∏µ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤' },
            { id: 'K2', name: '‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏ô‡∏≤‡∏° K2', type: 'tent_rent', priceRules: [{max:2, p:700}], desc: '‡∏ü‡∏£‡∏µ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤' },
            { id: 'CAMP', name: '‡∏•‡∏≤‡∏ô‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå', type: 'camp', pricePerHead: 150, maxTotal: 20, desc: '‡∏ô‡∏≥‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏°‡∏≤‡πÄ‡∏≠‡∏á' }
        ];

        const foodData = [
            { id: 'F1', name: '‡∏ä‡∏∏‡∏î‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'F2', name: '‡∏ä‡∏∏‡∏î‡πÑ‡∏Å‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'F3', name: '‡∏ä‡∏∏‡∏î‡∏ä‡∏≤‡∏ö‡∏π‡∏´‡∏°‡∏π‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'F4', name: '‡∏ä‡∏∏‡∏î‡∏ä‡∏≤‡∏ö‡∏π‡πÑ‡∏Å‡πà‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390 },
            { id: 'F5', name: '‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', price: 390 }
        ];

        let state = {
            lineProfile: null,
            bookings: [],
            specialDays: [],
            closedDays: [],
            selectedRooms: {},
            selectedFood: {},
            discount: 0
        };

        // --- INIT ---
        async function main() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...');
            
            try {
                // 1. Init LIFF (Real)
                await initLiff();

                // 2. Fetch Data with Timeout
                showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å...');
                await fetchData();

                // 3. Render
                renderRooms();
                renderFood();
                setupDatePickers();

                showLoading(false);
            } catch (e) {
                showLoading(false);
                console.error(e);
                
                let msg = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ';
                let detail = e.message;

                if (e.message.includes('Unexpected token')) {
                    msg = '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò';
                    detail = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Deploy GAS ‡πÄ‡∏õ‡πá‡∏ô "Anyone" (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)';
                } else if (e.message.includes('Failed to fetch')) {
                    msg = '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á';
                    detail = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡∏´‡∏£‡∏∑‡∏≠ URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                }

                Swal.fire({
                    icon: 'error',
                    title: msg,
                    text: detail,
                    footer: '<a href="#" onclick="location.reload()">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</a>'
                });
            }
        }

        async function initLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    state.lineProfile = profile;
                    document.getElementById('userThumb').src = profile.pictureUrl;
                    document.getElementById('userName').innerText = profile.displayName;
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error("LIFF Init failed", err);
                throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE LIFF ‡πÑ‡∏î‡πâ: " + err.message);
            }
        }

        async function fetchData() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);

            try {
                const res = await fetch(API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'get_initial_data' }),
                    mode: 'cors',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!res.ok) throw new Error(`Server Error: ${res.status}`);

                const text = await res.text();
                
                if (text.trim().startsWith('<')) {
                    throw new Error('‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Unexpected HTML). ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Deploy GAS ‡πÄ‡∏õ‡πá‡∏ô "Anyone"');
                }

                const json = JSON.parse(text);

                if(json.status === 'success') {
                    const s = json.data;
                    state.bookings = s.bookings || [];
                    
                    if (s.settings) {
                        s.settings.forEach(item => {
                            if(item.type === 'SPECIAL_DAY') state.specialDays.push({date: item.key, val: item.value});
                            if(item.type === 'CLOSED_DAY') state.closedDays.push(item.key);
                        });
                    }
                } else {
                    throw new Error(json.message || 'API Error');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (Timeout)');
                }
                throw error;
            }
        }

        // --- RENDER UI ---
        function renderRooms() {
            const container = document.getElementById('roomList');
            if (!container) return;
            container.innerHTML = roomsData.map(r => `
                <div class="border rounded p-3 flex justify-between items-center ${r.id === 'CAMP' ? 'bg-orange-50' : ''}">
                    <div class="flex-1">
                        <div class="font-bold text-green-900">${r.name}</div>
                        <div class="text-xs text-gray-500">${r.desc}</div>
                        ${renderPriceInfo(r)}
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" min="0" max="20" placeholder="${r.id === 'CAMP' ? '‡∏Ñ‡∏ô' : '‡∏Ñ‡∏ô'}" 
                               class="w-16 border rounded p-1 text-center text-sm room-pax-input" 
                               data-id="${r.id}" onchange="updateSelection('${r.id}', this.value)">
                        <span class="text-xs text-gray-500">${r.id === 'CAMP' ? '‡∏ó‡πà‡∏≤‡∏ô' : '‡∏Ñ‡∏ô'}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderPriceInfo(room) {
            if(room.type === 'camp') return `<div class="text-xs text-blue-600">${room.pricePerHead} ‡∏ö./‡∏Ñ‡∏ô</div>`;
            return room.priceRules.map(p => `<div class="text-xs text-blue-600">‡∏û‡∏±‡∏Å ${p.max} ‡∏Ñ‡∏ô = ${p.p} ‡∏ö.</div>`).join('');
        }

        function renderFood() {
            const container = document.getElementById('foodList');
            if(!container) return;
            container.innerHTML = foodData.map(f => `
                <div class="flex justify-between items-center border-b pb-2 last:border-0">
                    <div>
                        <div class="text-sm font-bold text-gray-700">${f.name}</div>
                        <div class="text-xs text-gray-500">${f.price} ‡∏ö‡∏≤‡∏ó</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateFood('${f.id}', -1)" class="w-6 h-6 bg-gray-200 rounded">-</button>
                        <span id="qty-${f.id}" class="text-sm font-bold w-4 text-center">0</span>
                        <button onclick="updateFood('${f.id}', 1)" class="w-6 h-6 bg-green-200 rounded">+</button>
                    </div>
                </div>
            `).join('');
        }

        // --- LOGIC ---
        function setupDatePickers() {
            const today = new Date().toISOString().split('T')[0];
            const inEl = document.getElementById('checkInDate');
            const outEl = document.getElementById('checkOutDate');
            inEl.min = today;
            outEl.min = today;

            inEl.addEventListener('change', () => {
                const d = new Date(inEl.value);
                d.setDate(d.getDate() + 1);
                outEl.value = d.toISOString().split('T')[0];
                outEl.min = outEl.value;
                calculateTotal();
            });
            outEl.addEventListener('change', calculateTotal);
        }

        function updateSelection(roomId, pax) {
            pax = parseInt(pax);
            if(pax > 0) state.selectedRooms[roomId] = pax;
            else delete state.selectedRooms[roomId];
            calculateTotal();
        }

        function updateFood(id, delta) {
            let current = state.selectedFood[id] || 0;
            current += delta;
            if(current < 0) current = 0;
            state.selectedFood[id] = current;
            document.getElementById(`qty-${id}`).innerText = current;
            calculateTotal();
        }

        function calculateTotal() {
            const inDate = document.getElementById('checkInDate').value;
            if(!inDate) return;

            let roomTotal = 0;
            let foodTotal = 0;

            for(const [rid, pax] of Object.entries(state.selectedRooms)) {
                const room = roomsData.find(r => r.id === rid);
                if(room.type === 'camp') {
                    roomTotal += room.pricePerHead * pax;
                } else {
                    const rule = room.priceRules.find(r => pax <= r.max);
                    if(rule) roomTotal += rule.p;
                    else roomTotal += room.priceRules[room.priceRules.length-1].p; 
                }
            }

            for(const [fid, qty] of Object.entries(state.selectedFood)) {
                const food = foodData.find(f => f.id === fid);
                foodTotal += food.price * qty;
            }

            const isSpecial = state.specialDays.some(d => d.date === inDate);
            const depositRate = isSpecial ? 1.0 : 0.5;
            
            const grandTotal = (roomTotal + foodTotal) - state.discount;
            const deposit = (roomTotal * depositRate) + foodTotal; 

            document.getElementById('sumRoomPrice').innerText = roomTotal;
            document.getElementById('sumFoodPrice').innerText = foodTotal;
            document.getElementById('sumTotal').innerText = grandTotal;
            document.getElementById('depositPercent').innerText = (depositRate * 100);
            document.getElementById('sumDeposit').innerText = deposit;

            document.getElementById('qrImage').src = `https://promptpay.io/0615924262/${deposit}`;
        }

        function applyDiscount() {
            const code = document.getElementById('discountCode').value.toUpperCase();
            if(code === 'OPENING') {
                state.discount = 100;
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 100 ‡∏ö‡∏≤‡∏ó', 'success');
                calculateTotal();
                document.getElementById('sumDiscount').innerText = state.discount;
            } else {
                Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î', '', 'error');
            }
        }

        // --- SUBMIT ---
        async function submitBooking() {
            const checkIn = document.getElementById('checkInDate').value;
            const checkOut = document.getElementById('checkOutDate').value;
            const bookerName = document.getElementById('bookerName').value;
            const phone = document.getElementById('bookerPhone').value;
            const slipFile = document.getElementById('slipFile').files[0];
            const accepted = document.getElementById('terms').checked;

            if(!checkIn || !checkOut || !bookerName || !phone || Object.keys(state.selectedRooms).length === 0) {
                return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
            }
            if(!accepted) {
                return Swal.fire('‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á', 'warning');
            }
            if(!slipFile) {
                return Swal.fire('‡∏™‡∏•‡∏¥‡∏õ', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', 'warning');
            }

            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á...');

            const reader = new FileReader();
            reader.readAsDataURL(slipFile);
            reader.onload = async function() {
                const base64 = reader.result;
                const payload = {
                    action: 'create_booking',
                    payload: {
                        lineUserId: state.lineProfile.userId,
                        lineName: state.lineProfile.displayName,
                        bookerName: bookerName,
                        phone: phone,
                        roomIds: Object.keys(state.selectedRooms).join(','),
                        roomNames: Object.keys(state.selectedRooms).map(id => roomsData.find(r=>r.id===id).name).join(','),
                        totalPax: Object.values(state.selectedRooms).reduce((a,b)=>a+b, 0),
                        foodIds: Object.keys(state.selectedFood).join(','),
                        foodNames: Object.keys(state.selectedFood).map(id => foodData.find(f=>f.id===id).name).join(','),
                        foodQty: Object.values(state.selectedFood).join(','),
                        discountCode: document.getElementById('discountCode').value,
                        subtotal: document.getElementById('sumRoomPrice').innerText,
                        grandTotal: document.getElementById('sumTotal').innerText,
                        deposit: document.getElementById('sumDeposit').innerText,
                        balance: parseFloat(document.getElementById('sumTotal').innerText) - parseFloat(document.getElementById('sumDeposit').innerText),
                        checkIn: checkIn,
                        checkOut: checkOut,
                        slipImage: base64
                    }
                };

                try {
                    const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    const text = await res.text();
                    
                    if(text.trim().startsWith('<')) throw new Error('Permission Error: ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Deploy GAS ‡πÄ‡∏õ‡πá‡∏ô "Anyone"');
                    
                    const json = JSON.parse(text);
                    if(json.status === 'success') {
                        Swal.fire({
                            title: '‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                            text: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏≤‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏£‡∏µ‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î',
                            icon: 'success'
                        }).then(() => {
                            if(liff.isInClient()) liff.closeWindow();
                            else location.reload();
                        });
                    } else {
                        throw new Error(json.message);
                    }
                } catch(e) {
                    Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'error');
                }
                showLoading(false);
            };
        }

        function showLoading(show, text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...') {
            const el = document.getElementById('loading');
            const txt = document.getElementById('loadingText');
            if(show) {
                txt.innerText = text;
                el.style.display = 'flex';
            } else {
                el.style.display = 'none';
            }
        }

        main();
    </script>
</body>
</html>
