<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ขนำลุงดำ แคมป์ปิ้ง - Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
        .stepper-active { color: #059669; border-bottom: 3px solid #059669; }
        .card-selected { border: 2px solid #059669; background-color: #ecfdf5; }
        .card-disabled { opacity: 0.6; background-color: #f9fafb; cursor: not-allowed; border: 1px dashed #d1d5db; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="pb-20">

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-black/50 z-[9999] flex flex-col items-center justify-center hidden">
        <div class="w-12 h-12 border-4 border-white border-t-emerald-500 rounded-full animate-spin"></div>
        <p id="loadingText" class="mt-4 text-white font-medium">กำลังดำเนินการ...</p>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black/60 z-[10000] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-3xl w-full max-w-sm p-8 text-center shadow-2xl scale-95 transition-transform">
            <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">จองสำเร็จแล้ว!</h3>
            <p class="text-gray-600 mb-6">ระบบได้รับข้อมูลการจองของคุณแล้ว <br>กรุณารอแอดมินตรวจสอบการชำระเงิน <br>และสถานะจะแจ้งให้ทราบผ่านทาง LINE ครับ</p>
            <button onclick="liff.closeWindow()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-emerald-700 active:scale-95 transition-all">
                ตกลง
            </button>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-emerald-800 text-white p-6 rounded-b-[2.5rem] shadow-lg sticky top-0 z-40">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold">ขนำลุงดำ</h1>
                <p class="text-emerald-100 text-xs opacity-80">แคมป์ปิ้ง & โฮมสเตย์</p>
            </div>
            <div id="profile-img" class="w-10 h-10 rounded-full border-2 border-emerald-400 overflow-hidden bg-emerald-700"></div>
        </div>
    </header>

    <!-- Main Content (Stepper UI) -->
    <main class="p-4 max-w-md mx-auto -mt-4">
        <!-- Progress Bar -->
        <div class="bg-white rounded-2xl p-4 shadow-sm flex justify-between mb-4 text-sm font-medium text-gray-400">
            <div id="step-1-label" class="stepper-active flex-1 text-center pb-2">1. เลือกห้อง</div>
            <div id="step-2-label" class="flex-1 text-center pb-2">2. บริการเสริม</div>
            <div id="step-3-label" class="flex-1 text-center pb-2">3. ชำระเงิน</div>
        </div>

        <!-- Step 1: Room Selection -->
        <div id="step-1" class="fade-in space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-emerald-100">
                <label class="block text-xs text-gray-400 mb-1">ระบุวันที่เข้าพัก</label>
                <div class="grid grid-cols-2 gap-2">
                    <input type="date" id="checkin" onchange="loadRooms()" class="w-full p-2 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                    <input type="date" id="checkout" onchange="loadRooms()" class="w-full p-2 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
            </div>
            <div id="room-list" class="space-y-3">
                <p class="text-center py-10 text-gray-400">กรุณาเลือกวันที่เพื่อตรวจสอบห้องว่าง</p>
            </div>
        </div>

        <!-- Step 2: Extras -->
        <div id="step-2" class="fade-in hidden space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border">
                <h3 class="font-bold mb-3">อาหาร & บริการเสริม</h3>
                <div id="food-list" class="space-y-2">
                    <!-- อาหารจะโหลดจาก script -->
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border">
                <h3 class="font-bold mb-2">โค้ดส่วนลด</h3>
                <div class="flex gap-2">
                    <input type="text" id="promoInput" placeholder="กรอกโค้ด (ถ้ามี)" class="flex-1 border p-2 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                    <button onclick="applyPromo()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm">ใช้โค้ด</button>
                </div>
                <p id="promoMsg" class="text-[10px] mt-1"></p>
            </div>
        </div>

        <!-- Step 3: Payment -->
        <div id="step-3" class="fade-in hidden space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-md border-t-4 border-emerald-600">
                <h3 class="font-bold text-lg mb-4 text-center">สรุปยอดการจอง</h3>
                <div id="summary-details" class="space-y-2 text-sm text-gray-600 mb-4"></div>
                <hr class="my-4 border-dashed">
                <div class="flex justify-between items-center text-lg font-bold">
                    <span>ยอดรวมทั้งสิ้น</span>
                    <span id="sum-total" class="text-emerald-700">฿0</span>
                </div>
                <div class="flex justify-between items-center text-sm text-amber-600 mt-1">
                    <span>มัดจำ 50%</span>
                    <span id="sum-deposit">฿0</span>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border text-center">
                <p class="text-xs text-gray-400 mb-2 uppercase tracking-widest">ช่องทางชำระมัดจำ</p>
                <p class="font-bold text-emerald-800">ไทยพาณิชย์ (SCB)</p>
                <p class="text-2xl font-bold my-1 tracking-tighter">000-0-00000-0</p>
                <p class="text-sm">ชื่อบัญชี: ขนำลุงดำ โดย นาย...</p>
                
                <div class="mt-6">
                    <label class="block text-sm font-bold mb-2">แนบหลักฐานการโอน (สลิป)</label>
                    <input type="file" id="slipFile" accept="image/*" class="hidden">
                    <div onclick="document.getElementById('slipFile').click()" id="slipPreview" class="border-2 border-dashed border-emerald-200 rounded-2xl p-6 bg-emerald-50 cursor-pointer flex flex-col items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-emerald-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span class="text-xs text-emerald-600">กดเพื่ออัปโหลดรูปภาพสลิป</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm border">
                <label class="block text-xs text-gray-400 mb-1 font-bold">ข้อมูลผู้จอง</label>
                <input type="text" id="custName" placeholder="ชื่อ-นามสกุล" class="w-full border p-3 rounded-xl mb-2 outline-none">
                <input type="tel" id="custTel" placeholder="เบอร์โทรศัพท์" class="w-full border p-3 rounded-xl outline-none">
            </div>
        </div>
    </main>

    <!-- Bottom Action Bar -->
    <div class="fixed bottom-0 inset-x-0 p-4 bg-white border-t flex gap-3 z-40">
        <button id="btn-back" onclick="prevStep()" class="flex-1 py-4 bg-gray-100 rounded-2xl font-bold hidden">ย้อนกลับ</button>
        <button id="btn-next" onclick="nextStep()" class="flex-[2] py-4 bg-emerald-600 text-white rounded-2xl font-bold shadow-lg shadow-emerald-200 disabled:bg-gray-300">ถัดไป</button>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyR0jWpP0mOfq77uV548n7L3P3q7Gf228Rre2n9q3K-g7F4X9A8Hh8y1Y2Z3/exec'; // URL สคริปต์ของคุณ
        
        let state = {
            step: 1,
            user: null,
            bookings: [],
            rooms: [
                { id: 1, name: 'บ้านต้นไม้ A', price: 1500, capacity: 2, img: 'https://images.unsplash.com/photo-1510798831971-661eb04b3739?w=400' },
                { id: 2, name: 'บ้านริมน้ำ B', price: 1800, capacity: 2, img: 'https://images.unsplash.com/photo-1499793983690-e29da59ef1c2?w=400' },
                { id: 3, name: 'เต็นท์โดม C', price: 1200, capacity: 2, img: 'https://images.unsplash.com/photo-1523987355523-c7b5b0dd90a7?w=400' }
            ],
            foods: [
                { id: 'f1', name: 'ชุดหมูกระทะ', price: 399 },
                { id: 'f2', name: 'เซตอาหารเช้า', price: 150 },
                { id: 'f3', name: 'น้ำแข็ง (ถัง)', price: 20 }
            ],
            selectedRooms: [],
            selectedFoods: [],
            checkin: '',
            checkout: '',
            promoCodes: [],
            activePromo: null,
            total: 0,
            deposit: 0,
            discountAmount: 0
        };

        async function init() {
            showLoading('กำลังเริ่มต้นระบบ...');
            try {
                // Initialize LIFF
                await liff.init({ liffId: "2006764516-xQ0yqE13" }); // ใส่ LIFF ID ของคุณ
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    state.user = await liff.getProfile();
                    document.getElementById('profile-img').innerHTML = `<img src="${state.user.pictureUrl}" class="w-full h-full object-cover">`;
                }

                // Fetch Data from Sheet
                const res = await fetch(API_URL);
                const data = await res.json();
                state.bookings = data.bookings;
                state.promoCodes = data.promoCodes;
                
                // Set default dates
                const today = new Date();
                const tomorrow = new Date();
                tomorrow.setDate(today.getDate() + 1);
                document.getElementById('checkin').min = today.toISOString().split('T')[0];
                document.getElementById('checkout').min = tomorrow.toISOString().split('T')[0];
                
                renderFoods();
            } catch (err) { console.error(err); }
            hideLoading();
        }

        function loadRooms() {
            const inDate = document.getElementById('checkin').value;
            const outDate = document.getElementById('checkout').value;
            if(!inDate || !outDate) return;
            
            state.checkin = inDate;
            state.checkout = outDate;
            state.selectedRooms = [];

            const list = document.getElementById('room-list');
            list.innerHTML = state.rooms.map(room => {
                const isBooked = state.bookings.some(b => 
                    b.RoomsInfo.includes(room.name) && 
                    b.Status !== 'ยกเลิก' &&
                    ((inDate >= b.CheckIn && inDate < b.CheckOut) || (outDate > b.CheckIn && outDate <= b.CheckOut))
                );

                return `
                    <div onclick="${isBooked ? '' : `toggleRoom(${room.id})`}" id="room-${room.id}" 
                        class="bg-white rounded-2xl overflow-hidden shadow-sm border transition-all ${isBooked ? 'card-disabled' : 'cursor-pointer hover:shadow-md'}">
                        <img src="${room.img}" class="w-full h-32 object-cover">
                        <div class="p-3 flex justify-between items-center">
                            <div>
                                <h4 class="font-bold text-gray-800">${room.name}</h4>
                                <p class="text-xs text-gray-500">พักได้ ${room.capacity} ท่าน</p>
                            </div>
                            <div class="text-right">
                                <p class="text-emerald-600 font-bold">฿${room.price.toLocaleString()}</p>
                                <p class="text-[10px] text-gray-400">/คืน</p>
                            </div>
                        </div>
                        ${isBooked ? '<div class="absolute inset-0 flex items-center justify-center bg-black/10 font-bold text-red-500 rotate-12">ห้องไม่ว่าง</div>' : ''}
                    </div>
                `;
            }).join('');
            validateStep();
        }

        function toggleRoom(id) {
            const idx = state.selectedRooms.findIndex(r => r.id === id);
            if(idx > -1) {
                state.selectedRooms.splice(idx, 1);
                document.getElementById(`room-${id}`).classList.remove('card-selected');
            } else {
                const room = state.rooms.find(r => r.id === id);
                state.selectedRooms.push(room);
                document.getElementById(`room-${id}`).classList.add('card-selected');
            }
            validateStep();
        }

        function renderFoods() {
            document.getElementById('food-list').innerHTML = state.foods.map(f => `
                <div class="flex items-center justify-between p-3 border rounded-xl">
                    <span>${f.name} <span class="text-xs text-emerald-600">(฿${f.price})</span></span>
                    <div class="flex items-center gap-3">
                        <button onclick="updateFood('${f.id}', -1)" class="w-8 h-8 rounded-full border border-emerald-200 flex items-center justify-center">-</button>
                        <span id="qty-${f.id}" class="font-bold w-4 text-center">0</span>
                        <button onclick="updateFood('${f.id}', 1)" class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center font-bold">+</button>
                    </div>
                </div>
            `).join('');
        }

        function updateFood(id, delta) {
            const idx = state.selectedFoods.findIndex(f => f.id === id);
            if(idx > -1) {
                state.selectedFoods[idx].qty += delta;
                if(state.selectedFoods[idx].qty <= 0) state.selectedFoods.splice(idx, 1);
            } else if(delta > 0) {
                const food = state.foods.find(f => f.id === id);
                state.selectedFoods.push({...food, qty: 1});
            }
            const current = state.selectedFoods.find(f => f.id === id);
            document.getElementById(`qty-${id}`).innerText = current ? current.qty : 0;
        }

        function applyPromo() {
            const input = document.getElementById('promoInput').value.trim();
            const msg = document.getElementById('promoMsg');
            const promo = state.promoCodes.find(p => p.code === input);
            
            if(promo) {
                state.activePromo = promo;
                msg.innerText = `ใช้โค้ดสำเร็จ: ลด ${promo.value}${promo.type === 'percent' ? '%' : ' บาท'}`;
                msg.className = "text-[10px] mt-1 text-emerald-600 font-bold";
            } else {
                state.activePromo = null;
                msg.innerText = "ไม่พบโค้ดส่วนลดนี้";
                msg.className = "text-[10px] mt-1 text-red-500 font-bold";
            }
            calculateTotal();
        }

        function calculateTotal() {
            const roomTotal = state.selectedRooms.reduce((s, r) => s + r.price, 0);
            const foodTotal = state.selectedFoods.reduce((s, f) => s + (f.price * f.qty), 0);
            let subTotal = roomTotal + foodTotal;
            
            let discount = 0;
            if(state.activePromo) {
                discount = state.activePromo.type === 'percent' 
                    ? (subTotal * (state.activePromo.value / 100)) 
                    : state.activePromo.value;
            }
            
            state.discountAmount = discount;
            state.total = Math.max(0, subTotal - discount);
            state.deposit = state.total * 0.5;

            // Render Summary
            document.getElementById('summary-details').innerHTML = `
                <div class="flex justify-between"><span>ค่าห้อง (${state.selectedRooms.length} ห้อง)</span><span>฿${roomTotal.toLocaleString()}</span></div>
                ${state.selectedFoods.map(f => `<div class="flex justify-between text-xs"><span>${f.name} x${f.qty}</span><span>฿${(f.price*f.qty).toLocaleString()}</span></div>`).join('')}
                ${discount > 0 ? `<div class="flex justify-between text-red-500"><span>ส่วนลด</span><span>-฿${discount.toLocaleString()}</span></div>` : ''}
            `;
            document.getElementById('sum-total').innerText = `฿${state.total.toLocaleString()}`;
            document.getElementById('sum-deposit').innerText = `฿${state.deposit.toLocaleString()}`;
        }

        function validateStep() {
            const btn = document.getElementById('btn-next');
            if(state.step === 1) btn.disabled = state.selectedRooms.length === 0;
            else if(state.step === 3) {
                const name = document.getElementById('custName').value;
                const tel = document.getElementById('custTel').value;
                const slip = document.getElementById('slipFile').files.length;
                btn.disabled = !(name && tel && slip);
            }
        }

        function nextStep() {
            if(state.step < 3) {
                state.step++;
                updateUI();
            } else {
                submitBooking();
            }
        }

        function prevStep() {
            if(state.step > 1) {
                state.step--;
                updateUI();
            }
        }

        function updateUI() {
            // Tabs
            for(let i=1; i<=3; i++) {
                document.getElementById(`step-${i}`).classList.toggle('hidden', state.step !== i);
                document.getElementById(`step-${i}-label`).classList.toggle('stepper-active', state.step === i);
            }
            
            // Buttons
            document.getElementById('btn-back').classList.toggle('hidden', state.step === 1);
            document.getElementById('btn-next').innerText = state.step === 3 ? 'ยืนยันและส่งสลิป' : 'ถัดไป';
            
            if(state.step === 3) calculateTotal();
            validateStep();
        }

        // Image Preview
        document.getElementById('slipFile').onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('slipPreview').innerHTML = `<img src="${event.target.result}" class="max-h-40 rounded-lg">`;
                    validateStep();
                };
                reader.readAsDataURL(file);
            }
        };

        // Watch for input changes in step 3
        document.getElementById('custName').oninput = validateStep;
        document.getElementById('custTel').oninput = validateStep;

        async function submitBooking() {
            const name = document.getElementById('custName').value;
            const tel = document.getElementById('custTel').value;
            const file = document.getElementById('slipFile').files[0];

            showLoading('กำลังส่งข้อมูลการจอง...');

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'submitBooking',
                            userId: state.user.userId,
                            userName: state.user.displayName,
                            custName: name,
                            custTel: tel,
                            checkin: state.checkin,
                            checkout: state.checkout,
                            rooms: JSON.stringify(state.selectedRooms),
                            foods: JSON.stringify(state.selectedFoods),
                            promoCode: state.activePromo ? state.activePromo.code : '',
                            discount: state.discountAmount,
                            total: state.total,
                            deposit: state.deposit,
                            slip: reader.result
                        })
                    });
                    const res = await response.json();
                    if(res.status === 'success') {
                        // แสดง Modal สำเร็จ
                        document.getElementById('successModal').classList.remove('hidden');
                    } else {
                        alert("เกิดข้อผิดพลาด: " + res.message);
                    }
                } catch (err) { alert("เกิดข้อผิดพลาดในการเชื่อมต่อ"); }
                finally { hideLoading(); }
            };
        }

        function showLoading(text) {
            document.getElementById('loadingText').innerText = text;
            document.getElementById('loading').classList.remove('hidden');
        }
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        window.onload = init;
    </script>
</body>
</html>
