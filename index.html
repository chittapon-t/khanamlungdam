<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ขนำลุงดำ แคมป์ปิ้ง - สัมผัสธรรมชาติ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2D5A27; --accent: #8B4513; --bg: #FDFBF7; }
        body { font-family: 'Kanit', sans-serif; background-color: var(--bg); color: #333; }
        .camp-gradient { background: linear-gradient(135deg, #2D5A27 0%, #1a3a17 100%); }
        .step-indicator.active { background-color: var(--primary); color: white; }
        .room-card.selected { border: 2px solid var(--primary); background: #f0fdf4; }
        .btn-primary { background-color: var(--primary); transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(45, 90, 39, 0.3); }
        input[type="date"] { appearance: none; -webkit-appearance: none; }
    </style>
</head>
<body class="pb-24">
    <!-- Header -->
    <header class="camp-gradient text-white p-6 rounded-b-3xl shadow-lg">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold tracking-wide">ขนำลุงดำ แคมป์ปิ้ง</h1>
                <p class="text-sm opacity-80" id="userDisplayName">กำลังโหลดข้อมูล...</p>
            </div>
            <img id="userPicture" src="https://via.placeholder.com/50" class="w-12 h-12 rounded-full border-2 border-white/50 shadow-md">
        </div>
    </header>

    <!-- Step Progress -->
    <div class="flex justify-around items-center my-6 px-4">
        <div class="flex flex-col items-center gap-1">
            <div id="step-dot-1" class="step-indicator active w-8 h-8 rounded-full flex items-center justify-center border-2 border-green-800 text-sm font-bold">1</div>
            <span class="text-xs">เลือกวัน</span>
        </div>
        <div class="h-px bg-gray-300 flex-1 mx-2"></div>
        <div class="flex flex-col items-center gap-1">
            <div id="step-dot-2" class="step-indicator w-8 h-8 rounded-full flex items-center justify-center border-2 border-gray-300 text-sm font-bold">2</div>
            <span class="text-xs">เลือกห้อง</span>
        </div>
        <div class="h-px bg-gray-300 flex-1 mx-2"></div>
        <div class="flex flex-col items-center gap-1">
            <div id="step-dot-3" class="step-indicator w-8 h-8 rounded-full flex items-center justify-center border-2 border-gray-300 text-sm font-bold">3</div>
            <span class="text-xs">จ่ายมัดจำ</span>
        </div>
    </div>

    <!-- Main Content Area -->
    <main class="px-4 max-w-md mx-auto">
        <!-- STEP 1: DATE & GUESTS -->
        <section id="section-1" class="space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-lg mb-4 text-green-900 border-l-4 border-green-800 pl-2">ระบุวันเข้าพัก</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">วันที่เช็คอิน</label>
                        <input type="date" id="checkInDate" class="w-full p-2 border rounded-xl text-sm focus:ring-2 focus:ring-green-800 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">วันที่เช็คเอาท์</label>
                        <input type="date" id="checkOutDate" class="w-full p-2 border rounded-xl text-sm focus:ring-2 focus:ring-green-800 outline-none">
                    </div>
                </div>
                <div class="mt-4 p-3 bg-amber-50 rounded-xl text-xs text-amber-800 flex gap-2">
                    <span>⚠️</span>
                    <span>เช็คอิน 14:00 - 20:00 น. | เช็คเอาท์ก่อน 12:00 น.</span>
                </div>
            </div>
            <button onclick="goToStep(2)" class="w-full btn-primary text-white py-4 rounded-2xl font-bold shadow-lg mt-4">ตรวจสอบห้องว่าง</button>
        </section>

        <!-- STEP 2: ROOM & FOOD SELECTION -->
        <section id="section-2" class="hidden space-y-6">
            <div>
                <h3 class="font-bold text-lg mb-4 text-green-900 border-l-4 border-green-800 pl-2">เลือกห้องพัก</h3>
                <div id="room-list" class="space-y-4">
                    <!-- Dynamic Rooms -->
                </div>
            </div>

            <div>
                <h3 class="font-bold text-lg mb-4 text-green-900 border-l-4 border-green-800 pl-2">สั่งอาหารล่วงหน้า</h3>
                <div id="food-list" class="space-y-3">
                    <!-- Dynamic Foods -->
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-sm mb-3 text-gray-600">ข้อมูลผู้จอง</h3>
                <input type="text" id="custName" placeholder="ชื่อผู้จอง" class="w-full p-3 border rounded-xl mb-3 text-sm">
                <input type="tel" id="custPhone" placeholder="เบอร์โทรศัพท์" class="w-full p-3 border rounded-xl mb-3 text-sm">
                <div class="flex gap-2">
                    <input type="text" id="discountCode" placeholder="โค้ดส่วนลด" class="flex-1 p-3 border rounded-xl text-sm">
                    <button onclick="applyDiscount()" class="px-4 bg-gray-200 rounded-xl text-sm font-bold">ใช้</button>
                </div>
            </div>

            <button onclick="goToStep(3)" class="w-full btn-primary text-white py-4 rounded-2xl font-bold shadow-lg">ยืนยันการเลือก</button>
        </section>

        <!-- STEP 3: PAYMENT -->
        <section id="section-3" class="hidden space-y-4">
            <div class="bg-white p-6 rounded-3xl shadow-xl border-t-8 border-green-800">
                <div class="text-center mb-6">
                    <p class="text-gray-500 text-sm">ยอดชำระมัดจำ</p>
                    <h2 class="text-4xl font-black text-green-900" id="depositTotal">฿0.00</h2>
                    <p class="text-xs text-red-500 mt-1">*ชำระเต็มจำนวนสำหรับวันหยุดพิเศษ</p>
                </div>

                <div class="bg-gray-50 p-4 rounded-2xl mb-6">
                    <p class="text-xs text-center text-gray-400 mb-2">สแกนเพื่อจ่าย (PromptPay)</p>
                    <img id="qrCode" src="https://via.placeholder.com/300x300?text=PromptPay+QR" class="mx-auto w-48 h-48 rounded-lg shadow-sm">
                    <p class="text-sm font-bold text-center mt-3">0615924262</p>
                    <p class="text-xs text-center text-gray-500">อลงกต ทวีผ่อง</p>
                </div>

                <div class="space-y-4">
                    <label class="block">
                        <span class="text-sm font-bold text-gray-700">อัปโหลดสลิปโอนเงิน</span>
                        <div class="mt-2 flex items-center justify-center w-full">
                            <label class="flex flex-col w-full h-32 border-4 border-dashed border-gray-200 hover:bg-gray-50 hover:border-green-300 group rounded-2xl transition-colors cursor-pointer">
                                <div class="flex flex-col items-center justify-center pt-7">
                                    <svg class="w-10 h-10 text-gray-400 group-hover:text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    <p class="text-xs text-gray-400 mt-1" id="file-name">เลือกรูปภาพสลิป</p>
                                </div>
                                <input type="file" id="slipFile" class="hidden" accept="image/*" onchange="handleFile(this)">
                            </label>
                        </div>
                    </label>

                    <div class="flex items-start gap-3 py-2">
                        <input type="checkbox" id="agreeTerm" class="mt-1 w-4 h-4 accent-green-800">
                        <label for="agreeTerm" class="text-xs text-gray-500">ฉันยอมรับเงื่อนไขการจอง และข้อมูลการชำระเงินถูกต้อง</label>
                    </div>
                </div>
            </div>

            <button onclick="submitFinalBooking()" id="submitBtn" class="w-full btn-primary text-white py-4 rounded-2xl font-bold shadow-lg">ยืนยันการจอง</button>
        </section>

        <!-- Success Message -->
        <section id="section-success" class="hidden text-center py-10 animate-bounce">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h2 class="text-2xl font-bold text-green-900">การจองเสร็จสมบูรณ์!</h2>
            <p class="text-gray-500 mt-2 px-6">เจ้าหน้าที่กำลังตรวจสอบสลิป และจะส่งข้อความยืนยันทาง LINE OA ภายใน 30 นาที</p>
            <button onclick="liff.closeWindow()" class="mt-8 px-8 py-3 bg-gray-800 text-white rounded-xl font-bold">ปิดหน้านี้</button>
        </section>
    </main>

    <script>
        // State Management
        let state = {
            user: { id: '', name: '', pic: '' },
            booking: {
                checkIn: '', checkOut: '', rooms: [], foods: [],
                subTotal: 0, discount: 0, deposit: 0, netTotal: 0
            },
            settings: []
        };

        const ROOM_DATA = [
            { id: 'R1', name: 'โฮมสเตย์หนำโป', price: (g) => g >= 6 ? 2200 : 1600, capacity: [4,8] },
            { id: 'R2', name: 'บ้านพักริมน้ำ 1', price: (g) => g >= 3 ? 1750 : 1400, capacity: [1,3] },
            { id: 'R3', name: 'บ้านพักริมน้ำ 2', price: (g) => g >= 3 ? 1750 : 1400, capacity: [1,3] },
            { id: 'R4', name: 'เต็นท์กระโจม 1', price: (g) => g >= 3 ? 1550 : 1200, capacity: [1,4] },
            { id: 'R5', name: 'เต็นท์กระโจม 2', price: (g) => g >= 3 ? 1550 : 1200, capacity: [1,4] },
            { id: 'R6', name: 'เต็นท์สนาม K1', price: 700, capacity: [1,2] },
            { id: 'R7', name: 'เต็นท์สนาม K2', price: 700, capacity: [1,2] },
            { id: 'R8', name: 'ลานกางเต็นท์', price: (g) => g * 150, capacity: [1,20] }
        ];

        const FOOD_DATA = [
            { id: 'F1', name: 'ชุดหมูกระทะลุงดำ', price: 390 },
            { id: 'F2', name: 'ชุดไก่กระทะลุงดำ', price: 390 },
            { id: 'F3', name: 'ชุดชาบูหมูลุงดำ', price: 390 },
            { id: 'F4', name: 'ชุดชาบูไก่ลุงดำ', price: 390 },
            { id: 'F5', name: 'เซ็ตอาหารพื้นบ้าน', price: 390 }
        ];

        // Init LIFF
        async function initLiff() {
            try {
                await liff.init({ liffId: "2008863563-tuai5kaC" });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    state.user = { id: profile.userId, name: profile.displayName, pic: profile.pictureUrl };
                    document.getElementById('userDisplayName').innerText = profile.displayName;
                    document.getElementById('userPicture').src = profile.pictureUrl;
                    
                    // Set default dates
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('checkInDate').min = today;
                    document.getElementById('checkOutDate').min = today;
                }
            } catch (err) {
                console.error('LIFF init failed', err);
            }
        }

        function goToStep(step) {
            // Validate step 1
            if (step === 2) {
                const cin = document.getElementById('checkInDate').value;
                const cout = document.getElementById('checkOutDate').value;
                if (!cin || !cout) return alert('กรุณาระบุวันที่เข้าพัก');
                if (new Date(cin) >= new Date(cout)) return alert('วันที่เช็คเอาท์ต้องอยู่หลังวันเช็คอิน');
                state.booking.checkIn = cin;
                state.booking.checkOut = cout;
                renderRooms();
                renderFoods();
            }

            if (step === 3) {
                if (state.booking.rooms.length === 0) return alert('กรุณาเลือกอย่างน้อย 1 ห้องพัก');
                if (!document.getElementById('custName').value || !document.getElementById('custPhone').value) return alert('กรุณากรอกข้อมูลผู้ติดต่อ');
                calculateTotal();
            }

            // UI Switching
            [1, 2, 3].forEach(s => {
                document.getElementById(`section-${s}`).classList.add('hidden');
                document.getElementById(`step-dot-${s}`).classList.remove('active');
            });
            document.getElementById(`section-${step}`).classList.remove('hidden');
            for(let i=1; i<=step; i++) document.getElementById(`step-dot-${i}`).classList.add('active');
            window.scrollTo(0,0);
        }

        function renderRooms() {
            const list = document.getElementById('room-list');
            list.innerHTML = ROOM_DATA.map(room => `
                <div class="room-card bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center transition-all" id="room-card-${room.id}">
                    <div>
                        <h4 class="font-bold text-green-900">${room.name}</h4>
                        <p class="text-xs text-gray-500">รองรับ ${room.capacity[0]}-${room.capacity[1]} ท่าน</p>
                        <p class="text-sm font-bold mt-1 text-accent">฿${typeof room.price === 'function' ? 'ราคาตามจำนวนคน' : room.price}</p>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400">คน:</span>
                            <input type="number" min="${room.capacity[0]}" max="${room.capacity[1]}" value="${room.capacity[0]}" 
                                class="w-12 p-1 border rounded text-center text-sm" id="guest-${room.id}">
                        </div>
                        <button onclick="toggleRoom('${room.id}')" id="btn-room-${room.id}" class="px-4 py-1.5 rounded-lg border-2 border-green-800 text-green-800 text-sm font-bold">เลือก</button>
                    </div>
                </div>
            `).join('');
        }

        function renderFoods() {
            const list = document.getElementById('food-list');
            list.innerHTML = FOOD_DATA.map(food => `
                <div class="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center border border-gray-100">
                    <div>
                        <h5 class="text-sm font-bold text-gray-700">${food.name}</h5>
                        <p class="text-xs text-accent font-bold">฿${food.price}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="changeFoodQty('${food.id}', -1)" class="w-8 h-8 rounded-full bg-gray-100 text-xl">-</button>
                        <span id="food-qty-${food.id}" class="w-4 text-center font-bold">0</span>
                        <button onclick="changeFoodQty('${food.id}', 1)" class="w-8 h-8 rounded-full bg-gray-100 text-xl">+</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleRoom(id) {
            const idx = state.booking.rooms.findIndex(r => r.id === id);
            const card = document.getElementById(`room-card-${id}`);
            const btn = document.getElementById(`btn-room-${id}`);
            const guestCount = parseInt(document.getElementById(`guest-${id}`).value);

            if (idx > -1) {
                state.booking.rooms.splice(idx, 1);
                card.classList.remove('selected');
                btn.innerText = 'เลือก';
                btn.classList.replace('bg-green-800', 'text-green-800');
                btn.classList.add('border-2');
            } else {
                state.booking.rooms.push({ id, guests: guestCount });
                card.classList.add('selected');
                btn.innerText = 'ลบออก';
                btn.classList.replace('text-green-800', 'bg-green-800');
                btn.classList.remove('border-2');
                btn.classList.add('text-white');
            }
        }

        function changeFoodQty(id, delta) {
            const el = document.getElementById(`food-qty-${id}`);
            let val = parseInt(el.innerText) + delta;
            if (val < 0) val = 0;
            el.innerText = val;
            
            const idx = state.booking.foods.findIndex(f => f.id === id);
            if (val > 0) {
                if (idx > -1) state.booking.foods[idx].qty = val;
                else state.booking.foods.push({ id, qty: val });
            } else if (idx > -1) {
                state.booking.foods.splice(idx, 1);
            }
        }

        function calculateTotal() {
            let roomTotal = 0;
            let foodTotal = 0;
            
            state.booking.rooms.forEach(r => {
                const master = ROOM_DATA.find(m => m.id === r.id);
                roomTotal += (typeof master.price === 'function') ? master.price(r.guests) : master.price;
            });

            state.booking.foods.forEach(f => {
                const master = FOOD_DATA.find(m => m.id === f.id);
                foodTotal += master.price * f.qty;
            });

            state.booking.subTotal = roomTotal + foodTotal;
            state.booking.netTotal = state.booking.subTotal - state.booking.discount;

            // Check Special Day for 100% deposit (Dummy check)
            const isSpecial = false; // logic would call getSettings()
            state.booking.deposit = isSpecial ? state.booking.netTotal : (roomTotal * 0.5) + foodTotal;

            document.getElementById('depositTotal').innerText = `฿${state.booking.deposit.toLocaleString()}`;
        }

        function handleFile(input) {
            if (input.files && input.files[0]) {
                document.getElementById('file-name').innerText = input.files[0].name;
                const reader = new FileReader();
                reader.onload = (e) => state.slipBase64 = e.target.result;
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function submitFinalBooking() {
            if (!document.getElementById('agreeTerm').checked) return alert('กรุณายอมรับเงื่อนไข');
            if (!state.slipBase64) return alert('กรุณาอัปโหลดสลิปหลักฐานการโอนเงิน');

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "กำลังบันทึกข้อมูล...";

            const payload = {
                lineId: state.user.id,
                lineName: state.user.name,
                customerName: document.getElementById('custName').value,
                phone: document.getElementById('custPhone').value,
                checkInDate: state.booking.checkIn,
                checkOutDate: state.booking.checkOut,
                roomIds: state.booking.rooms.map(r => r.id),
                roomNames: state.booking.rooms.map(r => ROOM_DATA.find(m => m.id === r.id).name),
                totalGuests: state.booking.rooms.reduce((acc, r) => acc + r.guests, 0),
                foodIds: state.booking.foods.map(f => f.id),
                foodNames: state.booking.foods.map(f => FOOD_DATA.find(m => m.id === f.id).name),
                foodQtys: state.booking.foods.map(f => f.qty),
                subTotal: state.booking.subTotal,
                netTotal: state.booking.netTotal,
                depositAmount: state.booking.deposit,
                slipBase64: state.slipBase64
            };

            // Post to GAS (Deployment URL needed)
            // google.script.run.withSuccessHandler(onSuccess).submitBooking(payload);
            
            // Simulation for preview
            setTimeout(() => {
                document.getElementById('section-3').classList.add('hidden');
                document.getElementById('section-success').classList.remove('hidden');
            }, 2000);
        }

        window.onload = initLiff;
    </script>
</body>
</html>
