<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á - Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
        .stepper-active { color: #059669; border-bottom: 3px solid #059669; }
        .card-selected { border: 2px solid #059669; background-color: #ecfdf5; }
        .card-disabled { opacity: 0.6; background-color: #f9fafb; cursor: not-allowed; border: 1px dashed #d1d5db; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="pb-20">
    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex flex-col items-center justify-center text-white hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white mb-4"></div>
        <p id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
    </div>

    <!-- App Container -->
    <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-lg">
        <!-- Header -->
        <div class="bg-emerald-800 text-white p-6 rounded-b-3xl">
            <h1 class="text-2xl font-semibold">‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</h1>
            <p class="text-emerald-100 opacity-90">‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</p>
        </div>

        <!-- Stepper -->
        <div class="flex justify-around bg-white p-4 sticky top-0 z-10 border-b">
            <div id="step1-btn" class="flex flex-col items-center text-xs stepper-active">
                <span class="w-6 h-6 rounded-full border flex items-center justify-center mb-1">1</span>
                <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
            </div>
            <div id="step2-btn" class="flex flex-col items-center text-xs text-gray-400">
                <span class="w-6 h-6 rounded-full border flex items-center justify-center mb-1">2</span>
                <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</span>
            </div>
            <div id="step3-btn" class="flex flex-col items-center text-xs text-gray-400">
                <span class="w-6 h-6 rounded-full border flex items-center justify-center mb-1">3</span>
                <span>‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
            </div>
            <div id="step4-btn" class="flex flex-col items-center text-xs text-gray-400">
                <span class="w-6 h-6 rounded-full border flex items-center justify-center mb-1">4</span>
                <span>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>
            </div>
        </div>

        <div class="p-4 overflow-y-auto" style="height: calc(100vh - 200px);">
            <!-- STEP 1: DATE SELECTION -->
            <div id="step1" class="fade-in">
                <h2 class="text-lg font-semibold mb-4 text-emerald-900">‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</h2>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</label>
                        <input type="date" id="checkin" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå</label>
                        <input type="date" id="checkout" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                </div>
                <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                    <p class="text-sm text-emerald-800">üìå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 14:00 ‡∏ô. | ‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô 12:00 ‡∏ô.</p>
                </div>
            </div>

            <!-- STEP 2: ROOM SELECTION -->
            <div id="step2" class="fade-in hidden">
                <h2 class="text-lg font-semibold mb-4 text-emerald-900">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á</h2>
                <div id="roomList" class="space-y-4">
                    <!-- Dynamic Rooms -->
                </div>
            </div>

            <!-- STEP 3: FOOD SELECTION -->
            <div id="step3" class="fade-in hidden">
                <h2 class="text-lg font-semibold mb-4 text-emerald-900">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>
                <div id="foodList" class="space-y-4">
                    <!-- Dynamic Foods -->
                </div>
            </div>

            <!-- STEP 4: PAYMENT -->
            <div id="step4" class="fade-in hidden">
                <h2 class="text-lg font-semibold mb-4 text-emerald-900">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
                
                <div class="bg-gray-50 p-4 rounded-2xl mb-6 space-y-2 text-sm border">
                    <div class="flex justify-between"><span class="text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span> <span id="summaryDates" class="font-medium"></span></div>
                    <div class="flex justify-between border-t pt-2"><span class="text-gray-500">‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å:</span> <span id="summaryRooms" class="font-medium text-right"></span></div>
                    <div class="flex justify-between border-t pt-2"><span class="text-gray-500">‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</span> <span id="summaryFoods" class="font-medium text-right"></span></div>
                    <div class="flex justify-between border-t pt-2"><span class="text-gray-500">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span> <span id="summaryDiscount" class="text-red-500">‡∏ø0</span></div>
                    <div class="flex justify-between pt-2 text-lg font-bold text-emerald-800 border-t">
                        <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</span>
                        <span id="summaryTotal">‡∏ø0</span>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm text-gray-600 mb-1 font-semibold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</label>
                    <input type="text" id="custName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full p-3 border rounded-xl mb-2 outline-none">
                    <input type="tel" id="custTel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full p-3 border rounded-xl outline-none">
                </div>

                <div class="mb-6">
                    <label class="block text-sm text-gray-600 mb-1 font-semibold">‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
                    <div class="flex gap-2">
                        <input type="text" id="promoInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô" class="flex-1 p-3 border rounded-xl outline-none uppercase">
                        <button onclick="applyPromo()" class="bg-emerald-100 text-emerald-700 px-6 rounded-xl font-semibold">‡πÉ‡∏ä‡πâ</button>
                    </div>
                    <p id="promoMsg" class="text-xs mt-1"></p>
                </div>

                <div class="bg-emerald-900 text-white p-5 rounded-3xl mb-6 text-center shadow-lg">
                    <p class="text-xs opacity-80 mb-1 uppercase tracking-wider">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                    <p class="text-3xl font-bold" id="depositAmount">‡∏ø0</p>
                    <div class="mt-2 text-[10px] text-emerald-200 opacity-80 leading-tight">
                        (‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å 50% + ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)
                    </div>
                </div>

                <!-- QR CODE SECTION -->
                <div class="bg-white p-6 border-2 border-emerald-100 rounded-3xl mb-6 flex flex-col items-center shadow-sm">
                    <img id="qrCodeImg" src="" alt="PromptPay QR Code" class="w-48 h-48 mb-4 border p-2 rounded-xl">
                    <div class="text-center">
                        <p class="text-emerald-700 font-bold text-lg leading-tight">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå (PromptPay)</p>
                        <p class="text-gray-800 tracking-widest text-xl font-bold my-1">061-592-4262</p>
                        <p class="text-sm text-gray-500 font-medium">‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</p>
                    </div>
                </div>

                <div class="mb-20">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô (‡∏™‡∏•‡∏¥‡∏õ)</label>
                    <input type="file" id="slipFile" accept="image/*" class="hidden">
                    <label for="slipFile" id="slipLabel" class="w-full h-40 border-2 border-emerald-500 border-dashed rounded-2xl flex flex-col items-center justify-center cursor-pointer bg-emerald-50 hover:bg-emerald-100 transition-colors">
                        <span class="text-emerald-600 font-medium">üì∑ ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
                        <span class="text-xs text-gray-400 mt-1">‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>
                    </label>
                    <div id="slipPreviewContainer" class="hidden mt-4">
                        <img id="slipPreview" class="w-full rounded-xl shadow-md border">
                        <button onclick="resetSlip()" class="mt-2 text-red-500 text-xs w-full text-center">‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Bar -->
        <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white p-4 border-t flex items-center justify-between gap-4">
            <button id="prevBtn" onclick="prevStep()" class="flex-1 py-3 border border-emerald-600 text-emerald-600 rounded-2xl font-semibold hidden">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <button id="nextBtn" onclick="nextStep()" class="flex-[2] py-3 bg-emerald-700 text-white rounded-2xl font-semibold shadow-lg shadow-emerald-200">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</button>
        </div>
    </div>

    <script>
        const LIFF_ID = '2008863563-tuai5kaC';
        const APP_URL = 'https://script.google.com/macros/s/AKfycbyfD14t0t4n6Cj33x5gYv3pXn6vF3V4yD8yD8yD8yD8yD8yD8yD8yD8y/exec'; 
        const PROMPTPAY_ID = '0615924262';

        const roomData = [
            { id: 'h1', name: '‡πÇ‡∏Æ‡∏°‡∏™‡πÄ‡∏ï‡∏¢‡πå‡∏´‡∏ô‡∏≥‡πÇ‡∏õ', min: 4, max: 8, rates: { '4-5': 1600, '6-8': 2200 }, img: 'https://images.unsplash.com/photo-1587061949733-76243032c390?auto=format&fit=crop&q=80&w=400' },
            { id: 'b1', name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ 1', min: 1, max: 3, rates: { '1-2': 1400, '3': 1750 }, img: 'https://images.unsplash.com/photo-1542718610-a1d656d1884c?auto=format&fit=crop&q=80&w=400' },
            { id: 'b2', name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ 2', min: 1, max: 3, rates: { '1-2': 1400, '3': 1750 }, img: 'https://images.unsplash.com/photo-1542718610-a1d656d1884c?auto=format&fit=crop&q=80&w=400' },
            { id: 't1', name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏° 1', min: 1, max: 4, rates: { '1-2': 1200, '3-4': 1550 }, img: 'https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?auto=format&fit=crop&q=80&w=400' },
            { id: 't2', name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏° 2', min: 1, max: 4, rates: { '1-2': 1200, '3-4': 1550 }, img: 'https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?auto=format&fit=crop&q=80&w=400' },
            { id: 'k1', name: '‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏ô‡∏≤‡∏° K1', min: 1, max: 2, rates: { '1-2': 700 }, img: 'https://images.unsplash.com/photo-1533167649158-6d508895b680?auto=format&fit=crop&q=80&w=400' },
            { id: 'k2', name: '‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏ô‡∏≤‡∏° K2', min: 1, max: 2, rates: { '1-2': 700 }, img: 'https://images.unsplash.com/photo-1533167649158-6d508895b680?auto=format&fit=crop&q=80&w=400' },
            { id: 'tent', name: '‡∏•‡∏≤‡∏ô‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå', min: 1, max: 20, rates: { 'per_person': 150 }, img: 'https://images.unsplash.com/photo-1523987355523-c7b5b0dd90a7?auto=format&fit=crop&q=80&w=400' }
        ];

        const foodMenu = [
            { id: 'f1', name: '‡∏ä‡∏∏‡∏î‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390, img: 'https://images.unsplash.com/photo-1560684352-8497838a2229?auto=format&fit=crop&q=80&w=400' },
            { id: 'f2', name: '‡∏ä‡∏∏‡∏î‡πÑ‡∏Å‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390, img: 'https://images.unsplash.com/photo-1604908176997-125f25cc6f3d?auto=format&fit=crop&q=80&w=400' },
            { id: 'f3', name: '‡∏ä‡∏∏‡∏î‡∏ä‡∏≤‡∏ö‡∏π‡∏´‡∏°‡∏π‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390, img: 'https://images.unsplash.com/photo-1555126634-323283e090fa?auto=format&fit=crop&q=80&w=400' },
            { id: 'f4', name: '‡∏ä‡∏∏‡∏î‡∏ä‡∏≤‡∏ö‡∏π‡πÑ‡∏Å‡πà‡∏•‡∏∏‡∏á‡∏î‡∏≥', price: 390, img: 'https://images.unsplash.com/photo-1547496502-affa22d38842?auto=format&fit=crop&q=80&w=400' },
            { id: 'f5', name: '‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', price: 390, img: 'https://images.unsplash.com/photo-1559847844-5315695dadae?auto=format&fit=crop&q=80&w=400' }
        ];

        let state = {
            step: 1,
            checkin: '',
            checkout: '',
            rooms: roomData,
            foods: foodMenu,
            specialDates: [],
            promoCodes: [],
            selectedRooms: [],
            selectedFoods: [],
            activePromo: null,
            discountAmount: 0,
            total: 0,
            deposit: 0,
            bookings: []
        };

        async function init() {
            try {
                showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
                await liff.init({ liffId: LIFF_ID });
                const response = await fetch(APP_URL);
                const data = await response.json();
                state.specialDates = data.specialDates || [];
                state.promoCodes = data.promoCodes || [];
                state.bookings = data.bookings || [];
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                document.getElementById('checkin').valueAsDate = today;
                document.getElementById('checkout').valueAsDate = tomorrow;
                document.getElementById('checkin').min = today.toISOString().split('T')[0];
            } catch (err) { console.error(err); } 
            finally { hideLoading(); }
        }

        function updateUI() {
            for(let i=1; i<=4; i++) {
                const btn = document.getElementById(`step${i}-btn`);
                btn.className = `flex flex-col items-center text-xs ${state.step === i ? 'stepper-active' : 'text-gray-400'}`;
                document.getElementById(`step${i}`).classList.toggle('hidden', state.step !== i);
            }
            document.getElementById('prevBtn').classList.toggle('hidden', state.step === 1);
            document.getElementById('nextBtn').innerText = state.step === 4 ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ' : '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠';
            if(state.step === 2) renderRooms();
            if(state.step === 3) renderFoods();
            if(state.step === 4) renderSummary();
        }

        function nextStep() {
            if(state.step === 1) {
                state.checkin = document.getElementById('checkin').value;
                state.checkout = document.getElementById('checkout').value;
                if(!state.checkin || !state.checkout) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");
                if(new Date(state.checkin) >= new Date(state.checkout)) return alert("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô");
            }
            if(state.step === 2 && state.selectedRooms.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏´‡πâ‡∏≠‡∏á");
            if(state.step === 4) { submitBooking(); return; }
            state.step++;
            updateUI();
        }

        function prevStep() { state.step--; updateUI(); }

        function renderRooms() {
            const list = document.getElementById('roomList');
            list.innerHTML = '';
            state.rooms.forEach(room => {
                const isBooked = state.bookings.some(b => {
                    if(b.Status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') return false;
                    const bIn = new Date(b['CheckIn'] || b['Check-in']);
                    const bOut = new Date(b['CheckOut'] || b['Check-out']);
                    const sIn = new Date(state.checkin);
                    const sOut = new Date(state.checkout);
                    const roomInfo = b['RoomsInfo'] || b['Rooms'] || "";
                    return roomInfo.includes(room.name) && (sIn < bOut && sOut > bIn);
                });
                const isSelected = state.selectedRooms.find(r => r.id === room.id);
                const div = document.createElement('div');
                div.className = `bg-white rounded-2xl shadow-sm border overflow-hidden flex ${isBooked ? 'card-disabled' : (isSelected ? 'card-selected' : '')}`;
                let displayPrice = room.id === 'tent' ? '150 / ‡∏ó‡πà‡∏≤‡∏ô' : `${Object.values(room.rates)[0].toLocaleString()}+`;
                div.innerHTML = `
                    <img src="${room.img}" class="w-24 h-24 object-cover">
                    <div class="p-3 flex-1">
                        <div class="flex justify-between items-start">
                            <h3 class="font-semibold text-emerald-900">${room.name}</h3>
                            <span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full">‡∏û‡∏±‡∏Å‡πÑ‡∏î‡πâ ${room.max} ‡∏ó‡πà‡∏≤‡∏ô</span>
                        </div>
                        <p class="text-emerald-600 font-bold mt-1">‡∏ø${displayPrice}<span class="text-[10px] text-gray-400 font-normal"> / ‡∏Ñ‡∏∑‡∏ô</span></p>
                    </div>
                `;
                if(!isBooked) {
                    div.onclick = () => {
                        if(isSelected) state.selectedRooms = state.selectedRooms.filter(r => r.id !== room.id);
                        else state.selectedRooms.push(room);
                        renderRooms();
                    };
                }
                list.appendChild(div);
            });
        }

        function renderFoods() {
            const list = document.getElementById('foodList');
            list.innerHTML = '';
            state.foods.forEach(food => {
                const selected = state.selectedFoods.find(f => f.id === food.id);
                const div = document.createElement('div');
                div.className = `bg-white rounded-2xl p-3 border flex items-center gap-3 ${selected ? 'card-selected' : ''}`;
                div.innerHTML = `
                    <div class="w-16 h-16 bg-gray-100 rounded-xl overflow-hidden">
                        <img src="${food.img}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-800 text-sm">${food.name}</h4>
                        <p class="text-emerald-600 font-bold">‡∏ø${food.price}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        ${selected ? `
                            <button onclick="updateFood('${food.id}', -1)" class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center font-bold">-</button>
                            <span class="w-4 text-center font-semibold">${selected.quantity}</span>
                            <button onclick="updateFood('${food.id}', 1)" class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center font-bold">+</button>
                        ` : `
                            <button onclick="updateFood('${food.id}', 1)" class="bg-emerald-700 text-white px-4 py-1.5 rounded-xl text-xs font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                        `}
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function updateFood(id, delta) {
            const food = state.foods.find(f => f.id === id);
            const idx = state.selectedFoods.findIndex(f => f.id === id);
            if(idx > -1) {
                state.selectedFoods[idx].quantity += delta;
                if(state.selectedFoods[idx].quantity <= 0) state.selectedFoods.splice(idx, 1);
            } else if(delta > 0) {
                state.selectedFoods.push({...food, quantity: 1});
            }
            renderFoods();
        }

        function calculateTotal() {
            const nights = Math.max(1, (new Date(state.checkout) - new Date(state.checkin)) / (1000 * 60 * 60 * 24));
            
            // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å (Base rate)
            const roomsTotal = state.selectedRooms.reduce((sum, r) => {
                const baseRate = Object.values(r.rates)[0];
                return sum + baseRate;
            }, 0) * nights;

            // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£
            const foodsTotal = state.selectedFoods.reduce((sum, f) => sum + (f.price * f.quantity), 0);
            
            let total = roomsTotal + foodsTotal;
            let discount = 0;

            if(state.activePromo) {
                if(state.activePromo.type === '‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå') discount = (total * state.activePromo.value) / 100;
                else discount = state.activePromo.value;
            }

            state.discountAmount = discount;
            state.total = total - discount;

            // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà: ‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å 50% + ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 100%
            const roomDeposit = (roomsTotal - discount) * 0.5;
            state.deposit = Math.ceil(Math.max(0, roomDeposit) + foodsTotal);
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR Code ‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥
            const qrUrl = `https://promptpay.io/${PROMPTPAY_ID}/${state.deposit}.png`;
            document.getElementById('qrCodeImg').src = qrUrl;
        }

        function renderSummary() {
            calculateTotal();
            const formatDate = (d) => new Date(d).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
            document.getElementById('summaryDates').innerText = `${formatDate(state.checkin)} - ${formatDate(state.checkout)}`;
            document.getElementById('summaryRooms').innerText = state.selectedRooms.map(r => r.name).join(', ');
            const foodSummary = state.selectedFoods.length > 0 ? state.selectedFoods.map(f => `${f.name} (x${f.quantity})`).join('<br>') : '-';
            document.getElementById('summaryFoods').innerHTML = foodSummary;
            document.getElementById('summaryDiscount').innerText = `-‡∏ø${state.discountAmount.toLocaleString()}`;
            document.getElementById('summaryTotal').innerText = `‡∏ø${state.total.toLocaleString()}`;
            document.getElementById('depositAmount').innerText = `‡∏ø${state.deposit.toLocaleString()}`;
        }

        function applyPromo() {
            const code = document.getElementById('promoInput').value.toUpperCase();
            const found = state.promoCodes.find(p => p.code === code);
            const msg = document.getElementById('promoMsg');
            if(found) {
                state.activePromo = found;
                msg.innerText = "‚úì ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
                msg.className = "text-xs mt-1 text-emerald-600";
                renderSummary();
            } else {
                state.activePromo = null;
                msg.innerText = "‚úó ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
                msg.className = "text-xs mt-1 text-red-500";
                renderSummary();
            }
        }

        document.getElementById('slipFile').onchange = function(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('slipPreview').src = event.target.result;
                    document.getElementById('slipPreviewContainer').classList.remove('hidden');
                    document.getElementById('slipLabel').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        };

        function resetSlip() {
            document.getElementById('slipFile').value = "";
            document.getElementById('slipPreviewContainer').classList.add('hidden');
            document.getElementById('slipLabel').classList.remove('hidden');
        }

        async function submitBooking() {
            const name = document.getElementById('custName').value;
            const tel = document.getElementById('custTel').value;
            const slipFile = document.getElementById('slipFile').files[0];

            if(!name || !tel) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");
            if(!slipFile) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");

            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á...");

            const reader = new FileReader();
            reader.readAsDataURL(slipFile);
            reader.onload = async () => {
                try {
                    const response = await fetch(APP_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            custName: name,
                            custTel: tel,
                            checkin: state.checkin,
                            checkout: state.checkout,
                            rooms: JSON.stringify(state.selectedRooms),
                            foods: JSON.stringify(state.selectedFoods),
                            promoCode: state.activePromo ? state.activePromo.code : '',
                            discount: state.discountAmount,
                            total: state.total,
                            deposit: state.deposit,
                            slip: reader.result
                        })
                    });
                    const res = await response.json();
                    if(res.status === 'success') {
                        alert("‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î");
                        liff.closeWindow();
                    } else { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + res.message); }
                } catch (err) { alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ"); }
                finally { hideLoading(); }
            };
        }

        function showLoading(text) {
            document.getElementById('loadingText').innerText = text;
            document.getElementById('loading').classList.remove('hidden');
        }
        function hideLoading() { document.getElementById('loading').classList.add('hidden'); }

        window.onload = init;
    </script>
</body>
</html>
