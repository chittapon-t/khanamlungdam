<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á - Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
        .card-selected { border: 2px solid #059669; background-color: #ecfdf5; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 pb-20">
    <div id="app" class="max-w-md mx-auto min-h-screen relative">
        <!-- Header -->
        <div class="bg-emerald-700 text-white p-6 rounded-b-3xl shadow-lg">
            <h1 class="text-2xl font-bold">‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</h1>
            <p class="text-emerald-100 text-sm">‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥</p>
        </div>

        <!-- Stepper -->
        <div class="flex justify-around p-4 bg-white mx-4 -mt-6 rounded-xl shadow-sm border border-gray-100 text-xs font-semibold">
            <div id="step-1" class="stepper-active pb-1 border-b-2 border-emerald-600 text-emerald-700">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô</div>
            <div id="step-2" class="text-gray-400">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å/‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
            <div id="step-3" class="text-gray-400">3. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
        </div>

        <!-- Content Area -->
        <div id="main-content" class="p-4 fade-in">
            <!-- Phase 1: Date Selection -->
            <div id="phase-1" class="space-y-4">
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <label class="block text-gray-700 mb-2 font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</label>
                    <input type="date" id="checkin" class="w-full p-3 border rounded-lg mb-3 focus:ring-2 focus:ring-emerald-500 outline-none">
                    <label class="block text-gray-700 mb-2 font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å</label>
                    <input type="date" id="checkout" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
                </div>
                <button onclick="goToPhase2()" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á</button>
            </div>

            <!-- Phase 2: Selection -->
            <div id="phase-2" class="hidden space-y-6">
                <section>
                    <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">üè† ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</h3>
                    <div id="room-list" class="grid gap-4"></div>
                </section>

                <section>
                    <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">üç≤ ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</h3>
                    <div id="food-list" class="grid gap-3">
                        <!-- Food Item -->
                        <div class="bg-white p-4 rounded-xl shadow-sm flex items-center justify-between border">
                            <div>
                                <h4 class="font-semibold">‡∏ä‡∏∏‡∏î‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥</h4>
                                <p class="text-emerald-600 text-sm">350.- / ‡∏ä‡∏∏‡∏î</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button onclick="updateFood('‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞', -1)" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">-</button>
                                <span id="qty-‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞" class="font-bold w-4 text-center">0</span>
                                <button onclick="updateFood('‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞', 1)" class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm flex items-center justify-between border">
                            <div>
                                <h4 class="font-semibold">‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤</h4>
                                <p class="text-emerald-600 text-sm">120.- / ‡∏ó‡πà‡∏≤‡∏ô</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button onclick="updateFood('‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤', -1)" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">-</button>
                                <span id="qty-‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤" class="font-bold w-4 text-center">0</span>
                                <button onclick="updateFood('‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤', 1)" class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                    </div>
                </section>
                <button onclick="goToPhase3()" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>

            <!-- Phase 3: Confirmation -->
            <div id="phase-3" class="hidden space-y-4">
                <div class="bg-white p-4 rounded-xl shadow-sm space-y-3">
                    <h3 class="font-bold border-b pb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
                    <div id="summary" class="text-sm space-y-1"></div>
                    <div class="pt-2 border-t text-lg font-bold text-emerald-700 flex justify-between">
                        <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</span>
                        <span id="total-price">0</span>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm space-y-3">
                    <h3 class="font-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</h3>
                    <input type="text" id="custName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á" class="w-full p-3 border rounded-lg">
                    <input type="tel" id="custTel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full p-3 border rounded-lg">
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm space-y-3">
                    <h3 class="font-bold">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ (50%)</h3>
                    <div class="bg-gray-50 p-4 rounded-lg text-center border-2 border-dashed">
                        <p class="text-xs text-gray-500 uppercase">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</p>
                        <p class="text-xl font-bold text-blue-600">081-XXX-XXXX</p>
                        <p class="text-sm text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÉ‡∏à‡∏î‡∏µ</p>
                    </div>
                    <label class="block text-sm font-medium">‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</label>
                    <input type="file" id="slip" accept="image/*" class="w-full text-sm">
                </div>

                <button onclick="submitBooking()" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
            </div>
        </div>

        <!-- Success Modal -->
        <div id="success-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-6 z-50">
            <div class="bg-white rounded-3xl p-8 text-center space-y-4 max-w-sm w-full animate-in">
                <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto text-4xl">‚úì</div>
                <h2 class="text-2xl font-bold text-gray-800">‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                <p class="text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß <br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ</p>
                <button onclick="liff.closeWindow()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-md">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden fixed inset-0 bg-white/80 flex flex-col items-center justify-center z-50">
            <div class="w-12 h-12 border-4 border-emerald-600 border-t-transparent rounded-full animate-spin"></div>
            <p id="loadingText" class="mt-4 text-emerald-800 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyw4R8eB17X1f4E1jG-O65p46G0fXzX9X9X9X9X9X9X9X9X9/exec'; // ** ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô URL Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì **
        let state = {
            profile: null,
            rooms: [],
            bookings: [],
            selectedRooms: [],
            selectedFoods: {}, // { '‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞': 1, '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤': 2 }
            total: 0
        };

        async function init() {
            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...");
            try {
                await liff.init({ liffId: "2006764516-xQ8W7nJk" }); // ** ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì **
                if (!liff.isLoggedIn()) { liff.login(); return; }
                state.profile = await liff.getProfile();
                fetchData();
            } catch (err) { console.error(err); }
        }

        async function fetchData() {
            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å...");
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                state.rooms = data.rooms;
                state.bookings = data.bookings;
                hideLoading();
            } catch (err) { alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"); }
        }

        function goToPhase2() {
            const cin = document.getElementById('checkin').value;
            const cout = document.getElementById('checkout').value;
            if(!cin || !cout) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");
            
            state.checkin = cin;
            state.checkout = cout;
            
            renderRooms();
            document.getElementById('phase-1').classList.add('hidden');
            document.getElementById('phase-2').classList.remove('hidden');
            updateStepper(2);
        }

        function renderRooms() {
            const container = document.getElementById('room-list');
            container.innerHTML = state.rooms.map(room => {
                const isBooked = state.bookings.some(b => 
                    b.status === 'confirmed' && 
                    JSON.parse(b.rooms).includes(room.id) &&
                    !(state.checkout <= b.checkin || state.checkin >= b.checkout)
                );
                return `
                    <div onclick="${isBooked ? '' : `toggleRoom('${room.id}')`}" 
                         id="room-${room.id}"
                         class="p-4 rounded-xl border bg-white transition flex justify-between items-center ${isBooked ? 'opacity-50 grayscale cursor-not-allowed' : 'cursor-pointer'}">
                        <div>
                            <p class="font-bold text-lg">${room.name}</p>
                            <p class="text-xs text-gray-500">${room.type} ‚Ä¢ ‡∏û‡∏±‡∏Å‡πÑ‡∏î‡πâ ${room.cap} ‡∏ó‡πà‡∏≤‡∏ô</p>
                        </div>
                        <div class="text-right">
                            <p class="text-emerald-600 font-bold">${room.price.toLocaleString()}.-</p>
                            ${isBooked ? '<span class="text-[10px] bg-red-100 text-red-600 px-2 py-1 rounded">‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleRoom(id) {
            const idx = state.selectedRooms.indexOf(id);
            if(idx > -1) state.selectedRooms.splice(idx, 1);
            else state.selectedRooms.push(id);
            
            document.querySelectorAll(`[id^="room-"]`).forEach(el => el.classList.remove('card-selected'));
            state.selectedRooms.forEach(rid => document.getElementById(`room-${rid}`).classList.add('card-selected'));
        }

        function updateFood(name, change) {
            const current = state.selectedFoods[name] || 0;
            const newVal = Math.max(0, current + change);
            state.selectedFoods[name] = newVal;
            document.getElementById(`qty-${name}`).innerText = newVal;
        }

        function calculateTotal() {
            let roomPrice = state.rooms
                .filter(r => state.selectedRooms.includes(r.id))
                .reduce((sum, r) => sum + r.price, 0);
            
            let foodPrice = 0;
            if(state.selectedFoods['‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞']) foodPrice += (state.selectedFoods['‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞'] * 350);
            if(state.selectedFoods['‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤']) foodPrice += (state.selectedFoods['‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ä‡πâ‡∏≤'] * 120);

            return roomPrice + foodPrice;
        }

        function goToPhase3() {
            if(state.selectedRooms.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏´‡πâ‡∏≠‡∏á");
            state.total = calculateTotal();
            
            const summary = document.getElementById('summary');
            const roomNames = state.rooms.filter(r => state.selectedRooms.includes(r.id)).map(r => r.name).join(', ');
            
            let foodSummary = "";
            for (const [name, qty] of Object.entries(state.selectedFoods)) {
                if(qty > 0) foodSummary += `<p>‚Ä¢ ${name} x ${qty}</p>`;
            }

            summary.innerHTML = `
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${state.checkin} ‡∏ñ‡∏∂‡∏á ${state.checkout}</p>
                <p><strong>‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å:</strong> ${roomNames}</p>
                ${foodSummary}
            `;
            document.getElementById('total-price').innerText = state.total.toLocaleString() + " ‡∏ö‡∏≤‡∏ó";
            
            document.getElementById('phase-2').classList.add('hidden');
            document.getElementById('phase-3').classList.remove('hidden');
            updateStepper(3);
        }

        async function submitBooking() {
            const name = document.getElementById('custName').value;
            const tel = document.getElementById('custTel').value;
            const slipFile = document.getElementById('slip').files[0];

            if(!name || !tel || !slipFile) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ");

            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á...");
            
            const reader = new FileReader();
            reader.readAsDataURL(slipFile);
            reader.onload = async () => {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'booking',
                            userId: state.profile.userId,
                            lineName: state.profile.displayName,
                            custName: name,
                            custTel: tel,
                            checkin: state.checkin,
                            checkout: state.checkout,
                            rooms: JSON.stringify(state.selectedRooms),
                            foods: JSON.stringify(state.selectedFoods), // ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                            total: state.total,
                            deposit: state.total * 0.5,
                            slip: reader.result
                        })
                    });
                    const res = await response.json();
                    if(res.status === 'success') {
                        document.getElementById('success-modal').classList.remove('hidden');
                    } else {
                        alert("Error: " + res.message);
                    }
                } catch (err) { alert("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
                finally { hideLoading(); }
            };
        }

        function updateStepper(step) {
            for(let i=1; i<=3; i++) {
                const el = document.getElementById(`step-${i}`);
                el.className = (i === step) ? 'stepper-active pb-1 border-b-2 border-emerald-600 text-emerald-700' : 'text-gray-400';
            }
        }

        function showLoading(text) {
            document.getElementById('loadingText').innerText = text;
            document.getElementById('loading').classList.remove('hidden');
        }
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        window.onload = init;
    </script>
</body>
</html>
