<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å - ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8f9fa; }
        .camping-green { background-color: #1b4332; }
        .camping-brown { background-color: #6d4c41; }
        .step-card { display: none; }
        .step-card.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#fefae0] text-gray-800">

    <!-- Header -->
    <header class="camping-green text-white p-6 shadow-xl rounded-b-[40px] text-center">
        <h1 class="text-2xl font-bold">‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</h1>
        <p class="text-sm opacity-90">‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡∏Ç‡∏ô‡∏≥ ‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ ‡∏ó‡πà‡∏≤‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥</p>
    </header>

    <main class="max-w-md mx-auto p-4 pb-20">
        <!-- Progress Bar -->
        <div class="flex justify-between mb-6 px-4">
            <div class="h-1 w-full bg-gray-200 relative rounded">
                <div id="progress" class="h-1 bg-green-700 w-1/4 transition-all duration-300 rounded"></div>
            </div>
        </div>

        <!-- Step 1: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å -->
        <section id="step1" class="step-card active space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border-t-4 border-green-800">
                <h2 class="font-bold text-lg mb-3 flex items-center">üóìÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-500">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</label>
                        <input type="date" id="checkIn" class="w-full border p-2 rounded-lg" min="" onchange="validateDates()">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå</label>
                        <input type="date" id="checkOut" class="w-full border p-2 rounded-lg" onchange="validateDates()">
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm border-t-4 border-green-800">
                <h2 class="font-bold text-lg mb-3">üè° ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</h2>
                <div id="roomContainer" class="space-y-3">
                    <!-- Room items will be rendered here -->
                </div>
            </div>
            
            <button onclick="goToStep(2)" id="btnStep1" class="w-full camping-green text-white py-4 rounded-xl font-bold shadow-lg">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </section>

        <!-- Step 2: ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ -->
        <section id="step2" class="step-card space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm">
                <h2 class="font-bold text-lg mb-3 text-camping-green">üç≤ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡πÄ‡∏™‡∏£‡∏¥‡∏°)</h2>
                <div id="foodContainer" class="space-y-4">
                    <!-- Food items will be rendered here -->
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="goToStep(1)" class="w-1/3 bg-gray-200 py-4 rounded-xl font-bold">‡∏Å‡∏•‡∏±‡∏ö</button>
                <button onclick="goToStep(3)" class="w-2/3 camping-green text-white py-4 rounded-xl font-bold">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
        </section>

        <!-- Step 3: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô -->
        <section id="step3" class="step-card space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm">
                <h2 class="font-bold mb-3">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</h2>
                <input type="text" id="custName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á" class="w-full border p-3 rounded-lg mb-3">
                <input type="tel" id="custPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" class="w-full border p-3 rounded-lg mb-3">
                <input type="text" id="discountCode" placeholder="‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="w-full border p-3 rounded-lg">
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm border-2 border-dashed border-green-800">
                <h2 class="font-bold text-center mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥</h2>
                <div id="summaryDisplay" class="text-sm space-y-1 mb-4"></div>
                <div class="text-center p-4 bg-gray-50 rounded-xl">
                    <p class="text-xs text-gray-500">‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏≠‡∏ô</p>
                    <p id="depositDisplay" class="text-3xl font-bold text-red-600">‡∏ø0</p>
                </div>
                <div class="mt-4 text-center">
                    <p class="text-xs font-bold mb-2">‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô PromptPay</p>
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=00020101021129370016A000000677010111011300666159242625802TH53037646304" class="mx-auto w-48 rounded shadow-sm">
                    <p class="text-[10px] mt-2 text-gray-400">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏≠‡∏•‡∏á‡∏Å‡∏ï ‡∏ó‡∏ß‡∏µ‡∏ú‡πà‡∏≠‡∏á</p>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-bold mb-2">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <input type="file" id="slipInput" accept="image/*" class="w-full text-sm">
                </div>
            </div>

            <div class="flex items-center gap-2 p-2">
                <input type="checkbox" id="terms">
                <label for="terms" class="text-xs text-gray-600">‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</label>
            </div>

            <button onclick="finalSubmit()" id="btnSubmit" class="w-full camping-green text-white py-4 rounded-xl font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
        </section>
    </main>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwb9VWt0rQYJ2dJa9jQKM23YRKsx-YReKnqJTiqGRbg26jEMtPP-RzxDbe_BahxUiSu5g/exec"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const LIFF_ID = "2008863563-tuai5kaC";
        
        let state = {
            lineId: '', lineName: '',
            specialDays: [], discounts: [], closedDays: [],
            rooms: [
                { id: 1, name: "‡πÇ‡∏Æ‡∏°‡∏™‡πÄ‡∏ï‡∏¢‡πå‡∏´‡∏ô‡∏≥‡πÇ‡∏õ", prices: { '4-5': 1600, '6-8': 2200 }, minGuests: 4, maxGuests: 8 },
                { id: 2, name: "‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ 1", prices: { '1-2': 1400, '3': 1750 }, minGuests: 1, maxGuests: 3 },
                { id: 3, name: "‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ 2", prices: { '1-2': 1400, '3': 1750 }, minGuests: 1, maxGuests: 3 },
                { id: 4, name: "‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏° 1", prices: { '1-2': 1200, '3-4': 1550 }, minGuests: 1, maxGuests: 4 },
                { id: 5, name: "‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏° 2", prices: { '1-2': 1200, '3-4': 1550 }, minGuests: 1, maxGuests: 4 },
                { id: 6, name: "‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏ô‡∏≤‡∏° K1", prices: { 'default': 700 }, minGuests: 1, maxGuests: 2 },
                { id: 7, name: "‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏™‡∏ô‡∏≤‡∏° K2", prices: { 'default': 700 }, minGuests: 1, maxGuests: 2 },
                { id: 8, name: "‡∏•‡∏≤‡∏ô‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå", prices: { 'perPerson': 150 }, minGuests: 1, maxGuests: 20 }
            ],
            foods: [
                { id: 1, name: "‡∏ä‡∏∏‡∏î‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥", price: 390 },
                { id: 2, name: "‡∏ä‡∏∏‡∏î‡πÑ‡∏Å‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏•‡∏∏‡∏á‡∏î‡∏≥", price: 390 },
                { id: 3, name: "‡∏ä‡∏∏‡∏î‡∏ä‡∏≤‡∏ö‡∏π‡∏´‡∏°‡∏π‡∏•‡∏∏‡∏á‡∏î‡∏≥", price: 390 },
                { id: 4, name: "‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô", price: 390 }
            ],
            selectedRooms: [],
            selectedFoods: {},
            currentStep: 1
        };

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) liff.login();
                const profile = await liff.getProfile();
                state.lineId = profile.userId;
                state.lineName = profile.displayName;
                
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('checkIn').min = today;
                
                fetchInitialData();
                renderRooms();
                renderFoods();
            } catch (e) { console.error("LIFF Init Error", e); }
        }

        async function fetchInitialData() {
            const resp = await fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getInitialData' })
            });
            const data = await resp.json();
            state.specialDays = data.specialDays;
            state.discounts = data.discounts;
            state.closedDays = data.closedDays;
        }

        function renderRooms() {
            const container = document.getElementById('roomContainer');
            container.innerHTML = state.rooms.map(room => `
                <div class="flex items-center justify-between p-3 border rounded-xl hover:bg-green-50">
                    <div class="flex-1">
                        <p class="font-bold">${room.name}</p>
                        <p class="text-[10px] text-gray-500">${room.minGuests}-${room.maxGuests} ‡∏ó‡πà‡∏≤‡∏ô</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="number" id="guest-${room.id}" min="0" max="${room.maxGuests}" placeholder="‡∏Ñ‡∏ô" class="w-14 text-center border rounded">
                        <input type="checkbox" onchange="toggleRoom(${room.id})" id="check-${room.id}" class="w-5 h-5 accent-green-800">
                    </div>
                </div>
            `).join('');
        }

        function renderFoods() {
            const container = document.getElementById('foodContainer');
            container.innerHTML = state.foods.map(food => `
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-bold text-sm">${food.name}</p>
                        <p class="text-xs text-green-700">‡∏ø${food.price}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateFood(${food.id}, -1)" class="w-8 h-8 bg-gray-100 rounded-full">-</button>
                        <span id="foodQty-${food.id}" class="w-6 text-center">0</span>
                        <button onclick="updateFood(${food.id}, 1)" class="w-8 h-8 bg-gray-100 rounded-full">+</button>
                    </div>
                </div>
            `).join('');
        }

        function updateFood(id, delta) {
            state.selectedFoods[id] = Math.max(0, (state.selectedFoods[id] || 0) + delta);
            document.getElementById(`foodQty-${id}`).innerText = state.selectedFoods[id];
            calculatePrice();
        }

        function goToStep(s) {
            if (s === 2 && !validateStep1()) return;
            state.currentStep = s;
            document.querySelectorAll('.step-card').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + s).classList.add('active');
            document.getElementById('progress').style.width = (s * 33.33) + '%';
            if (s === 3) calculatePrice();
        }

        function validateStep1() {
            const cin = document.getElementById('checkIn').value;
            const cout = document.getElementById('checkOut').value;
            if (!cin || !cout) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return false; }
            state.selectedRooms = [];
            state.rooms.forEach(r => {
                if (document.getElementById(`check-${r.id}`).checked) {
                    const guests = parseInt(document.getElementById(`guest-${r.id}`).value);
                    if (!guests || guests < r.minGuests) {
                        alert(`‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ô ${r.name} ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (${r.minGuests}-${r.maxGuests} ‡∏Ñ‡∏ô)`);
                        return false;
                    }
                    state.selectedRooms.push({ ...r, currentGuests: guests });
                }
            });
            if (state.selectedRooms.length === 0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏´‡πâ‡∏≠‡∏á"); return false; }
            return true;
        }

        function calculatePrice() {
            let basePrice = 0;
            state.selectedRooms.forEach(r => {
                if (r.id === 8) basePrice += (r.currentGuests * 150);
                else if (r.id >= 6) basePrice += 700;
                else {
                    const g = r.currentGuests;
                    if (r.name.includes("‡∏´‡∏ô‡∏≥‡πÇ‡∏õ")) basePrice += (g <= 5 ? 1600 : 2200);
                    if (r.name.includes("‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥")) basePrice += (g <= 2 ? 1400 : 1750);
                    if (r.name.includes("‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå‡∏Å‡∏£‡∏∞‡πÇ‡∏à‡∏°")) basePrice += (g <= 2 ? 1200 : 1550);
                }
            });

            let foodPrice = 0;
            state.foods.forEach(f => {
                foodPrice += (state.selectedFoods[f.id] || 0) * f.price;
            });

            const total = basePrice + foodPrice;
            // Check Special Day for 100% deposit
            const cin = document.getElementById('checkIn').value;
            const isSpecial = state.specialDays.some(d => d[0] === cin.split('-').reverse().join('/'));
            const deposit = isSpecial ? total : total * 0.5;

            document.getElementById('depositDisplay').innerText = `‡∏ø${deposit.toLocaleString()}`;
            document.getElementById('summaryDisplay').innerHTML = `
                <div class="flex justify-between"><span>‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å:</span><span>‡∏ø${basePrice.toLocaleString()}</span></div>
                <div class="flex justify-between"><span>‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</span><span>‡∏ø${foodPrice.toLocaleString()}</span></div>
                <div class="flex justify-between font-bold"><span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</span><span>‡∏ø${total.toLocaleString()}</span></div>
            `;
            
            state.lastCalculated = { total, deposit, balance: total - deposit, basePrice };
        }

        async function finalSubmit() {
            if (!document.getElementById('terms').checked) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç");
            const slipFile = document.getElementById('slipInput').files[0];
            if (!slipFile) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ");

            document.getElementById('btnSubmit').disabled = true;
            document.getElementById('btnSubmit').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

            const reader = new FileReader();
            reader.readAsDataURL(slipFile);
            reader.onload = async () => {
                const payload = {
                    action: 'submitBooking',
                    lineId: state.lineId,
                    lineName: state.lineName,
                    customerName: document.getElementById('custName').value,
                    phone: document.getElementById('custPhone').value,
                    rooms: state.selectedRooms.map(r => r.name),
                    totalGuests: state.selectedRooms.reduce((a,b) => a+b.currentGuests, 0),
                    foods: Object.keys(state.selectedFoods).filter(k => state.selectedFoods[k]>0).map(k => state.foods.find(f => f.id == k).name),
                    foodQty: Object.keys(state.selectedFoods).filter(k => state.selectedFoods[k]>0).map(k => state.selectedFoods[k]),
                    checkIn: document.getElementById('checkIn').value,
                    checkOut: document.getElementById('checkOut').value,
                    basePrice: state.lastCalculated.basePrice,
                    totalPrice: state.lastCalculated.total,
                    deposit: state.lastCalculated.deposit,
                    balance: state.lastCalculated.balance,
                    slipBase64: reader.result.split(',')[1],
                    slipType: slipFile.type
                };

                const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();
                if (result.success) {
                    alert("‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE");
                    liff.closeWindow();
                } else {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + result.error);
                }
            };
        }

        init();
    </script>
</body>
</html>
