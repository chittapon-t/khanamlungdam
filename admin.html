<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô - ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; padding-bottom: 100px; }
        .tab-active { color: #059669 !important; border-top: 4px solid #059669; background: #f0fdf4; }
        .card-confirmed { border-left: 8px solid #10b981; }
        .card-pending { border-left: 8px solid #f59e0b; }
        .card-canceled { border-left: 8px solid #ef4444; opacity: 0.8; }
        .animate-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #calendar { background: white; border-radius: 1.5rem; padding: 15px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .fc-toolbar-title { font-size: 1.1rem !important; font-weight: bold; color: #064e3b; }
        .fc-button { background: #065f46 !important; border: none !important; font-size: 0.8rem !important; }
        ::-webkit-scrollbar { display: none; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:active { transform: scale(0.95); }
        .filter-btn-active { background-color: #065f46; color: white; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center hidden backdrop-blur-sm">
        <div class="bg-white p-8 rounded-3xl text-center shadow-2xl">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-emerald-600 border-t-transparent mx-auto"></div>
            <p class="mt-4 font-bold text-emerald-900" id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-emerald-900 text-white p-5 sticky top-0 z-40 shadow-xl flex justify-between items-center rounded-b-[2rem]">
        <div>
            <h1 class="font-bold text-xl" id="headerTitle">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h1>
            <p class="text-[10px] text-emerald-300 tracking-widest uppercase opacity-80">Management System v2.7</p>
        </div>
        <div class="flex gap-2">
             <button onclick="fetchData()" class="p-3 bg-emerald-800 rounded-2xl active:scale-90 transition-all">
                <svg class="w-6 h-6 text-emerald-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2.5" stroke-linecap="round"/></svg>
            </button>
        </div>
    </header>

    <main class="p-4 max-w-2xl mx-auto min-h-screen">
        
        <!-- Section: ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î -->
        <section id="tab-home" class="tab-content hidden animate-in space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100 stat-card">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <h2 id="stat-today-bookings" class="text-3xl font-bold text-emerald-700 mt-1">0</h2>
                </div>
                <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100 stat-card">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                    <h2 id="stat-pending-bookings" class="text-3xl font-bold text-orange-500 mt-1">0</h2>
                </div>
                <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100 stat-card col-span-2">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß)</p>
                    <h2 id="stat-monthly-revenue" class="text-3xl font-bold text-slate-800 mt-1">‡∏ø0</h2>
                </div>
            </div>

            <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à -->
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                <h3 class="font-bold text-emerald-900 mb-4 flex items-center justify-between">
                    <span class="flex items-center gap-2">‚è≥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>
                    <button onclick="switchTab('bookings', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'); filterStatus = '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'; renderCards();" class="text-xs text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </h3>
                <div id="quick-pending-list" class="space-y-3">
                    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏î‡πâ‡∏ß‡∏¢ JS -->
                </div>
            </div>
        </section>

        <!-- Section: ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô -->
        <section id="tab-calendar" class="tab-content hidden animate-in">
            <div id="calendar" class="mb-4"></div>
            <div class="bg-white p-4 rounded-2xl border border-slate-200 grid grid-cols-2 gap-2 text-[10px] font-bold">
                <div class="flex items-center bg-emerald-50 p-2 rounded-xl"><span class="w-3 h-3 bg-emerald-500 rounded-full mr-2"></span> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
                <div class="flex items-center bg-orange-50 p-2 rounded-xl"><span class="w-3 h-3 bg-orange-400 rounded-full mr-2"></span> ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
            </div>
        </section>

        <!-- Section: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
        <section id="tab-bookings" class="tab-content hidden space-y-4 animate-in">
            <!-- Search & Filter -->
            <div class="space-y-3">
                <div class="relative">
                    <input type="text" id="searchBooking" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ö‡∏≠‡∏£‡πå, ID ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á..." 
                           class="w-full p-4 pl-12 rounded-2xl border-none shadow-sm bg-white focus:ring-2 focus:ring-emerald-500 transition-all"
                           onkeyup="renderCards()">
                    <svg class="w-6 h-6 absolute left-4 top-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2"/></svg>
                </div>
                
                <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                    <button onclick="setFilter('all')" id="filter-all" class="filter-btn-active whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold border border-slate-200 transition-all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button onclick="setFilter('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')" id="filter-pending" class="bg-white whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold border border-slate-200 transition-all">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
                    <button onclick="setFilter('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß')" id="filter-confirmed" class="bg-white whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold border border-slate-200 transition-all">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
                </div>
            </div>

            <div id="allBookingCards" class="space-y-4"></div>
        </section>

        <!-- Section: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ -->
        <section id="tab-settings" class="tab-content hidden space-y-6 animate-in">
            <!-- Promo Codes -->
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                <h3 class="font-bold text-emerald-900 mb-4 flex items-center">
                    <span class="mr-2 text-xl">üéüÔ∏è</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
                </h3>
                <div class="space-y-3">
                    <input type="text" id="promoCode" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏Ñ‡πâ‡∏î (‡πÄ‡∏ä‡πà‡∏ô SUMMER20)" class="w-full bg-slate-50 p-3 rounded-xl border-none focus:ring-2 focus:ring-emerald-500">
                    <div class="flex gap-2">
                        <input type="number" id="promoValue" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏î" class="flex-1 bg-slate-50 p-3 rounded-xl border-none">
                        <select id="promoType" class="w-24 bg-slate-50 p-3 rounded-xl border-none font-bold text-emerald-700">
                            <option value="‡∏ö‡∏≤‡∏ó">‡∏ö‡∏≤‡∏ó</option>
                            <option value="%">%</option>
                        </select>
                    </div>
                    <button onclick="addPromoCode()" class="w-full bg-emerald-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-emerald-100 active:scale-95 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà</button>
                </div>
                <div id="promoList" class="mt-6 space-y-2 border-t pt-4"></div>
            </div>

            <!-- Special Dates -->
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                <h3 class="font-bold text-emerald-900 mb-4 flex items-center">
                    <span class="mr-2 text-xl">üìÖ</span> ‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏°‡∏±‡∏î‡∏à‡∏≥ 100%)
                </h3>
                <div class="flex gap-2 mb-4">
                    <input type="date" id="newSpecialDate" class="flex-1 bg-slate-50 p-3 rounded-xl border-none">
                    <button onclick="addSpecialDate()" class="bg-emerald-600 text-white px-6 rounded-xl font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
                <div id="specialDateList" class="flex flex-wrap gap-2"></div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-100 p-2 flex justify-around z-50">
        <button onclick="switchTab('home', '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î')" id="nav-home" class="flex-1 flex flex-col items-center py-2 transition-all rounded-2xl text-slate-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" stroke-width="2"/></svg>
            <span class="text-[10px] mt-1 font-bold">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
        </button>
        <button onclick="switchTab('calendar', '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô')" id="nav-calendar" class="flex-1 flex flex-col items-center py-2 transition-all rounded-2xl text-slate-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="2"/></svg>
            <span class="text-[10px] mt-1 font-bold">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</span>
        </button>
        <button onclick="switchTab('bookings', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á')" id="nav-bookings" class="flex-1 flex flex-col items-center py-2 transition-all rounded-2xl text-slate-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h7" stroke-width="2"/></svg>
            <span class="text-[10px] mt-1 font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </button>
        <button onclick="switchTab('settings', '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤')" id="nav-settings" class="flex-1 flex flex-col items-center py-2 transition-all rounded-2xl text-slate-400">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke-width="2"/></svg>
            <span class="text-[10px] mt-1 font-bold">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
        </button>
    </nav>

    <script>
        // API URL ‡∏à‡∏≤‡∏Å Google Apps Script
        const API_URL = "https://script.google.com/macros/s/AKfycbwb9VWt0rQYJ2dJa9jQKM23YRKsx-YReKnqJTiqGRbg26jEMtPP-RzxDbe_BahxUiSu5g/exec";
        
        let allData = [];
        let specialDates = [];
        let promoCodes = [];
        let calendar = null;
        let filterStatus = 'all';

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ UI Tabs
        function switchTab(tab, title) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.getElementById('headerTitle').innerText = title;
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('tab-active', 'text-slate-400'));
            document.getElementById(`nav-${tab}`).classList.add('tab-active');
            
            if(tab === 'calendar') {
                setTimeout(() => {
                    if (!calendar) initCalendar();
                    calendar.render();
                    calendar.updateSize();
                }, 100);
            }
            window.scrollTo(0,0);
        }

        // ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        function setFilter(status) {
            filterStatus = status;
            document.querySelectorAll('#tab-bookings button').forEach(b => b.classList.remove('filter-btn-active', 'bg-white'));
            const btnId = status === 'all' ? 'filter-all' : (status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' ? 'filter-pending' : 'filter-confirmed');
            document.getElementById(btnId).classList.add('filter-btn-active');
            renderCards();
        }

        // ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
        function initCalendar() {
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth',
                locale: 'th',
                height: 'auto',
                headerToolbar: { left: 'prev,next', center: 'title', right: 'today' },
                events: prepareEvents(),
                eventClick: (info) => {
                    document.getElementById('searchBooking').value = info.event.extendedProps.id;
                    switchTab('bookings', '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    setFilter('all');
                }
            });
        }

        function prepareEvents() {
            return allData.filter(i => i.Status !== '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å').map(item => {
                const start = new Date(item.CheckIn);
                const end = new Date(item.CheckOut);
                const displayEnd = new Date(end);
                displayEnd.setDate(displayEnd.getDate() + 1);
                
                return {
                    title: `${item.Rooms.substring(0,5)}..: ${item.CustomerName}`,
                    start: start.toISOString().split('T')[0],
                    end: displayEnd.toISOString().split('T')[0],
                    color: item.Status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' ? '#10b981' : '#fbbf24',
                    extendedProps: { id: item.BookingID }
                };
            });
        }

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        async function fetchData() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                allData = data.bookings || [];
                specialDates = data.specialDates || [];
                promoCodes = data.promoCodes || [];

                allData.sort((a,b) => new Date(a.CheckIn) - new Date(b.CheckIn));

                updateStats();
                renderCards();
                renderSettings();
                if(calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(prepareEvents());
                }
            } catch (e) {
                console.error(e);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function updateStats() {
            const todayStr = new Date().toISOString().split('T')[0];
            const now = new Date();
            
            const todayBookings = allData.filter(i => i.CheckIn.includes(todayStr)).length;
            const pendingList = allData.filter(i => i.Status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
            const monthlyRevenue = allData
                .filter(i => {
                    const d = new Date(i.CheckIn);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear() && i.Status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                })
                .reduce((sum, item) => sum + Number(item.Deposit), 0);

            document.getElementById('stat-today-bookings').innerText = todayBookings;
            document.getElementById('stat-pending-bookings').innerText = pendingList.length;
            document.getElementById('stat-monthly-revenue').innerText = '‡∏ø' + monthlyRevenue.toLocaleString();

            const quickList = document.getElementById('quick-pending-list');
            if(pendingList.length === 0) {
                quickList.innerHTML = `<p class="text-center text-slate-400 py-6 text-xs italic">‡πÄ‡∏¢‡πâ! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>`;
            } else {
                quickList.innerHTML = pendingList.slice(0, 5).map(item => `
                    <div class="flex items-center justify-between p-4 bg-orange-50/50 rounded-2xl border border-orange-100">
                        <div>
                            <p class="font-bold text-sm text-slate-800">${item.CustomerName}</p>
                            <p class="text-[10px] text-slate-500">${item.Rooms} ‚Ä¢ ${new Date(item.CheckIn).toLocaleDateString('th-TH')}</p>
                        </div>
                        <button onclick="viewBookingDetail('${item.BookingID}')" class="bg-orange-500 text-white px-4 py-2 rounded-xl text-[10px] font-bold shadow-sm active:scale-95">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏•‡∏¥‡∏õ</button>
                    </div>
                `).join('');
            }
        }

        function viewBookingDetail(id) {
            document.getElementById('searchBooking').value = id;
            setFilter('all');
            switchTab('bookings', '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        }

        // Render Cards
        function renderCards() {
            const query = document.getElementById('searchBooking').value.toLowerCase();
            const container = document.getElementById('allBookingCards');
            
            let filtered = allData.filter(i => 
                (i.CustomerName || "").toLowerCase().includes(query) || 
                (i.BookingID || "").toLowerCase().includes(query) ||
                (i.Tel || "").includes(query)
            );

            if(filterStatus !== 'all') {
                filtered = filtered.filter(i => i.Status === filterStatus);
            }

            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-slate-400 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>`;
                return;
            }

            container.innerHTML = filtered.map(item => {
                let foods = [];
                try { foods = JSON.parse(item.Foods || "[]"); } catch(e) { foods = []; }
                const foodHtml = foods.map(f => `
                    <div class="flex justify-between border-b border-dashed border-slate-200 py-1">
                        <span>${f.name}</span>
                        <span class="font-bold">x${f.qty}</span>
                    </div>
                `).join('');
                
                const cin = new Date(item.CheckIn).toLocaleDateString('th-TH', { day:'numeric', month:'short', year:'2-digit' });
                const cout = new Date(item.CheckOut).toLocaleDateString('th-TH', { day:'numeric', month:'short', year:'2-digit' });

                return `
                <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100 ${item.Status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' ? 'card-confirmed' : 'card-pending'} animate-in">
                    <div class="flex justify-between items-start mb-4">
                        <div class="max-w-[70%]">
                            <p class="text-[9px] text-emerald-600 font-bold uppercase tracking-widest">${item.BookingID}</p>
                            <h3 class="font-bold text-lg text-slate-800 truncate">${item.CustomerName}</h3>
                            <div class="flex flex-wrap gap-1 mt-1">
                                <span class="text-[10px] bg-slate-100 text-slate-600 px-2 py-1 rounded-lg">üìû ${item.Tel || '-'}</span>
                                <span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded-lg">üë§ ${item.Guests || 1} ‡∏ó‡πà‡∏≤‡∏ô</span>
                            </div>
                        </div>
                        <span class="text-[10px] px-3 py-1.5 rounded-full font-bold shadow-sm ${item.Status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' ? 'bg-emerald-500 text-white' : 'bg-orange-400 text-white'}">
                            ${item.Status}
                        </span>
                    </div>
                    
                    <div class="bg-slate-50 p-4 rounded-2xl text-xs space-y-2 mb-4">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-400">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</span>
                            <span class="font-bold text-emerald-900 bg-white px-2 py-1 rounded-lg border border-slate-100">${cin} - ${cout}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-400">‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å:</span>
                            <span class="font-bold text-right">${item.Rooms}</span>
                        </div>
                        <div class="pt-2 border-t border-slate-200">
                            <p class="text-slate-400 mb-2 font-bold uppercase text-[9px]">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á:</p>
                            ${foodHtml || '<p class="italic text-slate-300">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>'}
                        </div>
                    </div>

                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-[9px] text-slate-400 uppercase font-bold">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô‡∏°‡∏≤</p>
                            <p class="text-2xl font-bold text-emerald-700">‡∏ø${Number(item.Deposit).toLocaleString()}</p>
                        </div>
                        <div class="flex gap-2">
                             <a href="${item.SlipURL}" target="_blank" class="bg-slate-800 text-white px-4 py-3 rounded-xl text-[10px] font-bold active:scale-95 shadow-lg">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a>
                             <button onclick="deleteItem('${item.BookingID}')" class="bg-red-50 text-red-500 p-3 rounded-xl active:scale-95 border border-red-100">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2" stroke-linecap="round"/></svg>
                             </button>
                        </div>
                    </div>
                    ${item.Status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' ? `
                        <button onclick="confirmBooking('${item.BookingID}')" class="w-full mt-4 bg-emerald-600 text-white py-4 rounded-2xl font-bold text-sm shadow-xl shadow-emerald-100 active:scale-95">
                            ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏™‡πà‡∏á LINE ‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)
                        </button>
                    ` : ''}
                </div>
                `;
            }).join('');
        }

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Settings
        function renderSettings() {
            const dateList = document.getElementById('specialDateList');
            dateList.innerHTML = specialDates.map(date => `
                <div class="bg-white text-orange-700 px-4 py-2 rounded-xl text-xs font-bold border border-orange-200 flex items-center shadow-sm">
                    <span>${new Date(date).toLocaleDateString('th-TH')}</span>
                    <button onclick="removeSetting('date', '${date}')" class="ml-2 text-orange-300 hover:text-red-500 font-bold text-lg">&times;</button>
                </div>
            `).join('') || '<p class="text-[10px] text-slate-400 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</p>';

            const pList = document.getElementById('promoList');
            pList.innerHTML = promoCodes.map(p => `
                <div class="bg-white border border-slate-100 rounded-2xl p-4 flex justify-between items-center shadow-sm">
                    <div>
                        <span class="font-bold text-emerald-800 text-sm">${p.code}</span>
                        <p class="text-[10px] text-slate-500">‡∏•‡∏î ${Number(p.value).toLocaleString()} ${p.type}</p>
                    </div>
                    <button onclick="removeSetting('promo', '${p.code}')" class="text-red-400 p-2 hover:bg-red-50 rounded-xl transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg>
                    </button>
                </div>
            `).join('') || '<p class="text-xs text-slate-400 text-center py-4 italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</p>';
        }

        // Actions
        async function runAction(data, loadingMsg) {
            document.getElementById('loadingText').innerText = loadingMsg;
            document.getElementById('loading').classList.remove('hidden');
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
                const result = await response.json();
                if(result.status === 'success') {
                    await fetchData();
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.message);
                }
            } catch (e) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function confirmBooking(id) {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏™‡∏•‡∏¥‡∏õ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á? ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á LINE ‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ')) return;
            runAction({ action: 'updateStatus', bookingId: id, status: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...');
        }

        function deleteItem(id) {
            if(!confirm('üö® ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ?\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheet ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£')) return;
            runAction({ action: 'deleteBooking', bookingId: id }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
        }

        function addPromoCode() {
            const code = document.getElementById('promoCode').value.trim().toUpperCase();
            const value = document.getElementById('promoValue').value;
            const type = document.getElementById('promoType').value;
            if(!code || !value) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
            runAction({ action: 'addPromo', code, value, type }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î...');
            document.getElementById('promoCode').value = '';
            document.getElementById('promoValue').value = '';
        }

        function addSpecialDate() {
            const date = document.getElementById('newSpecialDate').value;
            if(!date) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
            runAction({ action: 'addSpecialDate', date }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©...');
        }

        function removeSetting(type, id) {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?')) return;
            runAction({ action: 'removeSetting', type, id }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...');
        }

        window.onload = () => {
            fetchData();
            switchTab('home', '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î');
        };
    </script>
</body>
</html>
