<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - ขนำลุงดำ แคมป์ปิ้ง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
        .booking-card:active { transform: scale(0.98); transition: transform 0.1s; }
        
        /* สไตล์สำหรับการสลับมุมมอง */
        @media (max-width: 768px) {
            .desktop-table { display: none; }
            .mobile-cards { display: block; }
        }
        @media (min-width: 769px) {
            .desktop-table { display: table; }
            .mobile-cards { display: none; }
        }
        
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-gray-50 pb-20">

    <!-- Sticky Navigation -->
    <nav class="bg-red-800 text-white p-4 sticky top-0 z-40 flex justify-between items-center shadow-md">
        <div class="flex items-center gap-2">
            <span class="bg-white text-red-800 p-1.5 rounded-lg font-bold text-xs uppercase">Admin</span>
            <h1 class="text-lg font-bold">ขนำลุงดำ</h1>
        </div>
        <button onclick="loadData()" class="bg-red-700 hover:bg-red-600 active:bg-red-900 px-4 py-2 rounded-xl text-sm font-semibold shadow-inner flex items-center gap-2 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            รีเฟรช
        </button>
    </nav>

    <div class="container mx-auto p-4 max-w-6xl">
        
        <!-- Dashboard Stats -->
        <div class="grid grid-cols-3 gap-3 mb-6">
            <div class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-yellow-500 flex flex-col items-center">
                <p class="text-gray-400 text-xs font-semibold uppercase mb-1">รอตรวจสอบ</p>
                <p class="text-2xl font-bold text-yellow-600" id="statPending">0</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-green-500 flex flex-col items-center">
                <p class="text-gray-400 text-xs font-semibold uppercase mb-1">ยืนยันแล้ว</p>
                <p class="text-2xl font-bold text-green-600" id="statConfirmed">0</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-blue-500 flex flex-col items-center">
                <p class="text-gray-400 text-xs font-semibold uppercase mb-1">เช็คอินวันนี้</p>
                <p class="text-2xl font-bold text-blue-600" id="statCheckIn">0</p>
            </div>
        </div>

        <!-- Search & Filter Area -->
        <div class="mb-6 flex flex-col sm:flex-row gap-3">
            <div class="relative flex-1">
                <input type="text" id="searchInput" onkeyup="filterData()" placeholder="ค้นหาชื่อผู้จอง, เบอร์โทร..." 
                    class="w-full pl-10 pr-4 py-3 bg-white border-none rounded-2xl shadow-sm focus:ring-2 focus:ring-red-500 outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <select id="statusFilter" onchange="filterData()" class="bg-white px-4 py-3 rounded-2xl shadow-sm border-none outline-none focus:ring-2 focus:ring-red-500 font-semibold text-gray-600">
                <option value="all">ทั้งหมดทุกสถานะ</option>
                <option value="Pending">เฉพาะ: รอตรวจสอบ</option>
                <option value="Confirmed">เฉพาะ: ยืนยันแล้ว</option>
                <option value="Reject">เฉพาะ: ปฏิเสธ</option>
            </select>
        </div>

        <!-- Content Area -->
        <h2 class="text-gray-700 font-bold text-lg mb-4 flex items-center gap-2">
            <span class="w-1.5 h-6 bg-red-600 rounded-full"></span>
            รายการจองล่าสุด
        </h2>

        <!-- Desktop Table View -->
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden hidden md:block border border-gray-100">
            <table class="min-w-full desktop-table">
                <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold border-b">
                    <tr>
                        <th class="px-6 py-4 text-left">สถานะ</th>
                        <th class="px-6 py-4 text-left">ผู้เข้าพัก</th>
                        <th class="px-6 py-4 text-left">รายละเอียดห้อง</th>
                        <th class="px-6 py-4 text-left">ยอดชำระ</th>
                        <th class="px-6 py-4 text-right">การจัดการ</th>
                    </tr>
                </thead>
                <tbody id="bookingTableBody" class="divide-y divide-gray-100">
                    <!-- Shimmer Loaders -->
                    <tr><td colspan="5" class="p-10 text-center"><div class="loading-shimmer h-12 rounded-lg mb-2"></div><div class="loading-shimmer h-12 rounded-lg mb-2"></div><div class="loading-shimmer h-12 rounded-lg"></div></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Mobile Card View -->
        <div id="bookingCardsMobile" class="mobile-cards space-y-4">
             <!-- Shimmer Loaders for Mobile -->
             <div class="loading-shimmer h-40 rounded-2xl"></div>
             <div class="loading-shimmer h-40 rounded-2xl mt-4"></div>
        </div>

    </div>

    <!-- Modal for Slip -->
    <div id="slipModal" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-50 p-4" onclick="closeSlip()">
        <div class="relative max-w-lg w-full flex flex-col items-center" onclick="event.stopPropagation()">
            <button class="absolute -top-12 right-0 text-white hover:text-red-400 transition-colors" onclick="closeSlip()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="bg-white p-2 rounded-2xl shadow-2xl w-full">
                <img id="modalImg" src="" class="w-full max-h-[70vh] object-contain rounded-xl">
            </div>
            <div class="mt-6 flex flex-col w-full gap-3 px-2">
                <a id="downloadBtn" href="#" target="_blank" class="w-full bg-blue-600 text-white text-center py-4 rounded-2xl font-bold shadow-lg active:bg-blue-700 flex justify-center items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                    เปิดดูไฟล์ต้นฉบับ
                </a>
                <button onclick="closeSlip()" class="w-full bg-white/10 text-white border border-white/20 py-4 rounded-2xl font-bold">ปิดหน้าต่าง</button>
            </div>
        </div>
    </div>

    <script>
        // API URL (เหมือนเดิมจากที่คุณระบุ)
        const API_URL = 'https://script.google.com/macros/s/AKfycbwb9VWt0rQYJ2dJa9jQKM23YRKsx-YReKnqJTiqGRbg26jEMtPP-RzxDbe_BahxUiSu5g/exec';
        let allBookings = [];

        async function loadData() {
            try {
                // UI Loading state
                const res = await fetch(API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'get_all_bookings' }) 
                });
                const json = await res.json();
                if(json.status === 'success') {
                    allBookings = json.data;
                    updateStats(allBookings);
                    filterData(); // แสดงผลเริ่มต้น
                }
            } catch(e) {
                Swal.fire({
                    icon: 'error',
                    title: 'เชื่อมต่อล้มเหลว',
                    text: 'กรุณาลองใหม่อีกครั้งในภายหลัง',
                    confirmButtonColor: '#991b1b'
                });
            }
        }

        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            const filtered = allBookings.filter(item => {
                const matchesSearch = item.booker.toLowerCase().includes(searchTerm) || 
                                    item.phone.includes(searchTerm) ||
                                    item.id.toString().includes(searchTerm);
                const matchesStatus = statusFilter === 'all' || item.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            renderUI(filtered);
        }

        function renderUI(data) {
            const tbody = document.getElementById('bookingTableBody');
            const cardContainer = document.getElementById('bookingCardsMobile');
            
            if (data.length === 0) {
                const emptyHTML = `<div class="p-20 text-center flex flex-col items-center">
                    <div class="bg-gray-100 p-4 rounded-full mb-3 text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 17.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <p class="text-gray-500 font-medium">ไม่พบรายการที่ค้นหา</p>
                </div>`;
                tbody.innerHTML = `<tr><td colspan="5">${emptyHTML}</td></tr>`;
                cardContainer.innerHTML = emptyHTML;
                return;
            }

            tbody.innerHTML = data.map(row => renderTableRow(row)).join('');
            cardContainer.innerHTML = data.map(row => renderMobileCard(row)).join('');
        }

        function renderTableRow(row) {
            const isUrl = row.slip && row.slip.startsWith('http');
            return `
                <tr class="hover:bg-gray-50/80 transition-colors">
                    <td class="px-6 py-5">
                        <span class="px-3 py-1.5 rounded-full text-[10px] font-black uppercase tracking-wider ${getStatusClass(row.status)}">${row.status}</span>
                    </td>
                    <td class="px-6 py-5">
                        <div class="font-bold text-gray-800">${row.booker}</div>
                        <div class="text-xs text-gray-500 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 004.812 4.812l.773-1.548a1 1 0 011.06-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>
                            ${row.phone}
                        </div>
                    </td>
                    <td class="px-6 py-5">
                        <div class="text-gray-700 font-medium">${row.room}</div>
                        <div class="text-blue-600 text-[11px] font-semibold bg-blue-50 px-2 py-0.5 rounded-md inline-block mt-1">
                            Check-in: ${row.checkIn}
                        </div>
                    </td>
                    <td class="px-6 py-5">
                        <div class="font-bold text-gray-900">${Number(row.total).toLocaleString()} ฿</div>
                        <div class="text-green-600 text-xs font-semibold italic">มัดจำ: ${Number(row.deposit).toLocaleString()}</div>
                    </td>
                    <td class="px-6 py-5 text-right">
                        <div class="flex justify-end gap-2">
                            ${isUrl ? `<button onclick="viewSlip('${row.slip}')" class="text-blue-700 hover:text-white hover:bg-blue-700 bg-blue-50 px-3 py-2 rounded-xl text-xs font-bold border border-blue-100 transition-all">ดูสลิป</button>` : ''}
                            ${row.status === 'Pending' ? `
                                <button onclick="updateStatus('${row.id}', 'Confirmed')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-sm shadow-green-200">ยืนยัน</button>
                                <button onclick="updateStatus('${row.id}', 'Reject')" class="bg-red-50 hover:bg-red-100 text-red-600 px-4 py-2 rounded-xl text-xs font-bold border border-red-100">ปฏิเสธ</button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }

        function renderMobileCard(row) {
            const isUrl = row.slip && row.slip.startsWith('http');
            return `
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 booking-card">
                    <div class="flex justify-between items-start mb-4">
                        <span class="px-3 py-1 rounded-xl text-[10px] font-black uppercase tracking-widest ${getStatusClass(row.status)}">${row.status}</span>
                        <div class="text-right">
                            <p class="text-2xl font-black text-gray-900 leading-none">${Number(row.total).toLocaleString()} <span class="text-sm">฿</span></p>
                            <p class="text-green-600 text-xs font-bold mt-1 uppercase italic">Paid: ${Number(row.deposit).toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div class="flex flex-col gap-3 mb-5">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gray-100 rounded-2xl flex items-center justify-center text-gray-500 font-bold">
                                ${row.booker.charAt(0)}
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 leading-tight">${row.booker}</p>
                                <p class="text-xs text-gray-500">${row.phone}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-1">
                            <div class="bg-blue-50 p-3 rounded-2xl">
                                <p class="text-[10px] text-blue-400 font-bold uppercase mb-1">เข้าพักวันที่</p>
                                <p class="text-sm font-bold text-blue-800">${row.checkIn}</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-2xl">
                                <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">ที่พัก</p>
                                <p class="text-sm font-bold text-gray-800 truncate">${row.room}</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        ${isUrl ? `<button onclick="viewSlip('${row.slip}')" class="flex-1 py-4 bg-blue-100 text-blue-800 rounded-2xl text-sm font-bold active:bg-blue-200 transition-all">ดูสลิป</button>` : `<div class="flex-1 py-4 bg-gray-50 text-gray-400 rounded-2xl text-center text-sm font-bold border border-dashed border-gray-200">ไม่มีสลิป</div>`}
                        
                        ${row.status === 'Pending' ? `
                            <button onclick="updateStatus('${row.id}', 'Confirmed')" class="flex-[1.5] py-4 bg-green-600 text-white rounded-2xl text-sm font-extrabold active:bg-green-700 shadow-lg shadow-green-100">ยืนยันรับจอง</button>
                            <button onclick="updateStatus('${row.id}', 'Reject')" class="px-4 py-4 bg-red-50 text-red-500 rounded-2xl text-sm font-bold active:bg-red-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function getStatusClass(status) {
            if(status === 'Pending') return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
            if(status === 'Confirmed') return 'bg-green-100 text-green-800 border border-green-200';
            return 'bg-red-100 text-red-800 border border-red-200';
        }

        function updateStats(data) {
            document.getElementById('statPending').innerText = data.filter(d => d.status === 'Pending').length;
            document.getElementById('statConfirmed').innerText = data.filter(d => d.status === 'Confirmed').length;
            
            // ตรวจสอบวันที่เช็คอิน (เทียบเป็นรูปแบบ DD/MM/YYYY)
            const todayDate = new Date();
            const todayStr = todayDate.toLocaleDateString('th-TH', { 
                day: '2-digit', month: '2-digit', year: 'numeric' 
            });
            
            const checkedInToday = data.filter(d => d.checkIn === todayStr && d.status === 'Confirmed').length;
            document.getElementById('statCheckIn').innerText = checkedInToday;
        }

        function viewSlip(url) {
            const modalImg = document.getElementById('modalImg');
            const slipModal = document.getElementById('slipModal');
            const downloadBtn = document.getElementById('downloadBtn');
            modalImg.src = url;
            downloadBtn.href = url;
            slipModal.classList.remove('hidden');
            slipModal.classList.add('flex');
            document.body.style.overflow = 'hidden'; // ห้ามเลื่อนพื้นหลัง
        }

        function closeSlip() {
            document.getElementById('slipModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function updateStatus(id, status) {
            const result = await Swal.fire({
                title: status === 'Confirmed' ? 'ยืนยันการรับจอง?' : 'ยืนยันการปฏิเสธ?',
                text: `คุณกำลังเปลี่ยนสถานะรายการนี้เป็น ${status}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: status === 'Confirmed' ? '#059669' : '#dc2626',
                confirmButtonText: 'ใช่, ดำเนินการ',
                cancelButtonText: 'ยกเลิก',
                reverseButtons: true,
                customClass: {
                    container: 'font-kanit',
                    popup: 'rounded-3xl'
                }
            });

            if(result.isConfirmed) {
                Swal.fire({ 
                    title: 'กำลังบันทึก...', 
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading() 
                });
                
                try {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ 
                            action: 'update_status', 
                            payload: { bookingId: id, status: status } 
                        })
                    });
                    const json = await res.json();
                    if(json.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'อัปเดตเรียบร้อย',
                            timer: 1500,
                            showConfirmButton: false,
                            customClass: { popup: 'rounded-3xl' }
                        });
                        loadData();
                    }
                } catch(e) {
                    Swal.fire('Error', 'ไม่สามารถเชื่อมต่อเพื่อบันทึกข้อมูลได้', 'error');
                }
            }
        }

        // เริ่มโหลดข้อมูล
        window.onload = loadData;
    </script>
</body>
</html>
