<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô - ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; padding-bottom: 90px; }
        .tab-active { color: #059669; border-top: 3px solid #059669; background: #f0fdf4; }
        .card-confirmed { border-left: 6px solid #10b981; }
        .card-pending { border-left: 6px solid #f59e0b; }
        .animate-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-white bg-opacity-80">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-green-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 font-semibold text-green-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-30 px-4 py-3 border-b flex justify-between items-center">
        <h1 id="pageTitle" class="text-xl font-bold text-green-800">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h1>
        <button onclick="fetchData()" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
        </button>
    </header>

    <!-- Main Content Area -->
    <main class="max-w-4xl mx-auto p-4">
        <!-- Dashboard Home -->
        <section id="tab-home" class="animate-in space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-2xl shadow-sm border text-center">
                    <p class="text-xs text-gray-500 uppercase font-semibold">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <p id="todayCount" class="text-3xl font-bold text-green-600">0</p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border text-center">
                    <p class="text-xs text-gray-500 uppercase font-semibold">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                    <p id="pendingCount" class="text-3xl font-bold text-orange-500">0</p>
                </div>
            </div>
            
            <h2 class="text-lg font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
            <div id="bookingList" class="space-y-4">
                <!-- Data injected here -->
            </div>
        </section>

        <!-- Calendar View -->
        <section id="tab-calendar" class="hidden animate-in">
            <div class="bg-white p-4 rounded-2xl shadow-sm border h-[600px]" id="calendar"></div>
        </section>

        <!-- Promotion & Settings -->
        <section id="tab-settings" class="hidden animate-in space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                <h3 class="font-bold text-lg mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</h3>
                <div class="flex gap-2">
                    <input type="text" id="promoCode" placeholder="‡πÇ‡∏Ñ‡πâ‡∏î" class="border p-2 rounded w-1/3">
                    <input type="number" id="promoValue" placeholder="‡∏•‡∏î‡∏Å‡∏µ‡πà‡∏ö‡∏≤‡∏ó" class="border p-2 rounded w-1/3">
                    <button onclick="addPromo()" class="bg-green-600 text-white px-4 py-2 rounded flex-1 font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center h-16 shadow-lg z-40">
        <button onclick="switchTab('home', '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å')" class="flex flex-col items-center flex-1 py-2 nav-btn" id="btn-home">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span class="text-[10px]">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
        </button>
        <button onclick="switchTab('calendar', '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≠‡∏á')" class="flex flex-col items-center flex-1 py-2 nav-btn" id="btn-calendar">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span class="text-[10px]">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</span>
        </button>
        <button onclick="switchTab('settings', '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤')" class="flex flex-col items-center flex-1 py-2 nav-btn" id="btn-settings">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            <span class="text-[10px]">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
        </button>
    </nav>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzfE2-6_B6UqN1nB7k9W5W8X9T9U7Y9U7Y/exec'; // **‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà**
        let allData = [];

        async function fetchData() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                const response = await fetch(API_URL);
                const result = await response.json();
                allData = result.bookings || [];
                renderDashboard();
                renderCalendar();
            } catch (err) {
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: " + err);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function renderDashboard() {
            const list = document.getElementById('bookingList');
            const today = new Date().toISOString().split('T')[0];
            
            let html = '';
            let counts = { today: 0, pending: 0 };

            allData.slice().reverse().forEach(bk => {
                const statusClass = bk['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] === 'confirmed' ? 'card-confirmed' : 'card-pending';
                if(bk['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] === 'pending') counts.pending++;
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
                const checkInDate = new Date(bk['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å']).toISOString().split('T')[0];
                if(checkInDate === today) counts.today++;

                // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ JSON)
                let foodDisplay = "-";
                try {
                    const foods = JSON.parse(bk['‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏´‡∏≤‡∏£'] || "[]");
                    if(foods.length > 0) foodDisplay = foods.map(f => `${f.name} x${f.qty}`).join(", ");
                } catch(e) {}

                html += `
                <div class="bg-white p-4 rounded-2xl shadow-sm border ${statusClass} animate-in relative">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="text-xs text-gray-400 font-mono">${bk['‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á']}</p>
                            <h3 class="font-bold text-lg">${bk['‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤']}</h3>
                        </div>
                        <span class="px-2 py-1 rounded-full text-[10px] uppercase font-bold ${bk['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] === 'confirmed' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                            ${bk['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] === 'confirmed' ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-y-2 text-sm">
                        <p class="text-gray-500">üìû ${bk['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå']}</p>
                        <p class="text-gray-500">üìÖ ${new Date(bk['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å']).toLocaleDateString('th-TH')}</p>
                        <p class="text-gray-500 col-span-2">üçõ ${foodDisplay}</p>
                    </div>

                    <div class="mt-4 pt-4 border-t flex justify-between items-center">
                        <p class="font-bold text-green-700 text-lg">‡∏ø${Number(bk['‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô']).toLocaleString()}</p>
                        <div class="space-x-2">
                            <a href="${bk['‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏•‡∏¥‡∏õ']}" target="_blank" class="text-blue-600 text-sm font-semibold underline">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a>
                            ${bk['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] === 'pending' ? `<button onclick="updateStatus('${bk['‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á']}', 'confirmed')" class="bg-green-600 text-white px-3 py-1 rounded-lg text-sm font-bold shadow-sm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>` : ''}
                        </div>
                    </div>
                </div>`;
            });

            list.innerHTML = html || '<p class="text-center text-gray-400 py-10">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>';
            document.getElementById('todayCount').innerText = counts.today;
            document.getElementById('pendingCount').innerText = counts.pending;
        }

        async function updateStatus(id, status) {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            document.getElementById('loading').classList.remove('hidden');
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'updateStatus', id: id, status: status })
                });
                fetchData();
            } catch (err) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
        }

        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'th',
                events: allData.map(bk => ({
                    title: bk['‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'],
                    start: bk['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å'],
                    end: bk['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å'],
                    backgroundColor: bk['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] === 'confirmed' ? '#10b981' : '#f59e0b',
                    borderColor: 'transparent'
                })),
                headerToolbar: { left: 'prev,next', center: 'title', right: 'today' }
            });
            calendar.render();
        }

        function switchTab(id, title) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('tab-active'));
            document.getElementById('btn-' + id).classList.add('tab-active');
            document.getElementById('pageTitle').innerText = title;
            if(id === 'calendar') setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
        }

        window.onload = fetchData;
    </script>
</body>
</html>
