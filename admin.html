<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการหลังบ้าน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Kanit', sans-serif; }</style>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-emerald-800">ระบบแอดมิน - ขนำลุงดำ</h1>
            <button onclick="loadData()" class="bg-emerald-600 text-white px-4 py-2 rounded shadow">รีเฟรชข้อมูล</button>
        </header>

        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-emerald-50 text-emerald-900">
                        <th class="p-3 border">เลขที่การจอง</th>
                        <th class="p-3 border">ชื่อผู้จอง/เบอร์</th>
                        <th class="p-3 border">ห้องพัก</th>
                        <th class="p-3 border">วันที่เข้าพัก</th>
                        <th class="p-3 border">ยอดรวม</th>
                        <th class="p-3 border">มัดจำ</th>
                        <th class="p-3 border">สถานะ</th>
                        <th class="p-3 border">จัดการ</th>
                    </tr>
                </thead>
                <tbody id="booking-list">
                    <tr><td colspan="8" class="p-5 text-center">กำลังโหลดข้อมูล...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function loadData() {
            google.script.run.withSuccessHandler(displayBookings).getBookings();
        }

        function displayBookings(data) {
            const container = document.getElementById('booking-list');
            if (data.length === 0) {
                container.innerHTML = '<tr><td colspan="8" class="p-5 text-center">ไม่มีรายการจอง</td></tr>';
                return;
            }

            container.innerHTML = data.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="p-3 border font-mono text-sm">${item["เลขที่การจอง"]}</td>
                    <td class="p-3 border">
                        <div class="font-semibold">${item["ชื่อผู้จอง"]}</div>
                        <div class="text-xs text-gray-500">${item["เบอร์โทรศัพท์"]}</div>
                    </td>
                    <td class="p-3 border">
                        <div class="text-sm">${item["ชื่อห้องพัก"]}</div>
                        <div class="text-xs text-emerald-600">${item["จำนวนคน"]} ท่าน</div>
                    </td>
                    <td class="p-3 border text-sm">${formatDate(item["วันที่เข้าพัก"])}</td>
                    <td class="p-3 border font-bold">฿${item["ราคารวม"]}</td>
                    <td class="p-3 border text-emerald-600">฿${item["มัดจำ"]}</td>
                    <td class="p-3 border">
                        <span class="px-2 py-1 rounded-full text-xs ${getStatusClass(item["สถานะ"])}">
                            ${item["สถานะ"]}
                        </span>
                    </td>
                    <td class="p-3 border">
                        <select onchange="updateStatus('${item["เลขที่การจอง"]}', this.value)" class="text-xs p-1 border rounded">
                            <option value="">เลือกการจัดการ</option>
                            <option value="ชำระเงินเรียบร้อย">ยืนยันรับยอด</option>
                            <option value="ยกเลิกการจอง">ยกเลิก</option>
                        </select>
                    </td>
                </tr>
            `).reverse().join('');
        }

        function updateStatus(id, status) {
            if(!status) return;
            if(!confirm('ยืนยันการเปลี่ยนสถานะเป็น: ' + status)) return;
            
            google.script.run.withSuccessHandler(() => {
                alert('อัปเดตสถานะและแจ้งเตือนลูกค้าเรียบร้อยแล้ว');
                loadData();
            }).updateBookingStatus(id, status);
        }

        function getStatusClass(status) {
            if (status === 'ชำระเงินเรียบร้อย') return 'bg-green-100 text-green-800';
            if (status === 'รอตรวจสอบ') return 'bg-yellow-100 text-yellow-800';
            if (status === 'ยกเลิกการจอง') return 'bg-red-100 text-red-800';
            return 'bg-gray-100 text-gray-800';
        }

        function formatDate(d) {
            if(!d) return "-";
            const date = new Date(d);
            return date.toLocaleDateString('th-TH');
        }

        window.onload = loadData;
    </script>
</body>
</html>
