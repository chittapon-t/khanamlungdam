<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Kanit', sans-serif; }</style>
</head>
<body class="bg-gray-100">
    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-5 rounded-lg shadow-xl text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-emerald-600 mx-auto"></div>
            <p class="mt-3 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <nav class="bg-emerald-900 text-white p-4 shadow-lg sticky top-0 z-40">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="font-bold text-xl">Admin Dashboard - ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥</h1>
            <div class="flex space-x-4 text-sm overflow-x-auto">
                <button onclick="switchTab('upcoming')" class="whitespace-nowrap hover:text-emerald-300">üìÖ ‡∏à‡∏≠‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á</button>
                <button onclick="switchTab('bookings')" class="whitespace-nowrap hover:text-emerald-300">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button onclick="switchTab('settings')" class="whitespace-nowrap hover:text-emerald-300">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-8">
        <!-- Dashboard Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-emerald-500">
                <p class="text-gray-500 text-sm">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                <h3 id="statToday" class="text-2xl font-bold text-gray-800">0</h3>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500">
                <p class="text-gray-500 text-sm">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ</p>
                <h3 id="statPending" class="text-2xl font-bold text-gray-800">0</h3>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                <p class="text-gray-500 text-sm">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏£‡∏ß‡∏°</p>
                <h3 id="statRevenue" class="text-2xl font-bold text-gray-800">‡∏ø0</h3>
            </div>
        </div>

        <!-- Tab: Upcoming -->
        <section id="tab-upcoming" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
                <div class="p-4 border-b bg-emerald-50 flex justify-between items-center">
                    <h2 class="font-bold text-emerald-800">üèÉ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-gray-600 text-xs uppercase">
                            <tr>
                                <th class="p-4">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                <th class="p-4">‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                <th class="p-4">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</th>
                                <th class="p-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="p-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="upcomingTable" class="text-sm divide-y">
                            <tr><td colspan="5" class="p-8 text-center text-gray-400 italic">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Tab: Bookings -->
        <section id="tab-bookings" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                    <h2 class="font-bold text-gray-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    <button onclick="fetchData()" class="text-sm bg-emerald-100 text-emerald-700 px-3 py-1 rounded">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-gray-600 text-xs uppercase">
                            <tr>
                                <th class="p-4">‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á / ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</th>
                                <th class="p-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</th>
                                <th class="p-4">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥</th>
                                <th class="p-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="p-4 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="bookingTable" class="text-sm divide-y">
                            <!-- Injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script>
        // ‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Deploy ‡∏Ç‡∏≠‡∏á Google Apps Script (‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö BACKEND_URL)
        const API_URL = "https://script.google.com/macros/s/AKfycbwb9VWt0rQYJ2dJa9jQKM23YRKsx-YReKnqJTiqGRbg26jEMtPP-RzxDbe_BahxUiSu5g/exec"; 

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
        }

        function formatThaiDate(dateStr) {
            if(!dateStr) return "-";
            const months = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
            const date = new Date(dateStr);
            if (isNaN(date)) return dateStr;
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543}`;
        }

        async function fetchData() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Stats
                updateStats(data);
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                renderTable(data);
                renderUpcoming(data);
            } catch (err) {
                console.error('Fetch error:', err);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + err.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function updateStats(data) {
            const today = new Date().toISOString().split('T')[0];
            const todayBookings = data.filter(i => i.CheckIn.split('T')[0] === today).length;
            const pending = data.filter(i => i.Status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö').length;
            const revenue = data.filter(i => i.Status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß').reduce((sum, i) => sum + Number(i.Deposit), 0);

            document.getElementById('statToday').innerText = todayBookings;
            document.getElementById('statPending').innerText = pending;
            document.getElementById('statRevenue').innerText = `‡∏ø${revenue.toLocaleString()}`;
        }

        function renderTable(data) {
            const tbody = document.getElementById('bookingTable');
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏° Timestamp ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
            const sortedData = [...data].reverse();

            tbody.innerHTML = sortedData.map(item => `
                <tr>
                    <td class="p-4">
                        <div class="font-bold text-emerald-800">${item.CustomerName}</div>
                        <div class="text-[10px] text-gray-400 uppercase">ID: ${item.BookingID}</div>
                        <div class="text-xs text-gray-600 mt-1">üè† ${item.RoomsInfo} (${item.TotalGuests} ‡∏ó‡πà‡∏≤‡∏ô)</div>
                        <a href="tel:${item.Phone}" class="text-[11px] text-blue-600 font-bold block mt-1">üìû ${item.Phone}</a>
                    </td>
                    <td class="p-4 text-xs">
                        <div class="flex flex-col">
                            <span><span class="text-gray-400 italic">‡πÄ‡∏Ç‡πâ‡∏≤:</span> ${formatThaiDate(item.CheckIn)}</span>
                            <span><span class="text-gray-400 italic">‡∏≠‡∏≠‡∏Å:</span> ${formatThaiDate(item.CheckOut)}</span>
                        </div>
                    </td>
                    <td class="p-4 font-bold text-emerald-700">‡∏ø${Number(item.Deposit).toLocaleString()}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded-full text-[10px] ${item.Status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                            ${item.Status}
                        </span>
                    </td>
                    <td class="p-4 text-right">
                        <div class="flex flex-col gap-1 items-end">
                            ${item.Status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' ? 
                                `<button onclick="updateStatus('${item.BookingID}', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß')" class="w-20 bg-emerald-500 text-white px-2 py-1 rounded text-[10px]">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏•‡∏¥‡∏õ</button>` : ''
                            }
                            <button onclick="updateStatus('${item.BookingID}', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')" class="w-20 bg-red-50 text-red-600 border border-red-200 px-2 py-1 rounded text-[10px]">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            if(data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>`;
            }
        }

        function renderUpcoming(data) {
            const tbody = document.getElementById('upcomingTable');
            const sorted = data
                .filter(i => i.Status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß')
                .sort((a, b) => new Date(a.CheckIn) - new Date(b.CheckIn));

            tbody.innerHTML = sorted.map((item, index) => `
                <tr class="${index === 0 ? 'bg-yellow-50' : ''}">
                    <td class="p-4 font-bold text-center text-gray-400">#${index + 1}</td>
                    <td class="p-4 font-semibold">
                        <span class="text-emerald-800 text-base">${item.CustomerName}</span><br>
                        <a href="tel:${item.Phone}" class="text-[11px] text-blue-600 font-bold hover:underline">üìû ${item.Phone}</a>
                    </td>
                    <td class="p-4 text-xs text-gray-700">
                        ${item.RoomsInfo}
                    </td>
                    <td class="p-4 text-xs font-bold text-emerald-800">
                        ${formatThaiDate(item.CheckIn)}
                    </td>
                    <td class="p-4">
                        <span class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded-full italic">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                    </td>
                </tr>
            `).join('');
            
            if (sorted.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</td></tr>`;
            }
        }

        async function updateStatus(id, newStatus) {
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${id} ‡πÄ‡∏õ‡πá‡∏ô "${newStatus}"?`)) return;
            
            document.getElementById('loading').classList.remove('hidden');
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'updateStatus',
                        bookingId: id,
                        status: newStatus
                    })
                });
                const result = await response.json();
                if(result.status === 'success') {
                    alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                    fetchData(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.message);
                }
            } catch (err) {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        window.onload = fetchData;
    </script>
</body>
</html>
