<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô - ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f9fafb; padding-bottom: 80px; }
        .tab-active { color: #059669; border-top: 3px solid #059669; background: white; }
        .card-confirm { border-left: 5px solid #10b981; }
        .card-pending { border-left: 5px solid #f59e0b; }
        .card-cancel { border-left: 5px solid #ef4444; opacity: 0.8; }
    </style>
</head>
<body>

    <div id="loading" class="fixed inset-0 bg-white/80 z-[9999] flex flex-col items-center justify-center hidden">
        <div class="w-12 h-12 border-4 border-emerald-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-emerald-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <header class="bg-emerald-800 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-lg">
        <h1 class="text-lg font-bold">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h1>
        <button onclick="fetchData()" class="bg-emerald-700 p-2 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        </button>
    </header>

    <main class="max-w-4xl mx-auto p-4">
        
        <!-- Dashboard / Pending -->
        <section id="tab-home">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border text-center">
                    <p class="text-gray-500 text-xs">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                    <p id="count-pending" class="text-2xl font-bold text-amber-500">0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border text-center">
                    <p class="text-gray-500 text-xs">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <p id="count-today" class="text-2xl font-bold text-emerald-600">0</p>
                </div>
            </div>
            
            <h2 class="font-bold mb-3 flex items-center gap-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h2>
            <div id="pending-list" class="space-y-4"></div>
        </section>

        <!-- All Bookings -->
        <section id="tab-all" class="hidden">
            <input type="text" id="search" oninput="filterData()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ID..." class="w-full p-3 mb-4 rounded-xl border outline-none focus:ring-2 focus:ring-emerald-500">
            <div id="all-list" class="space-y-4"></div>
        </section>

        <!-- Settings -->
        <section id="tab-set" class="hidden">
            <div class="bg-white p-4 rounded-xl border mb-4">
                <h3 class="font-bold mb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</h3>
                <div class="flex gap-2">
                    <input id="p-code" placeholder="‡πÇ‡∏Ñ‡πâ‡∏î" class="border p-2 rounded w-full">
                    <input id="p-val" type="number" placeholder="‡∏•‡∏î" class="border p-2 rounded w-full">
                    <button onclick="saveSetting('addPromo')" class="bg-emerald-600 text-white px-4 rounded">+</button>
                </div>
                <div id="promo-list" class="mt-3 space-y-2"></div>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 inset-x-0 bg-white border-t flex justify-around shadow-2xl z-50">
        <button onclick="switchTab('home')" id="nav-home" class="flex-1 py-3 text-emerald-600 border-t-2 border-emerald-600">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <button onclick="switchTab('all')" id="nav-all" class="flex-1 py-3 text-gray-400">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button onclick="switchTab('set')" id="nav-set" class="flex-1 py-3 text-gray-400">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
    </nav>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbyR0jWpP0mOfq77uV548n7L3P3q7Gf228Rre2n9q3K-g7F4X9A8Hh8y1Y2Z3/exec'; // **‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì**
        let rawData = [];

        async function fetchData() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                const res = await fetch(API);
                const data = await res.json();
                rawData = data.bookings;
                render(data);
            } catch (e) { alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
            document.getElementById('loading').classList.add('hidden');
        }

        function render(data) {
            const pending = data.bookings.filter(b => b.Status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
            const confirmedToday = data.bookings.filter(b => b.Status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß').length;
            
            document.getElementById('count-pending').innerText = pending.length;
            document.getElementById('count-today').innerText = confirmedToday;

            // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
            document.getElementById('pending-list').innerHTML = pending.length ? 
                pending.map(b => card(b)).join('') : '<p class="text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á</p>';

            // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            document.getElementById('all-list').innerHTML = data.bookings.sort((a,b) => b.Timestamp - a.Timestamp).map(b => card(b)).join('');
            
            // ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
            document.getElementById('promo-list').innerHTML = data.promos.map(p => `
                <div class="flex justify-between bg-gray-50 p-2 rounded border text-sm">
                    <span><b>${p.code}</b> (‡∏•‡∏î ${p.value})</span>
                    <button onclick="deleteSet('promo', '${p.id}')" class="text-red-500">‡∏•‡∏ö</button>
                </div>
            `).join('');
        }

        function card(b) {
            const isPending = b.Status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
            const sClass = b.Status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' ? 'card-confirm' : (b.Status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' ? 'card-cancel' : 'card-pending');
            
            return `
                <div class="bg-white p-4 rounded-xl shadow-sm border ${sClass} relative">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-bold text-lg">${b.CustomerName}</p>
                            <p class="text-[10px] text-gray-400">${b.BookingID}</p>
                        </div>
                        <span class="text-xs px-2 py-1 rounded bg-gray-100">${b.Status}</span>
                    </div>
                    
                    <div class="text-sm grid grid-cols-2 gap-y-1 mb-3">
                        <p class="text-gray-500">üìÖ ‡∏û‡∏±‡∏Å:</p>
                        <p>${fmt(b.CheckIn)} - ${fmt(b.CheckOut)}</p>
                        <p class="text-gray-500">üè† ‡∏´‡πâ‡∏≠‡∏á:</p>
                        <p>${b.RoomsInfo}</p>
                        <p class="text-gray-500">üí∞ ‡∏¢‡∏≠‡∏î:</p>
                        <p class="font-bold">‡∏ø${b.TotalAmount.toLocaleString()}</p>
                        <p class="text-gray-500">üíµ ‡∏°‡∏±‡∏î‡∏à‡∏≥:</p>
                        <p class="text-emerald-600 font-bold">‡∏ø${b.Deposit.toLocaleString()}</p>
                    </div>

                    <div class="flex gap-2">
                        <a href="tel:${b.Phone}" class="flex-1 bg-gray-100 text-center py-2 rounded text-sm">üìû ‡πÇ‡∏ó‡∏£</a>
                        ${b.SlipURL !== 'No Slip' ? `<button onclick="window.open('${b.SlipURL}')" class="flex-1 bg-blue-50 text-blue-600 py-2 rounded text-sm border border-blue-100">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</button>` : ''}
                        ${isPending ? `<button onclick="update('${b.BookingID}', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß')" class="flex-[1.5] bg-emerald-600 text-white py-2 rounded font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≠‡∏á</button>` : ''}
                        ${b.Status !== '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' ? `<button onclick="update('${b.BookingID}', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')" class="p-2 bg-red-50 text-red-500 rounded border">üóëÔ∏è</button>` : ''}
                    </div>
                </div>
            `;
        }

        async function update(id, status) {
            if(!confirm(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${status}?`)) return;
            document.getElementById('loading').classList.remove('hidden');
            await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', id: id, status: status }) });
            fetchData();
        }

        async function saveSetting(action) {
            const code = document.getElementById('p-code').value;
            const val = document.getElementById('p-val').value;
            if(!code || !val) return;
            document.getElementById('loading').classList.remove('hidden');
            await fetch(API, { method: 'POST', body: JSON.stringify({ action, code, value: val, type: 'amount' }) });
            fetchData();
        }

        async function deleteSet(type, id) {
            if(!confirm('‡∏•‡∏ö?')) return;
            document.getElementById('loading').classList.remove('hidden');
            await fetch(API, { method: 'POST', body: JSON.stringify({ action: 'removeSetting', type, id }) });
            fetchData();
        }

        function switchTab(t) {
            ['home', 'all', 'set'].forEach(id => {
                document.getElementById('tab-'+id).classList.add('hidden');
                document.getElementById('nav-'+id).className = 'flex-1 py-3 text-gray-400';
            });
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.getElementById('nav-'+t).className = 'flex-1 py-3 text-emerald-600 border-t-2 border-emerald-600';
        }

        function filterData() {
            const q = document.getElementById('search').value.toLowerCase();
            const cards = document.querySelectorAll('#all-list > div');
            cards.forEach(c => {
                c.style.display = c.innerText.toLowerCase().includes(q) ? 'block' : 'none';
            });
        }

        function fmt(d) {
            if(!d) return '-';
            return new Date(d).toLocaleDateString('th-TH', {day:'numeric', month:'short'});
        }

        window.onload = fetchData;
    </script>
</body>
</html>
