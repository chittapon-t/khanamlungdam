<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f0fdf4; }
        .status-badge { padding: 2px 8px; border-radius: 9999px; font-size: 10px; font-weight: bold; }
        .status-wait { background-color: #fef3c7; color: #92400e; }
        .status-confirm { background-color: #d1fae5; color: #065f46; }
        .status-cancel { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="p-4">

    <div id="loading" class="fixed inset-0 bg-white bg-opacity-80 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-emerald-600 border-t-transparent"></div>
        <p class="mt-4 text-emerald-800 font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á...</p>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-emerald-900">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h1>
            <button onclick="loadData()" class="bg-white border border-emerald-200 p-2 rounded-lg shadow-sm hover:bg-emerald-50 text-sm">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>

        <!-- Filters -->
        <div class="flex space-x-2 mb-6 overflow-x-auto pb-2">
            <button onclick="filterStatus('all')" class="whitespace-nowrap px-4 py-2 rounded-full bg-emerald-800 text-white text-xs font-bold">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button onclick="filterStatus('‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')" class="whitespace-nowrap px-4 py-2 rounded-full bg-white border border-emerald-100 text-gray-600 text-xs font-bold">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
            <button onclick="filterStatus('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')" class="whitespace-nowrap px-4 py-2 rounded-full bg-white border border-emerald-100 text-gray-600 text-xs font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>

        <div id="bookingList" class="space-y-4">
            <!-- Data will be injected here -->
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwb9VWt0rQYJ2dJa9jQKM23YRKsx-YReKnqJTiqGRbg26jEMtPP-RzxDbe_BahxUiSu5g/exec";
        let allData = [];

        async function loadData() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                allData = data.bookings || [];
                // Sort by latest date
                allData.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
                render(allData);
            } catch (e) {
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: " + e);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function filterStatus(status) {
            if (status === 'all') render(allData);
            else render(allData.filter(b => b.Status === status));
            
            // Update UI Active Tab
            event.target.parentElement.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('bg-emerald-800', 'text-white');
                btn.classList.add('bg-white', 'text-gray-600');
            });
            event.target.classList.add('bg-emerald-800', 'text-white');
            event.target.classList.remove('bg-white', 'text-gray-600');
        }

        function render(items) {
            const list = document.getElementById('bookingList');
            if (items.length === 0) {
                list.innerHTML = `<div class="bg-white p-10 rounded-2xl text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>`;
                return;
            }

            list.innerHTML = items.map(b => {
                const rooms = JSON.parse(b.RoomsInfo || '[]');
                const foods = JSON.parse(b.FoodsInfo || '[]');
                const statusClass = b.Status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' ? 'status-wait' : (b.Status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' ? 'status-confirm' : 'status-cancel');
                
                return `
                <div class="bg-white rounded-2xl shadow-sm border border-emerald-100 overflow-hidden">
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="text-[10px] text-gray-400 font-mono">#${b.BookingID}</span>
                                <h3 class="font-bold text-gray-800 text-lg">${b.CustName}</h3>
                                <p class="text-xs text-gray-500">${b.CustTel} | LINE: ${b.UserName}</p>
                            </div>
                            <span class="status-badge ${statusClass}">${b.Status}</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 my-3 p-3 bg-gray-50 rounded-xl border border-dashed border-gray-200">
                            <div>
                                <p class="text-[10px] uppercase font-bold text-gray-400">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</p>
                                <p class="text-sm font-bold text-emerald-800">${formatDate(b.CheckIn)}</p>
                            </div>
                            <div>
                                <p class="text-[10px] uppercase font-bold text-gray-400">‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå</p>
                                <p class="text-sm font-bold text-emerald-800">${formatDate(b.CheckOut)}</p>
                            </div>
                        </div>

                        <div class="text-sm space-y-1 mb-4">
                            <p class="font-bold text-xs text-gray-400 uppercase">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</p>
                            ${rooms.map(r => `<p>üè† ${r.name} (${r.guests} ‡∏ó‡πà‡∏≤‡∏ô)</p>`).join('')}
                            ${foods.map(f => `<p>üç≤ ${f.name} x${f.qty}</p>`).join('')}
                        </div>

                        <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                            <div>
                                <p class="text-[10px] text-gray-400">‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</p>
                                <p class="text-lg font-bold text-emerald-600">‡∏ø${b.DepositAmount.toLocaleString()}</p>
                            </div>
                            <div class="flex space-x-2">
                                <a href="${b.SlipURL}" target="_blank" class="bg-blue-50 text-blue-600 px-3 py-2 rounded-xl text-xs font-bold border border-blue-100">üîç ‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a>
                                ${b.Status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' ? `
                                    <button onclick="updateStatus('${b.BookingID}', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-md">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function updateStatus(id, status) {
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${status}"?`)) return;
            
            document.getElementById('loading').classList.remove('hidden');
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'updateStatus', bookingId: id, status: status })
                });
                alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                loadData();
            } catch (e) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e);
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function formatDate(dStr) {
            const date = new Date(dStr);
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: '2-digit' });
        }

        window.onload = loadData;
    </script>
</body>
</html>
