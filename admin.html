<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥ ‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        .tab-active { border-bottom: 3px solid #065f46; color: #065f46; font-weight: bold; }
        .fc-event { cursor: pointer; padding: 2px 4px; border-radius: 4px; font-size: 0.75rem; }
    </style>
</head>
<body class="bg-gray-100">

    <nav class="bg-emerald-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h1>
            <button onclick="refreshData()" class="bg-emerald-700 px-3 py-1 rounded text-sm hover:bg-emerald-600">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
    </nav>

    <!-- Tabs Nav -->
    <div class="bg-white border-b sticky top-[60px] z-40">
        <div class="max-w-6xl mx-auto flex overflow-x-auto no-scrollbar">
            <button onclick="switchTab('confirm')" id="tab-confirm" class="flex-1 py-4 text-center text-sm tab-active">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏•‡∏¥‡∏õ</button>
            <button onclick="switchTab('all')" id="tab-all" class="flex-1 py-4 text-center text-sm text-gray-500">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button onclick="switchTab('calendar')" id="tab-calendar" class="flex-1 py-4 text-center text-sm text-gray-500">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>
            <button onclick="switchTab('settings')" id="tab-settings" class="flex-1 py-4 text-center text-sm text-gray-500">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        </div>
    </div>

    <main class="max-w-6xl mx-auto p-4 mb-20">
        <!-- Dashboard / Confirm Slip -->
        <div id="section-confirm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="confirmList">
                <div class="col-span-full py-10 text-center text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            </div>
        </div>

        <!-- All Bookings -->
        <div id="section-all" class="hidden">
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å</th>
                            <th class="p-3">‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th>
                            <th class="p-3">‡∏´‡πâ‡∏≠‡∏á</th>
                            <th class="p-3">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</th>
                            <th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="allBookingTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Calendar -->
        <div id="section-calendar" class="hidden bg-white p-4 rounded-xl shadow-sm">
            <div id="calendar"></div>
        </div>

        <!-- Settings -->
        <div id="section-settings" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold text-lg mb-4 text-emerald-900">‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (Sheet: Codes)</h3>
                <div class="text-sm text-gray-500 mb-4 italic">* ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô Google Sheets ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                <div id="promoDisplay" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold text-lg mb-4 text-emerald-900">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏û‡∏¥‡πÄ‡∏®‡∏© (Sheet: Deposits)</h3>
                <div id="depositDisplay" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
            </div>
        </div>
    </main>

    <!-- Modal Review Slip -->
    <div id="slipModal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6 relative overflow-y-auto max-h-[90vh]">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-2xl">√ó</button>
            <h3 class="font-bold text-lg mb-4">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</h3>
            <img id="modalSlipImg" class="w-full rounded-xl mb-4 shadow-inner" src="">
            <div id="modalDetails" class="space-y-2 text-sm mb-6 border-t pt-4"></div>
            <div class="flex gap-3">
                <button onclick="updateBooking('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')" class="flex-1 py-3 bg-gray-100 text-red-600 font-bold rounded-xl">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="updateBooking('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß')" class="flex-1 py-3 bg-emerald-800 text-white font-bold rounded-xl">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
        </div>
    </div>

    <script>
        const APP_URL = 'https://script.google.com/macros/s/AKfycbwb9VWt0rQYJ2dJa9jQKM23YRKsx-YReKnqJTiqGRbg26jEMtPP-RzxDbe_BahxUiSu5g/exec';
        let allData = [];
        let currentBookingId = '';

        async function refreshData() {
            const res = await fetch(APP_URL);
            const data = await res.json();
            allData = data.bookings;
            renderAll();
        }

        function switchTab(tab) {
            ['confirm', 'all', 'calendar', 'settings'].forEach(t => {
                document.getElementById(`section-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).className = 'flex-1 py-4 text-center text-sm text-gray-500';
            });
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).className = 'flex-1 py-4 text-center text-sm tab-active';
            if(tab === 'calendar') renderCalendar();
            if(tab === 'settings') loadSettings();
        }

        function renderAll() {
            // 1. Confirm List
            const confirmList = document.getElementById('confirmList');
            const pending = allData.filter(b => b[13] === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
            confirmList.innerHTML = pending.length ? '' : '<div class="col-span-full py-10 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>';
            pending.forEach(b => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl shadow-sm border border-emerald-100 flex flex-col";
                card.innerHTML = `
                    <div class="flex-1">
                        <p class="text-[10px] text-gray-400">ID: ${b[0]}</p>
                        <p class="font-bold text-emerald-900">${b[4]}</p>
                        <p class="text-xs text-gray-600 truncate">${b[6]}</p>
                        <p class="text-xs font-bold text-red-500 mt-2">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥: ‡∏ø${b[11].toLocaleString()}</p>
                    </div>
                    <button onclick="reviewSlip('${b[0]}')" class="mt-4 w-full py-2 bg-emerald-50 text-emerald-800 rounded-lg font-bold text-sm">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</button>
                `;
                confirmList.appendChild(card);
            });

            // 2. All Table
            const sorted = [...allData].sort((a,b) => new Date(a[8]) - new Date(b[8]));
            const tableBody = document.getElementById('allBookingTable');
            tableBody.innerHTML = sorted.map(b => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 text-xs font-medium">${b[8]}</td>
                    <td class="p-3">
                        <div class="text-xs font-bold">${b[4]}</div>
                        <div class="text-[10px] text-gray-400">${b[5]}</div>
                    </td>
                    <td class="p-3 text-[10px] max-w-[100px] truncate">${b[6]}</td>
                    <td class="p-3 text-xs font-bold">‡∏ø${b[10].toLocaleString()}</td>
                    <td class="p-3"><span class="px-2 py-0.5 rounded-full text-[9px] ${b[13] === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${b[13]}</span></td>
                </tr>
            `).join('');
        }

        function reviewSlip(id) {
            const b = allData.find(x => x[0] === id);
            currentBookingId = id;
            document.getElementById('modalSlipImg').src = b[14];
            document.getElementById('modalDetails').innerHTML = `
                <p><b>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</b> ${b[4]} (Line: ${b[3]})</p>
                <p><b>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</b> ${b[5]}</p>
                <p><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å:</b> ${b[8]} ‡∏ñ‡∏∂‡∏á ${b[9]}</p>
                <p><b>‡∏´‡πâ‡∏≠‡∏á:</b> ${b[6]}</p>
                <p><b>‡∏°‡∏±‡∏î‡∏à‡∏≥:</b> <span class="text-red-600 font-bold">‡∏ø${b[11].toLocaleString()}</span> / ‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ‡∏ø${b[10].toLocaleString()}</p>
            `;
            document.getElementById('slipModal').classList.remove('hidden');
        }

        async function updateBooking(newStatus) {
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${newStatus}?`)) return;
            document.getElementById('slipModal').classList.add('hidden');
            const res = await fetch(APP_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'updateStatus', bookingId: currentBookingId, status: newStatus })
            });
            const result = await res.json();
            if(result.status === 'success') { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); refreshData(); }
        }

        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            const events = allData.filter(b => b[13] !== '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å').map(b => ({
                title: `${b[4]} - ${b[6]}`,
                start: b[8],
                end: b[9],
                backgroundColor: b[13] === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' ? '#065f46' : '#f59e0b',
                borderColor: 'transparent'
            }));
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'th',
                events: events
            });
            calendar.render();
        }

        async function loadSettings() {
            const res = await fetch(APP_URL + '?action=getSettings');
            const data = await res.json();
            
            document.getElementById('promoDisplay').innerHTML = data.promos.slice(1).map(p => `
                <div class="p-2 border rounded-lg text-xs bg-gray-50">
                    <div class="font-bold text-emerald-800">${p[0]}</div>
                    <div>‡∏•‡∏î ${p[1]}${p[2]}</div>
                </div>
            `).join('');

            document.getElementById('depositDisplay').innerHTML = data.deposits.slice(1).map(d => `
                <div class="p-2 border rounded-lg text-xs bg-gray-50">
                    <div class="font-bold">${d[0]}</div>
                    <div class="text-emerald-700">${d[1]}%</div>
                </div>
            `).join('');
        }

        function closeModal() { document.getElementById('slipModal').classList.add('hidden'); }
        window.onload = refreshData;
    </script>
</body>
</html>
