<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô - ‡∏Ç‡∏ô‡∏≥‡∏•‡∏∏‡∏á‡∏î‡∏≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; padding-bottom: 90px; }
        .tab-active { color: #059669; border-top: 3px solid #059669; background: #f0fdf4; }
        .card-confirmed { border-left: 6px solid #10b981; }
        .card-pending { border-left: 6px solid #f59e0b; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="loading" class="fixed inset-0 bg-white/80 z-[9999] flex items-center justify-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"></div>
    </div>

    <!-- Top Nav -->
    <nav class="bg-emerald-900 text-white p-4 sticky top-0 z-40 shadow-md">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-bold">Admin Dashboard</h1>
            <button onclick="fetchData()" class="p-2 bg-emerald-800 rounded-lg">üîÑ</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="p-4" id="main-content">
        <!-- Dashboard Home -->
        <div id="tab-home" class="animate-in space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-2xl shadow-sm border text-center">
                    <p class="text-xs text-gray-500">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                    <p id="stat-pending" class="text-2xl font-bold text-amber-500">0</p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border text-center">
                    <p class="text-xs text-gray-500">‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <p id="stat-today" class="text-2xl font-bold text-emerald-600">0</p>
                </div>
            </div>
            
            <h2 class="font-bold text-gray-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
            <div id="booking-list" class="space-y-3"></div>
        </div>

        <!-- Calendar Tab -->
        <div id="tab-calendar" class="animate-in hidden">
            <div id="calendar" class="bg-white p-2 rounded-2xl shadow-sm border min-h-[500px]"></div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="animate-in hidden space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border">
                <h3 class="font-bold mb-3">‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h3>
                <div class="space-y-2 mb-4">
                    <input type="text" id="promoCode" placeholder="CODE" class="w-full border p-2 rounded-lg outline-none">
                    <div class="flex gap-2">
                        <input type="number" id="promoValue" placeholder="‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤" class="flex-1 border p-2 rounded-lg outline-none">
                        <select id="promoType" class="border p-2 rounded-lg outline-none">
                            <option value="fixed">‡∏ö‡∏≤‡∏ó</option>
                            <option value="percent">%</option>
                        </select>
                    </div>
                    <button onclick="addPromo()" class="w-full bg-emerald-600 text-white py-2 rounded-lg font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î</button>
                </div>
                <div id="promo-list" class="text-sm border-t pt-3 space-y-2"></div>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm border">
                <h3 class="font-bold mb-3">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</h3>
                <div class="flex gap-2 mb-4">
                    <input type="date" id="newSpecialDate" class="flex-1 border p-2 rounded-lg outline-none">
                    <button onclick="addSpecialDate()" class="bg-emerald-600 text-white px-4 rounded-lg font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
                <div id="special-date-list" class="text-sm border-t pt-3 flex flex-wrap gap-2"></div>
            </div>
        </div>
    </main>

    <!-- Bottom Nav -->
    <div class="fixed bottom-0 inset-x-0 bg-white border-t flex justify-around p-2 z-40">
        <button onclick="switchTab('home', '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î')" class="flex flex-col items-center p-2 rounded-xl transition-all tab-active">
            <span class="text-lg">üè†</span><span class="text-[10px]">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
        </button>
        <button onclick="switchTab('calendar', '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô')" class="flex flex-col items-center p-2 rounded-xl transition-all">
            <span class="text-lg">üìÖ</span><span class="text-[10px]">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</span>
        </button>
        <button onclick="switchTab('settings', '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤')" class="flex flex-col items-center p-2 rounded-xl transition-all">
            <span class="text-lg">‚öôÔ∏è</span><span class="text-[10px]">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
        </button>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyR0jWpP0mOfq77uV548n7L3P3q7Gf228Rre2n9q3K-g7F4X9A8Hh8y1Y2Z3/exec';
        let state = { bookings: [], specialDates: [], promoCodes: [] };

        async function fetchData() {
            document.getElementById('loading').classList.remove('hidden');
            try {
                const res = await fetch(API_URL);
                state = await res.json();
                renderDashboard();
                renderSettings();
                initCalendar();
            } catch(e) { console.error(e); }
            document.getElementById('loading').classList.add('hidden');
        }

        function renderDashboard() {
            const list = document.getElementById('booking-list');
            const pending = state.bookings.filter(b => b.Status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
            document.getElementById('stat-pending').innerText = pending.length;
            
            const today = new Date().toISOString().split('T')[0];
            const activeToday = state.bookings.filter(b => b.CheckIn <= today && b.CheckOut > today && b.Status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
            document.getElementById('stat-today').innerText = activeToday.length;

            list.innerHTML = state.bookings.slice().reverse().map(b => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border ${b.Status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' ? 'card-pending' : 'card-confirmed'}">
                    <div class="flex justify-between mb-2">
                        <span class="text-[10px] font-bold text-gray-400">#${b.BookingID}</span>
                        <span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${b.Status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' ? 'bg-amber-100 text-amber-600' : 'bg-emerald-100 text-emerald-600'}">${b.Status}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex-1">
                            <h4 class="font-bold">${b.CustomerName}</h4>
                            <p class="text-xs text-gray-500">${b.RoomsInfo}</p>
                            <p class="text-xs text-gray-400 italic">${new Date(b.CheckIn).toLocaleDateString('th-TH')} - ${new Date(b.CheckOut).toLocaleDateString('th-TH')}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-emerald-700">‡∏ø${b.Total.toLocaleString()}</p>
                            ${b.SlipURL ? `<a href="${b.SlipURL}" target="_blank" class="text-[10px] text-blue-500 underline">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a>` : ''}
                        </div>
                    </div>
                    ${b.Status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' ? `
                        <div class="mt-3 flex gap-2">
                            <button onclick="updateStatus('${b.BookingID}', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß')" class="flex-1 bg-emerald-600 text-white py-2 rounded-lg text-xs font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏≠‡∏î</button>
                            <button onclick="updateStatus('${b.BookingID}', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')" class="flex-1 bg-red-50 text-red-500 py-2 rounded-lg text-xs font-bold">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        async function updateStatus(id, status) {
            if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${status} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
            document.getElementById('loading').classList.remove('hidden');
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', id, status }) });
            fetchData();
        }

        function switchTab(id, title) {
            ['home', 'calendar', 'settings'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.toggle('hidden', t !== id);
                const btn = document.querySelectorAll('button')[['home', 'calendar', 'settings'].indexOf(t) + 1];
            });
            document.querySelectorAll('button[onclick*="switchTab"]').forEach(b => b.classList.remove('tab-active'));
            event.currentTarget.classList.add('tab-active');
            if(id === 'calendar') setTimeout(() => window.calendar.render(), 100);
        }

        function initCalendar() {
            const el = document.getElementById('calendar');
            window.calendar = new FullCalendar.Calendar(el, {
                initialView: 'dayGridMonth',
                locale: 'th',
                events: state.bookings.filter(b => b.Status !== '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å').map(b => ({
                    title: b.CustomerName + ' (' + b.RoomsInfo + ')',
                    start: b.CheckIn,
                    end: b.CheckOut,
                    color: b.Status === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' ? '#059669' : '#f59e0b'
                }))
            });
        }

        function renderSettings() {
            document.getElementById('promo-list').innerHTML = state.promoCodes.map(p => `
                <div class="flex justify-between items-center py-1 border-b border-gray-50">
                    <span>${p.code}: <b>${p.value} ${p.type === 'percent' ? '%' : '‡∏ø'}</b></span>
                    <button onclick="removeSetting('promo', '${p.code}')" class="text-red-400">‡∏•‡∏ö</button>
                </div>
            `).join('');
            document.getElementById('special-date-list').innerHTML = state.specialDates.map(d => `
                <span class="bg-emerald-50 text-emerald-700 px-2 py-1 rounded-md flex items-center gap-1">
                    ${d} <button onclick="removeSetting('date', '${d}')" class="text-red-400 font-bold ml-1">√ó</button>
                </span>
            `).join('');
        }

        async function addPromo() {
            const code = document.getElementById('promoCode').value;
            const value = document.getElementById('promoValue').value;
            const type = document.getElementById('promoType').value;
            if(!code || !value) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö');
            document.getElementById('loading').classList.remove('hidden');
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'addPromo', code, value, type }) });
            fetchData();
        }

        async function addSpecialDate() {
            const date = document.getElementById('newSpecialDate').value;
            if(!date) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
            document.getElementById('loading').classList.remove('hidden');
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'addSpecialDate', date }) });
            fetchData();
        }

        async function removeSetting(type, id) {
            if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
            document.getElementById('loading').classList.remove('hidden');
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'removeSetting', type, id }) });
            fetchData();
        }

        window.onload = fetchData;
    </script>
</body>
</html>
