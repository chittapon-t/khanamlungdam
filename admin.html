<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ขนำลุงดำ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>body { font-family: 'Kanit', sans-serif; }</style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">จัดการการจองที่พัก</h1>
            <button onclick="loadBookings()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">Refresh Data</button>
        </header>

        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Booking ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ลูกค้า</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ห้องพัก</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สลิป</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>
                    </tr>
                </thead>
                <tbody id="bookingTable" class="bg-white divide-y divide-gray-200">
                    <!-- Data rows -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Image -->
    <div id="imgModal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50" onclick="this.classList.add('hidden')">
        <img id="modalImg" src="" class="max-h-screen max-w-full p-4">
    </div>

    <script>
        const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwb9VWt0rQYJ2dJa9jQKM23YRKsx-YReKnqJTiqGRbg26jEMtPP-RzxDbe_BahxUiSu5g/exec"; // ใส่ URL เดียวกับ script.js

        async function loadBookings() {
            const res = await fetch(BACKEND_URL + "?action=getAllBookings");
            const json = await res.json();
            const tbody = document.getElementById("bookingTable");
            tbody.innerHTML = "";

            json.data.slice(1).forEach(row => { // Skip header row if raw data, assuming json.data returns raw array from previous logic
                 // Map columns based on your sheet structure
                 // [0]ID, [4]Name, [7]Room, [16]In, [17]Out, [18]Slip, [19]Status
                 const tr = document.createElement("tr");
                 const statusColor = row[19] === "ยืนยันแล้ว" ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800";
                 
                 tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row[0]}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row[4]}<br>${row[5]}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row[7]}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(row[16])} - ${formatDate(row[17])}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 cursor-pointer" onclick="showImg('${row[18]}')">ดูสลิป</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${row[19]}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        ${row[19] !== "ยืนยันแล้ว" ? `<button onclick="confirmBooking('${row[0]}')" class="text-indigo-600 hover:text-indigo-900">ยืนยัน</button>` : '-'}
                    </td>
                 `;
                 tbody.appendChild(tr);
            });
        }

        async function confirmBooking(id) {
            if(!confirm("ยืนยันการจอง " + id + "?")) return;
            
            await fetch(BACKEND_URL, {
                method: "POST",
                body: JSON.stringify({ action: "confirmBooking", id: id })
            });
            alert("ยืนยันเรียบร้อย");
            loadBookings();
        }

        function showImg(url) {
            if(!url) return alert("ไม่พบไฟล์สลิป");
            document.getElementById("modalImg").src = url;
            document.getElementById("imgModal").classList.remove("hidden");
        }
        
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
        }

        window.onload = loadBookings;
    </script>
</body>
</html>
